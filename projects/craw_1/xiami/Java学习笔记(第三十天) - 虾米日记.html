<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <link rel="preload" href="/lib/font-awesome/webfonts/fa-brands-400.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" href="/lib/font-awesome/webfonts/fa-regular-400.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" href="/lib/font-awesome/webfonts/fa-solid-900.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" href="/lib/JetBrainsMono/web/woff2/JetBrainsMono-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <script type="text/javascript" src="https://latest.cactus.chat/cactus.js"></script>
  <link rel="stylesheet" href="https://latest.cactus.chat/style.css" type="text/css">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title> Java学习笔记(第三十天) | 虾米日记</title>
  <link rel = 'canonical' href = 'https://wjinlei.github.io/posts/exp-java-day30/'>
  <meta name="description" content="对酒当歌，人生几何，譬如朝露，去日苦多">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="robots" content="all,follow">
  <meta name="googlebot" content="index,follow,snippet,archive">
  <meta property="og:title" content="Java学习笔记(第三十天)" />
<meta property="og:description" content="Springboot-security  Springboot-security(鉴权模块)  &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-security&lt;/artifactId&gt; &lt;/dependency&gt;  Add WebSecurityConfig  默认情况下,springboot-security是拦截所有请求的
因此我们需要配置让它放行我们需要的请求路径
@Configuration @EnableWebSecurity public class WebSecurityConfig extends WebSecurityConfigurerAdapter { @Override protected void configure(HttpSecurity http) throws Exception { http.csrf().disable(); http.authorizeRequests().antMatchers(&#34;/&#34;, &#34;/auth/**&#34;).permitAll(); // 对根路径和所有/auth路径都放行  } } 鉴权  在@Configuration中声明两个Bean,这两个Bean是鉴权的关键,一个用于鉴定权限,一个用于加密密码  @Configuration @EnableWebSecurity public class WebSecurityConfig extends WebSecurityConfigurerAdapter { @Override protected void configure(HttpSecurity http) throws Exception { http.csrf().disable(); http.authorizeRequests().antMatchers(&#34;/&#34;, &#34;/auth/**&#34;).permitAll(); } /* 鉴权管理器 */ @Bean public AuthenticationManager customAuthenticationManager() throws Exception { return authenticationManager(); } /* 加密器 */ @Bean public BCryptPasswordEncoder bCryptPasswordEncoder() { return new BCryptPasswordEncoder(); } }  Service  @Service public class UserService implements UserDetailsService { @Autowired private UserMapper userMapper; @Autowired private BCryptPasswordEncoder bCryptPasswordEncoder; public boolean registerUser(String username, String password) { return userMapper." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://wjinlei.github.io/posts/exp-java-day30/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-11-24T19:36:28+08:00" />
<meta property="article:modified_time" content="2021-11-24T19:36:28+08:00" />


  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Java学习笔记(第三十天)"/>
<meta name="twitter:description" content="Springboot-security  Springboot-security(鉴权模块)  &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-security&lt;/artifactId&gt; &lt;/dependency&gt;  Add WebSecurityConfig  默认情况下,springboot-security是拦截所有请求的
因此我们需要配置让它放行我们需要的请求路径
@Configuration @EnableWebSecurity public class WebSecurityConfig extends WebSecurityConfigurerAdapter { @Override protected void configure(HttpSecurity http) throws Exception { http.csrf().disable(); http.authorizeRequests().antMatchers(&#34;/&#34;, &#34;/auth/**&#34;).permitAll(); // 对根路径和所有/auth路径都放行  } } 鉴权  在@Configuration中声明两个Bean,这两个Bean是鉴权的关键,一个用于鉴定权限,一个用于加密密码  @Configuration @EnableWebSecurity public class WebSecurityConfig extends WebSecurityConfigurerAdapter { @Override protected void configure(HttpSecurity http) throws Exception { http.csrf().disable(); http.authorizeRequests().antMatchers(&#34;/&#34;, &#34;/auth/**&#34;).permitAll(); } /* 鉴权管理器 */ @Bean public AuthenticationManager customAuthenticationManager() throws Exception { return authenticationManager(); } /* 加密器 */ @Bean public BCryptPasswordEncoder bCryptPasswordEncoder() { return new BCryptPasswordEncoder(); } }  Service  @Service public class UserService implements UserDetailsService { @Autowired private UserMapper userMapper; @Autowired private BCryptPasswordEncoder bCryptPasswordEncoder; public boolean registerUser(String username, String password) { return userMapper."/>

  
  
    
  
  
  <link rel="stylesheet" href="https://wjinlei.github.io/css/styles.4c2b9aa1d874d6766f554b2d404e8fd62ab4761f51ee9b3f358d12e81e7fa43a1b4378db995bc1926bbe5ed98c060be5e7bd4f2470504cf94f22b4b3a74e62b6.css" integrity="sha512-TCuaodh01nZvVUstQE6P1iq0dh9R7ps/NY0S6B5/pDobQ3jbmVvBkmu&#43;XtmMBgvl571PJHBQTPlPIrSzp05itg=="> 

  
   <link rel="stylesheet" href="https://wjinlei.github.io/css/custom.css"> 
  
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  

  
<link rel="icon" type="image/png" href="https://wjinlei.github.io/images/favicon.ico" />

  
  
</head>

<body class="max-width mx-auto px3 ltr">
  <div class="content index py4">

  <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;" aria-label="Top of Page"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
        <li><a href="/">Home</a></li>
         
        <li><a href="/posts">Writings</a></li>
         
        <li><a href="/tags">Tags</a></li>
         
        <li><a href="/about">About</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li>
          <a class="icon" href=" https://wjinlei.github.io/posts/exp-java-day29/" aria-label="Previous">
            <i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i>
          </a>
        </li>
        
        
        <li>
          <a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" aria-label="Top of Page">
            <i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i>
          </a>
        </li>
        <li>
          <a class="icon" href="#" aria-label="Share">
            <i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i>
          </a>
        </li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      
      <ul>
  
  
    
  
  
  <li>
    <a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fwjinlei.github.io%2fposts%2fexp-java-day30%2f" aria-label="Facebook">
      <i class="fab fa-facebook " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://twitter.com/share?url=https%3a%2f%2fwjinlei.github.io%2fposts%2fexp-java-day30%2f&text=Java%e5%ad%a6%e4%b9%a0%e7%ac%94%e8%ae%b0%28%e7%ac%ac%e4%b8%89%e5%8d%81%e5%a4%a9%29" aria-label="Twitter">
      <i class="fab fa-twitter " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fwjinlei.github.io%2fposts%2fexp-java-day30%2f&title=Java%e5%ad%a6%e4%b9%a0%e7%ac%94%e8%ae%b0%28%e7%ac%ac%e4%b8%89%e5%8d%81%e5%a4%a9%29" aria-label="Linkedin">
      <i class="fab fa-linkedin " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fwjinlei.github.io%2fposts%2fexp-java-day30%2f&is_video=false&description=Java%e5%ad%a6%e4%b9%a0%e7%ac%94%e8%ae%b0%28%e7%ac%ac%e4%b8%89%e5%8d%81%e5%a4%a9%29" aria-label="Pinterest">
      <i class="fab fa-pinterest " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="mailto:?subject=Java%e5%ad%a6%e4%b9%a0%e7%ac%94%e8%ae%b0%28%e7%ac%ac%e4%b8%89%e5%8d%81%e5%a4%a9%29&body=Check out this article: https%3a%2f%2fwjinlei.github.io%2fposts%2fexp-java-day30%2f" aria-label="Email">
      <i class="fas fa-envelope " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2fwjinlei.github.io%2fposts%2fexp-java-day30%2f&title=Java%e5%ad%a6%e4%b9%a0%e7%ac%94%e8%ae%b0%28%e7%ac%ac%e4%b8%89%e5%8d%81%e5%a4%a9%29" aria-label="Pocket">
      <i class="fab fa-get-pocket " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2fwjinlei.github.io%2fposts%2fexp-java-day30%2f&title=Java%e5%ad%a6%e4%b9%a0%e7%ac%94%e8%ae%b0%28%e7%ac%ac%e4%b8%89%e5%8d%81%e5%a4%a9%29" aria-label="reddit">
      <i class="fab fa-reddit " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.tumblr.com/share/link?url=https%3a%2f%2fwjinlei.github.io%2fposts%2fexp-java-day30%2f&name=Java%e5%ad%a6%e4%b9%a0%e7%ac%94%e8%ae%b0%28%e7%ac%ac%e4%b8%89%e5%8d%81%e5%a4%a9%29&description=Springboot-security%20%20Springboot-security%28%e9%89%b4%e6%9d%83%e6%a8%a1%e5%9d%97%29%20%20%26lt%3bdependency%26gt%3b%20%26lt%3bgroupId%26gt%3borg.springframework.boot%26lt%3b%2fgroupId%26gt%3b%20%26lt%3bartifactId%26gt%3bspring-boot-starter-security%26lt%3b%2fartifactId%26gt%3b%20%26lt%3b%2fdependency%26gt%3b%20%20Add%20WebSecurityConfig%20%20%e9%bb%98%e8%ae%a4%e6%83%85%e5%86%b5%e4%b8%8b%2cspringboot-security%e6%98%af%e6%8b%a6%e6%88%aa%e6%89%80%e6%9c%89%e8%af%b7%e6%b1%82%e7%9a%84%0a%e5%9b%a0%e6%ad%a4%e6%88%91%e4%bb%ac%e9%9c%80%e8%a6%81%e9%85%8d%e7%bd%ae%e8%ae%a9%e5%ae%83%e6%94%be%e8%a1%8c%e6%88%91%e4%bb%ac%e9%9c%80%e8%a6%81%e7%9a%84%e8%af%b7%e6%b1%82%e8%b7%af%e5%be%84%0a%40Configuration%20%40EnableWebSecurity%20public%20class%20WebSecurityConfig%20extends%20WebSecurityConfigurerAdapter%20%7b%20%40Override%20protected%20void%20configure%28HttpSecurity%20http%29%20throws%20Exception%20%7b%20http.csrf%28%29.disable%28%29%3b%20http.authorizeRequests%28%29.antMatchers%28%26%2334%3b%2f%26%2334%3b%2c%20%26%2334%3b%2fauth%2f%2a%2a%26%2334%3b%29.permitAll%28%29%3b%20%2f%2f%20%e5%af%b9%e6%a0%b9%e8%b7%af%e5%be%84%e5%92%8c%e6%89%80%e6%9c%89%2fauth%e8%b7%af%e5%be%84%e9%83%bd%e6%94%be%e8%a1%8c%20%20%7d%20%7d%20%e9%89%b4%e6%9d%83%20%20%e5%9c%a8%40Configuration%e4%b8%ad%e5%a3%b0%e6%98%8e%e4%b8%a4%e4%b8%aaBean%2c%e8%bf%99%e4%b8%a4%e4%b8%aaBean%e6%98%af%e9%89%b4%e6%9d%83%e7%9a%84%e5%85%b3%e9%94%ae%2c%e4%b8%80%e4%b8%aa%e7%94%a8%e4%ba%8e%e9%89%b4%e5%ae%9a%e6%9d%83%e9%99%90%2c%e4%b8%80%e4%b8%aa%e7%94%a8%e4%ba%8e%e5%8a%a0%e5%af%86%e5%af%86%e7%a0%81%20%20%40Configuration%20%40EnableWebSecurity%20public%20class%20WebSecurityConfig%20extends%20WebSecurityConfigurerAdapter%20%7b%20%40Override%20protected%20void%20configure%28HttpSecurity%20http%29%20throws%20Exception%20%7b%20http.csrf%28%29.disable%28%29%3b%20http.authorizeRequests%28%29.antMatchers%28%26%2334%3b%2f%26%2334%3b%2c%20%26%2334%3b%2fauth%2f%2a%2a%26%2334%3b%29.permitAll%28%29%3b%20%7d%20%2f%2a%20%e9%89%b4%e6%9d%83%e7%ae%a1%e7%90%86%e5%99%a8%20%2a%2f%20%40Bean%20public%20AuthenticationManager%20customAuthenticationManager%28%29%20throws%20Exception%20%7b%20return%20authenticationManager%28%29%3b%20%7d%20%2f%2a%20%e5%8a%a0%e5%af%86%e5%99%a8%20%2a%2f%20%40Bean%20public%20BCryptPasswordEncoder%20bCryptPasswordEncoder%28%29%20%7b%20return%20new%20BCryptPasswordEncoder%28%29%3b%20%7d%20%7d%20%20Service%20%20%40Service%20public%20class%20UserService%20implements%20UserDetailsService%20%7b%20%40Autowired%20private%20UserMapper%20userMapper%3b%20%40Autowired%20private%20BCryptPasswordEncoder%20bCryptPasswordEncoder%3b%20public%20boolean%20registerUser%28String%20username%2c%20String%20password%29%20%7b%20return%20userMapper." aria-label="Tumblr">
      <i class="fab fa-tumblr " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fwjinlei.github.io%2fposts%2fexp-java-day30%2f&t=Java%e5%ad%a6%e4%b9%a0%e7%ac%94%e8%ae%b0%28%e7%ac%ac%e4%b8%89%e5%8d%81%e5%a4%a9%29" aria-label="Hacker News">
      <i class="fab fa-hacker-news " aria-hidden="true"></i>
    </a>
  </li>
</ul>

    </div>
    
  </span>
</div>


  <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
    <header>
      <h1 class="posttitle" itemprop="name headline">
        Java学习笔记(第三十天)
      </h1>
      <div class="meta">
        
        <div class="postdate">
          
          <time datetime="2021-11-24 19:36:28 &#43;0800 CST" itemprop="datePublished">2021-11-24</time>
          
        </div>
        
        
        <div class="article-read-time">
          <i class="far fa-clock"></i>
          
          18 minute read
        </div>
        
        
        
      </div>
    </header>

  
    
    <div id="toc">
      <nav id="TableOfContents">
  <ul>
    <li><a href="#springboot-security">Springboot-security</a>
      <ul>
        <li><a href="#鉴权">鉴权</a></li>
        <li><a href="#状态保持">状态保持</a></li>
        <li><a href="#注销登录清除上下文对象">注销登录(清除上下文对象)</a></li>
      </ul>
    </li>
    <li><a href="#自动化测试与持续集成">自动化测试与持续集成</a>
      <ul>
        <li><a href="#自动化测试的好处">自动化测试的好处</a></li>
        <li><a href="#编写单元测试">编写单元测试</a>
          <ul>
            <li><a href="#junit-5">Junit 5</a></li>
            <li><a href="#冒烟测试">冒烟测试</a></li>
            <li><a href="#mock">Mock</a></li>
            <li><a href="#mockito">Mockito</a>
              <ul>
                <li><a href="#使用mockito编写单元测试">使用Mockito编写单元测试</a></li>
              </ul>
            </li>
            <li><a href="#为springboot的controller编写测试">为Springboot的Controller编写测试</a></li>
          </ul>
        </li>
        <li><a href="#集成测试">集成测试</a>
          <ul>
            <li><a href="#在maven中如何启用集成测试">在Maven中如何启用集成测试</a></li>
            <li><a href="#jenkins">Jenkins</a></li>
            <li><a href="#在maven中启动一个mysql">在Maven中启动一个MySQL</a></li>
            <li><a href="#编写一个集成测试">编写一个集成测试</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
    </div>
    
    <div class="content" itemprop="articleBody">
      <h2 id="springboot-security">Springboot-security</h2>
<ul>
<li>Springboot-security(鉴权模块)</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#000080">&lt;dependency&gt;</span>
    <span style="color:#000080">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#000080">&lt;/groupId&gt;</span>
    <span style="color:#000080">&lt;artifactId&gt;</span>spring-boot-starter-security<span style="color:#000080">&lt;/artifactId&gt;</span>
<span style="color:#000080">&lt;/dependency&gt;</span>
</code></pre></div><ul>
<li>Add <code>WebSecurityConfig</code></li>
</ul>
<p>默认情况下,<code>springboot-security</code>是拦截所有请求的<br>
因此我们需要配置让它放行我们需要的请求路径</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#3c5d5d;font-weight:bold">@Configuration</span>
<span style="color:#3c5d5d;font-weight:bold">@EnableWebSecurity</span>
<span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">WebSecurityConfig</span> <span style="color:#000;font-weight:bold">extends</span> WebSecurityConfigurerAdapter <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#3c5d5d;font-weight:bold">@Override</span>
    <span style="color:#000;font-weight:bold">protected</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">configure</span><span style="color:#000;font-weight:bold">(</span>HttpSecurity http<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> Exception <span style="color:#000;font-weight:bold">{</span>
        http<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">csrf</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">disable</span><span style="color:#000;font-weight:bold">();</span>
        http<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">authorizeRequests</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">antMatchers</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;/&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;/auth/**&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">permitAll</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#998;font-style:italic">// 对根路径和所有/auth路径都放行
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><h3 id="鉴权">鉴权</h3>
<ul>
<li>在<code>@Configuration</code>中声明两个<code>Bean</code>,这两个<code>Bean</code>是鉴权的关键,一个用于鉴定权限,一个用于加密密码</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#3c5d5d;font-weight:bold">@Configuration</span>
<span style="color:#3c5d5d;font-weight:bold">@EnableWebSecurity</span>
<span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">WebSecurityConfig</span> <span style="color:#000;font-weight:bold">extends</span> WebSecurityConfigurerAdapter <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#3c5d5d;font-weight:bold">@Override</span>
    <span style="color:#000;font-weight:bold">protected</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">configure</span><span style="color:#000;font-weight:bold">(</span>HttpSecurity http<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> Exception <span style="color:#000;font-weight:bold">{</span>
        http<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">csrf</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">disable</span><span style="color:#000;font-weight:bold">();</span>
        http<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">authorizeRequests</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">antMatchers</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;/&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;/auth/**&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">permitAll</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#998;font-style:italic">/* 鉴权管理器 */</span>
    <span style="color:#3c5d5d;font-weight:bold">@Bean</span>
    <span style="color:#000;font-weight:bold">public</span> AuthenticationManager <span style="color:#900;font-weight:bold">customAuthenticationManager</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">throws</span> Exception <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">return</span> authenticationManager<span style="color:#000;font-weight:bold">();</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#998;font-style:italic">/* 加密器 */</span>
    <span style="color:#3c5d5d;font-weight:bold">@Bean</span>
    <span style="color:#000;font-weight:bold">public</span> BCryptPasswordEncoder <span style="color:#900;font-weight:bold">bCryptPasswordEncoder</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">new</span> BCryptPasswordEncoder<span style="color:#000;font-weight:bold">();</span>
    <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><ul>
<li>Service</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#3c5d5d;font-weight:bold">@Service</span>
<span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">UserService</span> <span style="color:#000;font-weight:bold">implements</span> UserDetailsService <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#3c5d5d;font-weight:bold">@Autowired</span>
    <span style="color:#000;font-weight:bold">private</span> UserMapper userMapper<span style="color:#000;font-weight:bold">;</span>

    <span style="color:#3c5d5d;font-weight:bold">@Autowired</span>
    <span style="color:#000;font-weight:bold">private</span> BCryptPasswordEncoder bCryptPasswordEncoder<span style="color:#000;font-weight:bold">;</span>

    <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">boolean</span> <span style="color:#900;font-weight:bold">registerUser</span><span style="color:#000;font-weight:bold">(</span>String username<span style="color:#000;font-weight:bold">,</span> String password<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">return</span> userMapper<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">registerUser</span><span style="color:#000;font-weight:bold">(</span>username<span style="color:#000;font-weight:bold">,</span> bCryptPasswordEncoder<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">encode</span><span style="color:#000;font-weight:bold">(</span>password<span style="color:#000;font-weight:bold">));</span> <span style="color:#998;font-style:italic">// 加密存储密码
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#000;font-weight:bold">public</span> User <span style="color:#900;font-weight:bold">selectUserByUsername</span><span style="color:#000;font-weight:bold">(</span>String username<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">return</span> userMapper<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">selectUserByUsername</span><span style="color:#000;font-weight:bold">(</span>username<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#998;font-style:italic">/* 覆盖loadUserByUsername方法,查询对应用户是否存在,并返回用户的详细信息 */</span>
    <span style="color:#3c5d5d;font-weight:bold">@Override</span>
    <span style="color:#000;font-weight:bold">public</span> UserDetails <span style="color:#900;font-weight:bold">loadUserByUsername</span><span style="color:#000;font-weight:bold">(</span>String username<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> UsernameNotFoundException <span style="color:#000;font-weight:bold">{</span>
        User user <span style="color:#000;font-weight:bold">=</span> selectUserByUsername<span style="color:#000;font-weight:bold">(</span>username<span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>user <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#000;font-weight:bold">throw</span> <span style="color:#000;font-weight:bold">new</span> UsernameNotFoundException<span style="color:#000;font-weight:bold">(</span>username <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34; 不存在!&#34;</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#000;font-weight:bold">return</span> org<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">springframework</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">security</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">core</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">userdetails</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">User</span>
                <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">withUsername</span><span style="color:#000;font-weight:bold">(</span>username<span style="color:#000;font-weight:bold">)</span>
                <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">password</span><span style="color:#000;font-weight:bold">(</span>user<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getPassword</span><span style="color:#000;font-weight:bold">())</span>
                <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">authorities</span><span style="color:#000;font-weight:bold">(</span>Collections<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">emptyList</span><span style="color:#000;font-weight:bold">())</span>
                <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">build</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><ul>
<li>Controller</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#3c5d5d;font-weight:bold">@RestController</span>
<span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">UserController</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#3c5d5d;font-weight:bold">@Autowired</span>
    <span style="color:#000;font-weight:bold">private</span> UserService userService<span style="color:#000;font-weight:bold">;</span>
    <span style="color:#3c5d5d;font-weight:bold">@Autowired</span>
    <span style="color:#000;font-weight:bold">private</span> AuthenticationManager authenticationManager<span style="color:#000;font-weight:bold">;</span>

    <span style="color:#3c5d5d;font-weight:bold">@PostMapping</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;/auth/login&#34;</span><span style="color:#000;font-weight:bold">)</span>
    <span style="color:#000;font-weight:bold">public</span> Result <span style="color:#900;font-weight:bold">login</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3c5d5d;font-weight:bold">@RequestBody</span> Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span> String<span style="color:#000;font-weight:bold">&gt;</span> body<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        String username <span style="color:#000;font-weight:bold">=</span> body<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;username&#34;</span><span style="color:#000;font-weight:bold">);</span>
        String password <span style="color:#000;font-weight:bold">=</span> body<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;password&#34;</span><span style="color:#000;font-weight:bold">);</span>
        UserDetails userDetails<span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
            userDetails <span style="color:#000;font-weight:bold">=</span> userService<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">loadUserByUsername</span><span style="color:#000;font-weight:bold">(</span>username<span style="color:#000;font-weight:bold">);</span> <span style="color:#998;font-style:italic">/* 获取用户详细信息 */</span>
        <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>UsernameNotFoundException e<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#000;font-weight:bold">return</span> Result<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">fail</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;用户不存在&#34;</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span>
        UsernamePasswordAuthenticationToken token <span style="color:#000;font-weight:bold">=</span>
                <span style="color:#000;font-weight:bold">new</span> UsernamePasswordAuthenticationToken<span style="color:#000;font-weight:bold">(</span>
                        userDetails<span style="color:#000;font-weight:bold">,</span> password<span style="color:#000;font-weight:bold">,</span> userDetails<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getAuthorities</span><span style="color:#000;font-weight:bold">());</span> <span style="color:#998;font-style:italic">/* 根据用户详细信息创建token(令牌)对象,它保存了用户信息 */</span>
        <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
            authenticationManager<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">authenticate</span><span style="color:#000;font-weight:bold">(</span>token<span style="color:#000;font-weight:bold">);</span> <span style="color:#998;font-style:italic">/* 验证令牌 */</span>
            SecurityContextHolder<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getContext</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">setAuthentication</span><span style="color:#000;font-weight:bold">(</span>token<span style="color:#000;font-weight:bold">);</span> <span style="color:#998;font-style:italic">// 将信息保存到Session中
</span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>BadCredentialsException e<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#000;font-weight:bold">return</span> Result<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">fail</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;密码错误&#34;</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#000;font-weight:bold">return</span> Result<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">ok</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;登录成功&#34;</span><span style="color:#000;font-weight:bold">,</span> userService<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">selectUserByUsername</span><span style="color:#000;font-weight:bold">(</span>username<span style="color:#000;font-weight:bold">),</span> <span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>


<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><h3 id="状态保持">状态保持</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#3c5d5d;font-weight:bold">@GetMapping</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;/auth&#34;</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#000;font-weight:bold">public</span> Result <span style="color:#900;font-weight:bold">auth</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#998;font-style:italic">/* 我把这个 Authentication 就看作 Session 对象 */</span>
    Authentication session <span style="color:#000;font-weight:bold">=</span> SecurityContextHolder<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getContext</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">getAuthentication</span><span style="color:#000;font-weight:bold">();</span>
    User user <span style="color:#000;font-weight:bold">=</span> userService<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">selectUserByUsername</span><span style="color:#000;font-weight:bold">(</span>session <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span> <span style="color:#000;font-weight:bold">?</span> <span style="color:#000;font-weight:bold">null</span> <span style="color:#000;font-weight:bold">:</span> session<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getName</span><span style="color:#000;font-weight:bold">());</span>
    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>user <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">return</span> Result<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">fail</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;用户尚未登录!&#34;</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">return</span> Result<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">ok</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;用户已登录&#34;</span><span style="color:#000;font-weight:bold">,</span> user<span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><h3 id="注销登录清除上下文对象">注销登录(清除上下文对象)</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#3c5d5d;font-weight:bold">@GetMapping</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;/auth/logout&#34;</span><span style="color:#000;font-weight:bold">)</span>
    <span style="color:#998;font-style:italic">/* 如果已经执行过clearContext,那么这里会是Null */</span>
    Authentication session <span style="color:#000;font-weight:bold">=</span> SecurityContextHolder<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getContext</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">getAuthentication</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>session <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">return</span> Result<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">fail</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;用户尚未登录&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#998;font-style:italic">/* 因此这里需要避免一下空指针异常 */</span>
    SecurityContextHolder<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">clearContext</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#000;font-weight:bold">return</span> Result<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">ok</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;注销成功&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><h2 id="自动化测试与持续集成">自动化测试与持续集成</h2>
<h3 id="自动化测试的好处">自动化测试的好处</h3>
<ul>
<li>自动化</li>
<li>节省你的时间</li>
<li>避免犯错(是人都会犯错)</li>
<li>测试可以反映一个人的水平</li>
</ul>
<h3 id="编写单元测试">编写单元测试</h3>
<h4 id="junit-5">Junit 5</h4>
<ul>
<li>Junit 是一套测试框架</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#998;font-style:italic">&lt;!-- 依赖 --&gt;</span>
<span style="color:#000080">&lt;dependency&gt;</span>
    <span style="color:#000080">&lt;groupId&gt;</span>org.junit.jupiter<span style="color:#000080">&lt;/groupId&gt;</span>
    <span style="color:#000080">&lt;artifactId&gt;</span>junit-jupiter<span style="color:#000080">&lt;/artifactId&gt;</span>
    <span style="color:#000080">&lt;version&gt;</span>5.8.1<span style="color:#000080">&lt;/version&gt;</span>
    <span style="color:#000080">&lt;scope&gt;</span>test<span style="color:#000080">&lt;/scope&gt;</span>
<span style="color:#000080">&lt;/dependency&gt;</span>
    
<span style="color:#998;font-style:italic">&lt;!-- 用于单元测试 --&gt;</span>
<span style="color:#000080">&lt;plugin&gt;</span>
    <span style="color:#000080">&lt;artifactId&gt;</span>maven-surefire-plugin<span style="color:#000080">&lt;/artifactId&gt;</span>
    <span style="color:#000080">&lt;version&gt;</span>2.22.2<span style="color:#000080">&lt;/version&gt;</span>
<span style="color:#000080">&lt;/plugin&gt;</span>
<span style="color:#998;font-style:italic">&lt;!-- 用于集成测试 --&gt;</span>
<span style="color:#000080">&lt;plugin&gt;</span>
    <span style="color:#000080">&lt;artifactId&gt;</span>maven-failsafe-plugin<span style="color:#000080">&lt;/artifactId&gt;</span>
    <span style="color:#000080">&lt;version&gt;</span>2.22.2<span style="color:#000080">&lt;/version&gt;</span>
<span style="color:#000080">&lt;/plugin&gt;</span>
</code></pre></div><h4 id="冒烟测试">冒烟测试</h4>
<ul>
<li>什么是冒烟测试?</li>
</ul>
<p>程序创建好后的第一次测试,主要用于测试一下程序能否正常编译</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">SmokeTest</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#3c5d5d;font-weight:bold">@Test</span>
    <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">test</span><span style="color:#000;font-weight:bold">(){</span>
    <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><h4 id="mock">Mock</h4>
<ul>
<li>什么是Mock</li>
</ul>
<p>我们的对象都会有一些依赖,但我们编写测试的时候不方便或无法获得那些依赖,因此就需要一些<code>假的数据</code><br>
<code>Mock</code>就是假的依赖的对象,例如我们的<code>UserService</code>依赖<code>UserDao</code>,那么我们可以创建一个<code>MockDao</code>来模拟<code>UserDao</code><br>
所谓<code>Mock</code>就是创建一个假的服务,这就是<code>Mock</code>的概念</p>
<h4 id="mockito">Mockito</h4>
<ul>
<li>Mockito是一套Mock框架</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#998;font-style:italic">&lt;!-- https://mvnrepository.com/artifact/org.mockito/mockito-junit-jupiter --&gt;</span>
<span style="color:#000080">&lt;dependency&gt;</span>
    <span style="color:#000080">&lt;groupId&gt;</span>org.mockito<span style="color:#000080">&lt;/groupId&gt;</span>
    <span style="color:#000080">&lt;artifactId&gt;</span>mockito-junit-jupiter<span style="color:#000080">&lt;/artifactId&gt;</span>
    <span style="color:#000080">&lt;version&gt;</span>4.1.0<span style="color:#000080">&lt;/version&gt;</span>
    <span style="color:#000080">&lt;scope&gt;</span>test<span style="color:#000080">&lt;/scope&gt;</span>
<span style="color:#000080">&lt;/dependency&gt;</span>
</code></pre></div><h5 id="使用mockito编写单元测试">使用Mockito编写单元测试</h5>
<ul>
<li>例如我们要对这个Service构建单元测试</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#3c5d5d;font-weight:bold">@Service</span>
<span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">UserService</span> <span style="color:#000;font-weight:bold">implements</span> UserDetailsService <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#3c5d5d;font-weight:bold">@Autowired</span>
    <span style="color:#000;font-weight:bold">private</span> UserMapper userMapper<span style="color:#000;font-weight:bold">;</span>

    <span style="color:#3c5d5d;font-weight:bold">@Autowired</span>
    <span style="color:#000;font-weight:bold">private</span> BCryptPasswordEncoder bCryptPasswordEncoder<span style="color:#000;font-weight:bold">;</span>

    <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">boolean</span> <span style="color:#900;font-weight:bold">registerUser</span><span style="color:#000;font-weight:bold">(</span>String username<span style="color:#000;font-weight:bold">,</span> String password<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">return</span> userMapper<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">registerUser</span><span style="color:#000;font-weight:bold">(</span>username<span style="color:#000;font-weight:bold">,</span> bCryptPasswordEncoder<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">encode</span><span style="color:#000;font-weight:bold">(</span>password<span style="color:#000;font-weight:bold">));</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#000;font-weight:bold">public</span> User <span style="color:#900;font-weight:bold">selectUserByUsername</span><span style="color:#000;font-weight:bold">(</span>String username<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">return</span> userMapper<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">selectUserByUsername</span><span style="color:#000;font-weight:bold">(</span>username<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#998;font-style:italic">/* 覆盖loadUserByUsername方法,返回对应用户的详细信息 */</span>
    <span style="color:#3c5d5d;font-weight:bold">@Override</span>
    <span style="color:#000;font-weight:bold">public</span> UserDetails <span style="color:#900;font-weight:bold">loadUserByUsername</span><span style="color:#000;font-weight:bold">(</span>String username<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> UsernameNotFoundException <span style="color:#000;font-weight:bold">{</span>
        User user <span style="color:#000;font-weight:bold">=</span> selectUserByUsername<span style="color:#000;font-weight:bold">(</span>username<span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>user <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#000;font-weight:bold">throw</span> <span style="color:#000;font-weight:bold">new</span> UsernameNotFoundException<span style="color:#000;font-weight:bold">(</span>username <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34; 不存在!&#34;</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#000;font-weight:bold">return</span> org<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">springframework</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">security</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">core</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">userdetails</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">User</span>
                <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">withUsername</span><span style="color:#000;font-weight:bold">(</span>username<span style="color:#000;font-weight:bold">)</span>
                <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">password</span><span style="color:#000;font-weight:bold">(</span>user<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getPassword</span><span style="color:#000;font-weight:bold">())</span>
                <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">authorities</span><span style="color:#000;font-weight:bold">(</span>Collections<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">emptyList</span><span style="color:#000;font-weight:bold">())</span>
                <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">build</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><ul>
<li>Test</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#3c5d5d;font-weight:bold">@ExtendWith</span><span style="color:#000;font-weight:bold">(</span>MockitoExtension<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#998;font-style:italic">/* 为这个测试启用Mockito扩展 */</span>
<span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">UserServiceTest</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#3c5d5d;font-weight:bold">@Mock</span>
    BCryptPasswordEncoder mockBCryptPasswordEncoder<span style="color:#000;font-weight:bold">;</span> <span style="color:#998;font-style:italic">/* 假的BCryptPasswordEncoder */</span>
    <span style="color:#3c5d5d;font-weight:bold">@Mock</span>
    UserMapper mockUserMapper<span style="color:#000;font-weight:bold">;</span> <span style="color:#998;font-style:italic">/* 假的UserMapper */</span>
    <span style="color:#3c5d5d;font-weight:bold">@InjectMocks</span>
    UserService userService<span style="color:#000;font-weight:bold">;</span> <span style="color:#998;font-style:italic">/* 真实的UserService,并为他注入上面的Mock依赖 */</span>

    <span style="color:#3c5d5d;font-weight:bold">@Test</span>
    <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">testRegisterUser</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#998;font-style:italic">/* 当mockBCryptPasswordEncoder.encode(&#34;plaintext&#34;)的时候,让它返回&#34;ciphertext&#34;,模拟加密过程 */</span>
        Mockito<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">when</span><span style="color:#000;font-weight:bold">(</span>mockBCryptPasswordEncoder<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">encode</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;plaintext&#34;</span><span style="color:#000;font-weight:bold">)).</span><span style="color:#008080">thenReturn</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;ciphertext&#34;</span><span style="color:#000;font-weight:bold">);</span>
        userService<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">registerUser</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;test&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;plaintext&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#998;font-style:italic">/* 测试这个方法 */</span>
        <span style="color:#998;font-style:italic">/* 我希望调用registerUser的时候,传递给mockUserMapper的值是&#34;test&#34;和&#34;ciphertext&#34; */</span>
        Mockito<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">verify</span><span style="color:#000;font-weight:bold">(</span>mockUserMapper<span style="color:#000;font-weight:bold">).</span><span style="color:#008080">registerUser</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;test&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;ciphertext&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#998;font-style:italic">/* 验证一下mockUserMapper以什么方式被调用了 */</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#3c5d5d;font-weight:bold">@Test</span>
    <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">testSelectUserByUsername</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
        userService<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">selectUserByUsername</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;test&#34;</span><span style="color:#000;font-weight:bold">);</span>
        Mockito<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">verify</span><span style="color:#000;font-weight:bold">(</span>mockUserMapper<span style="color:#000;font-weight:bold">).</span><span style="color:#008080">selectUserByUsername</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;test&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#998;font-style:italic">/* 验证一下mockUserMapper是否收到的值是&#34;test&#34; */</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#3c5d5d;font-weight:bold">@Test</span>
    <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">testLoadUserByUsernameThrowsUsernameNotFoundException</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#998;font-style:italic">/* 当调用mockUserMapper.selectUserByUsername(&#34;test&#34;),模拟让它返回null */</span>
<span style="color:#998;font-style:italic">//        Mockito.when(mockUserMapper.selectUserByUsername(&#34;test&#34;)).thenReturn(null);
</span><span style="color:#998;font-style:italic"></span>        <span style="color:#998;font-style:italic">/* 上面的实际是多余的,因为你不对它配置的时候,它默认就是返回null */</span>

        <span style="color:#998;font-style:italic">/* 断言一下,当执行userService.loadUserByUsername(&#34;test&#34;)的时候会抛出UsernameNotFoundException异常 */</span>
        Assertions<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">assertThrows</span><span style="color:#000;font-weight:bold">(</span>UsernameNotFoundException<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">,</span>
                <span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">-&gt;</span> userService<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">loadUserByUsername</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;test&#34;</span><span style="color:#000;font-weight:bold">));</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#3c5d5d;font-weight:bold">@Test</span>
    <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">testLoadUserByUsernameReturnUserDetail</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#998;font-style:italic">/* 当调用mockUserMapper.selectUserByUsername(&#34;test&#34;)模拟让它返回一个User对象 */</span>
        Mockito<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">when</span><span style="color:#000;font-weight:bold">(</span>mockUserMapper<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">selectUserByUsername</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;test&#34;</span><span style="color:#000;font-weight:bold">))</span>
                <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">thenReturn</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">new</span> User<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;test&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;ciphertext&#34;</span><span style="color:#000;font-weight:bold">));</span>
        UserDetails userDetails <span style="color:#000;font-weight:bold">=</span> userService<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">loadUserByUsername</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;test&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#998;font-style:italic">/* 调用实际的逻辑 */</span>
        <span style="color:#998;font-style:italic">/* 验证返回的结果是否符合预期 */</span>
        Assertions<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">assertEquals</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;test&#34;</span><span style="color:#000;font-weight:bold">,</span> userDetails<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getUsername</span><span style="color:#000;font-weight:bold">());</span>
        Assertions<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">assertEquals</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;ciphertext&#34;</span><span style="color:#000;font-weight:bold">,</span> userDetails<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getPassword</span><span style="color:#000;font-weight:bold">());</span>
    <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><h4 id="为springboot的controller编写测试">为Springboot的Controller编写测试</h4>
<ul>
<li>为Springboot的Controller编写测试需要引入Springboot的依赖</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#000080">&lt;dependency&gt;</span>
    <span style="color:#000080">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#000080">&lt;/groupId&gt;</span>
    <span style="color:#000080">&lt;artifactId&gt;</span>spring-boot-starter-test<span style="color:#000080">&lt;/artifactId&gt;</span>
    <span style="color:#000080">&lt;scope&gt;</span>test<span style="color:#000080">&lt;/scope&gt;</span>
<span style="color:#000080">&lt;/dependency&gt;</span>
</code></pre></div><ul>
<li>Test</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#3c5d5d;font-weight:bold">@ExtendWith</span><span style="color:#000;font-weight:bold">(</span>MockitoExtension<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#3c5d5d;font-weight:bold">@ExtendWith</span><span style="color:#000;font-weight:bold">(</span>SpringExtension<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">UserControllerTest</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">private</span> MockMvc mockMvc<span style="color:#000;font-weight:bold">;</span> <span style="color:#998;font-style:italic">/* 测试Controller必须的,模拟各种请求 */</span>

    <span style="color:#3c5d5d;font-weight:bold">@Mock</span>
    <span style="color:#000;font-weight:bold">private</span> UserService userService<span style="color:#000;font-weight:bold">;</span>
    <span style="color:#3c5d5d;font-weight:bold">@Mock</span>
    <span style="color:#000;font-weight:bold">private</span> AuthenticationManager authenticationManager<span style="color:#000;font-weight:bold">;</span>

    <span style="color:#000;font-weight:bold">private</span> BCryptPasswordEncoder bCryptPasswordEncoder <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> BCryptPasswordEncoder<span style="color:#000;font-weight:bold">();</span>

    <span style="color:#998;font-style:italic">/* 每次调用测试方法之前,都会执行 */</span>
    <span style="color:#3c5d5d;font-weight:bold">@BeforeEach</span>
    <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">setUp</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
        mockMvc <span style="color:#000;font-weight:bold">=</span> MockMvcBuilders<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">standaloneSetup</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">new</span> UserController<span style="color:#000;font-weight:bold">(</span>userService<span style="color:#000;font-weight:bold">,</span> authenticationManager<span style="color:#000;font-weight:bold">)).</span><span style="color:#008080">build</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#3c5d5d;font-weight:bold">@Test</span>
    <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">testAuthByDefault</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">throws</span> Exception <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#998;font-style:italic">/* 执行一个Get请求,请求auth接口,并预期的返回的状态码是 200,并且响应中包含&#34;用户尚未登录&#34; */</span>
        mockMvc<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">perform</span><span style="color:#000;font-weight:bold">(</span>MockMvcRequestBuilders<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;/auth&#34;</span><span style="color:#000;font-weight:bold">))</span>
                <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">andExpect</span><span style="color:#000;font-weight:bold">(</span>MockMvcResultMatchers<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">status</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">isOk</span><span style="color:#000;font-weight:bold">())</span>
                <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">andExpect</span><span style="color:#000;font-weight:bold">(</span>result <span style="color:#000;font-weight:bold">-&gt;</span> Assertions<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">assertTrue</span><span style="color:#000;font-weight:bold">(</span>result<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getResponse</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">getContentAsString</span><span style="color:#000;font-weight:bold">(</span>StandardCharsets<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">UTF_8</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">contains</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;用户尚未登录&#34;</span><span style="color:#000;font-weight:bold">)));</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#3c5d5d;font-weight:bold">@Test</span>
    <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">testLogin</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">throws</span> Exception <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#998;font-style:italic">/* 发送一个Get请求,请求auth接口,并预期的返回的状态码是 200,并且响应中包含&#34;用户尚未登录&#34; */</span>
        mockMvc<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">perform</span><span style="color:#000;font-weight:bold">(</span>MockMvcRequestBuilders<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;/auth&#34;</span><span style="color:#000;font-weight:bold">))</span>
                <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">andExpect</span><span style="color:#000;font-weight:bold">(</span>MockMvcResultMatchers<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">status</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">isOk</span><span style="color:#000;font-weight:bold">())</span>
                <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">andExpect</span><span style="color:#000;font-weight:bold">(</span>result <span style="color:#000;font-weight:bold">-&gt;</span> Assertions<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">assertTrue</span><span style="color:#000;font-weight:bold">(</span>result<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getResponse</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">getContentAsString</span><span style="color:#000;font-weight:bold">(</span>StandardCharsets<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">UTF_8</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">contains</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;用户尚未登录&#34;</span><span style="color:#000;font-weight:bold">)));</span>

        <span style="color:#998;font-style:italic">/* Mock一些依赖 */</span>
        Mockito<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">when</span><span style="color:#000;font-weight:bold">(</span>userService<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">loadUserByUsername</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;admin123&#34;</span><span style="color:#000;font-weight:bold">))</span>
                <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">thenReturn</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">new</span> User<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;admin123&#34;</span><span style="color:#000;font-weight:bold">,</span> bCryptPasswordEncoder<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">encode</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;admin123&#34;</span><span style="color:#000;font-weight:bold">),</span> Collections<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">emptyList</span><span style="color:#000;font-weight:bold">()));</span>
        Mockito<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">when</span><span style="color:#000;font-weight:bold">(</span>userService<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">selectUserByUsername</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;admin123&#34;</span><span style="color:#000;font-weight:bold">))</span>
                <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">thenReturn</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">new</span> com<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">github</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">wjinlei</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">springbootblog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">entity</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">User</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;admin123&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;admin123&#34;</span><span style="color:#000;font-weight:bold">));</span>

        <span style="color:#998;font-style:italic">/* 准备post参数 */</span>
        Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span> String<span style="color:#000;font-weight:bold">&gt;</span> params <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> HashMap<span style="color:#000;font-weight:bold">&lt;&gt;();</span>
        params<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;username&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;admin123&#34;</span><span style="color:#000;font-weight:bold">);</span>
        params<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;password&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;admin123&#34;</span><span style="color:#000;font-weight:bold">);</span>
        String jsonValue <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> ObjectMapper<span style="color:#000;font-weight:bold">().</span><span style="color:#008080">writeValueAsString</span><span style="color:#000;font-weight:bold">(</span>params<span style="color:#000;font-weight:bold">);</span> <span style="color:#998;font-style:italic">/* 将Map序列化成json字符串 */</span>
        <span style="color:#998;font-style:italic">/* 发送一个Get请求,请求/auth/login接口,并预期返回的状态码是 200,并且拿到它的返回值 */</span>
        MvcResult mvcResult <span style="color:#000;font-weight:bold">=</span> mockMvc<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">perform</span><span style="color:#000;font-weight:bold">(</span>MockMvcRequestBuilders<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">post</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;/auth/login&#34;</span><span style="color:#000;font-weight:bold">)</span>
                        <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">contentType</span><span style="color:#000;font-weight:bold">(</span>MediaType<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">APPLICATION_JSON</span><span style="color:#000;font-weight:bold">)</span>
                        <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">content</span><span style="color:#000;font-weight:bold">(</span>jsonValue<span style="color:#000;font-weight:bold">))</span>
                <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">andExpect</span><span style="color:#000;font-weight:bold">(</span>MockMvcResultMatchers<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">status</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">isOk</span><span style="color:#000;font-weight:bold">())</span>
                <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">andExpect</span><span style="color:#000;font-weight:bold">(</span>result <span style="color:#000;font-weight:bold">-&gt;</span> Assertions<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">assertTrue</span><span style="color:#000;font-weight:bold">(</span>result<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getResponse</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">getContentAsString</span><span style="color:#000;font-weight:bold">(</span>StandardCharsets<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">UTF_8</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">contains</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;登录成功&#34;</span><span style="color:#000;font-weight:bold">)))</span>
                <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">andReturn</span><span style="color:#000;font-weight:bold">();</span>


        HttpSession session <span style="color:#000;font-weight:bold">=</span> mvcResult<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getRequest</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">getSession</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#998;font-style:italic">/* 从请求中获取session */</span>

        <span style="color:#998;font-style:italic">/* 再次发起GET /auth 请求,并断言结果中包含&#34;用户已登录&#34; */</span>
        mockMvc<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">perform</span><span style="color:#000;font-weight:bold">(</span>MockMvcRequestBuilders<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;/auth&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">session</span><span style="color:#000;font-weight:bold">((</span>MockHttpSession<span style="color:#000;font-weight:bold">)</span> session<span style="color:#000;font-weight:bold">))</span>
                <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">andExpect</span><span style="color:#000;font-weight:bold">(</span>MockMvcResultMatchers<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">status</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">isOk</span><span style="color:#000;font-weight:bold">())</span>
                <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">andExpect</span><span style="color:#000;font-weight:bold">(</span>result <span style="color:#000;font-weight:bold">-&gt;</span> Assertions<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">assertTrue</span><span style="color:#000;font-weight:bold">(</span>result<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getResponse</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">getContentAsString</span><span style="color:#000;font-weight:bold">(</span>StandardCharsets<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">UTF_8</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">contains</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;用户已登录&#34;</span><span style="color:#000;font-weight:bold">)));</span>
    <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><h3 id="集成测试">集成测试</h3>
<p>所谓集成测试,就是把整个项目打包,对整个项目暴露出来的外部接口进行测试,而不是对某个类,某个方法,每个单元进行测试</p>
<h4 id="在maven中如何启用集成测试">在Maven中如何启用集成测试</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#998;font-style:italic">&lt;!-- 用于单元测试 --&gt;</span>
<span style="color:#000080">&lt;plugin&gt;</span>
    <span style="color:#000080">&lt;artifactId&gt;</span>maven-surefire-plugin<span style="color:#000080">&lt;/artifactId&gt;</span>
    <span style="color:#000080">&lt;version&gt;</span>2.22.2<span style="color:#000080">&lt;/version&gt;</span>
    <span style="color:#000080">&lt;configuration&gt;</span>
    <span style="color:#998;font-style:italic">&lt;!-- 从单元测试中排除 IntegrationTest名称的测试 --&gt;</span>
        <span style="color:#000080">&lt;excludes&gt;</span>
            <span style="color:#000080">&lt;exclude&gt;</span>**/*IntegrationTest<span style="color:#000080">&lt;/exclude&gt;</span>
        <span style="color:#000080">&lt;/excludes&gt;</span>
    <span style="color:#000080">&lt;/configuration&gt;</span>
<span style="color:#000080">&lt;/plugin&gt;</span>
<span style="color:#998;font-style:italic">&lt;!-- 用于集成测试 --&gt;</span>
<span style="color:#000080">&lt;plugin&gt;</span>
    <span style="color:#000080">&lt;artifactId&gt;</span>maven-failsafe-plugin<span style="color:#000080">&lt;/artifactId&gt;</span>
    <span style="color:#000080">&lt;version&gt;</span>2.22.2<span style="color:#000080">&lt;/version&gt;</span>
    <span style="color:#000080">&lt;configuration&gt;</span>
    <span style="color:#998;font-style:italic">&lt;!-- 从集成测试中包含 IntegrationTest名称的测试 --&gt;</span>
        <span style="color:#000080">&lt;includes&gt;</span>
            <span style="color:#000080">&lt;include&gt;</span>**/*IntegrationTest<span style="color:#000080">&lt;/include&gt;</span>
        <span style="color:#000080">&lt;/includes&gt;</span>
    <span style="color:#000080">&lt;/configuration&gt;</span>
<span style="color:#000080">&lt;/plugin&gt;</span>
</code></pre></div><h4 id="jenkins">Jenkins</h4>
<ul>
<li>安装Jenkins</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">sudo docker run --name jenkins -p 8081:8080 -p 50000:50000 -v <span style="color:#d14">`</span><span style="color:#0086b3">pwd</span><span style="color:#d14">`</span>/jenkins_data:/var/jenkins_home jenkins/jenkins
</code></pre></div><ul>
<li>Jenkins 创建一个工程构建项目
<img src="/image/exp-java-day30/jenkins-create-project.gif" alt="创建工程"></li>
</ul>
<h4 id="在maven中启动一个mysql">在Maven中启动一个MySQL</h4>
<p>集成测试需要启动一个真正的环境,然后在进行整体测试<br>
例如,如果项目依赖<code>MySQL</code>,也就意味着,你在进行集成测试之前,应该先启动一个<code>MySQL</code><br>
要在Maven中启动MySQL,我们需要一个插件<code>exec-maven-plugin</code>,它可以帮助我们执行一个外部命令</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#000080">&lt;plugins&gt;</span>
    <span style="color:#998;font-style:italic">&lt;!-- 用于单元测试 --&gt;</span>
    <span style="color:#000080">&lt;plugin&gt;</span>
        <span style="color:#000080">&lt;artifactId&gt;</span>maven-surefire-plugin<span style="color:#000080">&lt;/artifactId&gt;</span>
        <span style="color:#000080">&lt;version&gt;</span>2.22.2<span style="color:#000080">&lt;/version&gt;</span>
        <span style="color:#000080">&lt;configuration&gt;</span>
            <span style="color:#998;font-style:italic">&lt;!-- 从单元测试中排除 IntegrationTest名称的测试 --&gt;</span>
            <span style="color:#000080">&lt;excludes&gt;</span>
                <span style="color:#000080">&lt;exclude&gt;</span>**/*IntegrationTest<span style="color:#000080">&lt;/exclude&gt;</span>
            <span style="color:#000080">&lt;/excludes&gt;</span>
        <span style="color:#000080">&lt;/configuration&gt;</span>
    <span style="color:#000080">&lt;/plugin&gt;</span>
    <span style="color:#998;font-style:italic">&lt;!-- 用于集成测试 --&gt;</span>
    <span style="color:#000080">&lt;plugin&gt;</span>
        <span style="color:#000080">&lt;artifactId&gt;</span>maven-failsafe-plugin<span style="color:#000080">&lt;/artifactId&gt;</span>
        <span style="color:#000080">&lt;version&gt;</span>2.22.2<span style="color:#000080">&lt;/version&gt;</span>
        <span style="color:#000080">&lt;configuration&gt;</span>
            <span style="color:#000080">&lt;includes&gt;</span>
                <span style="color:#000080">&lt;include&gt;</span>**/*IntegrationTest<span style="color:#000080">&lt;/include&gt;</span>
            <span style="color:#000080">&lt;/includes&gt;</span>
        <span style="color:#000080">&lt;/configuration&gt;</span>
    <span style="color:#000080">&lt;/plugin&gt;</span>
    <span style="color:#998;font-style:italic">&lt;!-- 用于执行一个外部命令 --&gt;</span>
    <span style="color:#000080">&lt;plugin&gt;</span>
        <span style="color:#000080">&lt;groupId&gt;</span>org.codehaus.mojo<span style="color:#000080">&lt;/groupId&gt;</span>
        <span style="color:#000080">&lt;artifactId&gt;</span>exec-maven-plugin<span style="color:#000080">&lt;/artifactId&gt;</span>
        <span style="color:#000080">&lt;version&gt;</span>3.0.0<span style="color:#000080">&lt;/version&gt;</span>
        <span style="color:#000080">&lt;executions&gt;</span>
            <span style="color:#000080">&lt;execution&gt;</span>
                <span style="color:#998;font-style:italic">&lt;!-- 可以有多个execution, 每一个execution,需要一个id,用以区分 --&gt;</span>
                <span style="color:#000080">&lt;id&gt;</span>start-test-database<span style="color:#000080">&lt;/id&gt;</span>
                <span style="color:#998;font-style:italic">&lt;!-- 绑定到哪个阶段上,Maven在运行到这个阶段的时候,会自动帮我们运行整个goal --&gt;</span>
                <span style="color:#000080">&lt;phase&gt;</span>pre-integration-test<span style="color:#000080">&lt;/phase&gt;</span>
                <span style="color:#000080">&lt;goals&gt;</span>
                    <span style="color:#000080">&lt;goal&gt;</span>exec<span style="color:#000080">&lt;/goal&gt;</span>
                <span style="color:#000080">&lt;/goals&gt;</span>
                <span style="color:#000080">&lt;configuration&gt;</span>
                    <span style="color:#998;font-style:italic">&lt;!-- 执行docker命令启动一个测试用MySQL--&gt;</span>
                    <span style="color:#000080">&lt;executable&gt;</span>sudo<span style="color:#000080">&lt;/executable&gt;</span>
                    <span style="color:#000080">&lt;arguments&gt;</span>
                        <span style="color:#000080">&lt;argument&gt;</span>docker<span style="color:#000080">&lt;/argument&gt;</span>
                        <span style="color:#000080">&lt;argument&gt;</span>run<span style="color:#000080">&lt;/argument&gt;</span>
                        <span style="color:#000080">&lt;argument&gt;</span>--name<span style="color:#000080">&lt;/argument&gt;</span>
                        <span style="color:#000080">&lt;argument&gt;</span>test-mysql<span style="color:#000080">&lt;/argument&gt;</span>
                        <span style="color:#000080">&lt;argument&gt;</span>-p<span style="color:#000080">&lt;/argument&gt;</span>
                        <span style="color:#000080">&lt;argument&gt;</span>3307:3306<span style="color:#000080">&lt;/argument&gt;</span>
                        <span style="color:#000080">&lt;argument&gt;</span>-e<span style="color:#000080">&lt;/argument&gt;</span>
                        <span style="color:#000080">&lt;argument&gt;</span>MYSQL_ROOT_PASSWORD=root<span style="color:#000080">&lt;/argument&gt;</span>
                        <span style="color:#000080">&lt;argument&gt;</span>-e<span style="color:#000080">&lt;/argument&gt;</span>
                        <span style="color:#000080">&lt;argument&gt;</span>MYSQL_DATABASE=blog<span style="color:#000080">&lt;/argument&gt;</span>
                        <span style="color:#000080">&lt;argument&gt;</span>-d<span style="color:#000080">&lt;/argument&gt;</span>
                        <span style="color:#000080">&lt;argument&gt;</span>mysql:8.0.27<span style="color:#000080">&lt;/argument&gt;</span>
                    <span style="color:#000080">&lt;/arguments&gt;</span>
                <span style="color:#000080">&lt;/configuration&gt;</span>
            <span style="color:#000080">&lt;/execution&gt;</span>
            <span style="color:#998;font-style:italic">&lt;!-- 测试数据库启动之后,先等待20秒左右,等待数据库初始化 --&gt;</span>
            <span style="color:#000080">&lt;execution&gt;</span>
                <span style="color:#000080">&lt;id&gt;</span>wait-test-database<span style="color:#000080">&lt;/id&gt;</span>
                <span style="color:#000080">&lt;phase&gt;</span>pre-integration-test<span style="color:#000080">&lt;/phase&gt;</span>
                <span style="color:#000080">&lt;goals&gt;</span>
                    <span style="color:#000080">&lt;goal&gt;</span>exec<span style="color:#000080">&lt;/goal&gt;</span>
                <span style="color:#000080">&lt;/goals&gt;</span>
                <span style="color:#000080">&lt;configuration&gt;</span>
                    <span style="color:#000080">&lt;executable&gt;</span>ping<span style="color:#000080">&lt;/executable&gt;</span>
                    <span style="color:#000080">&lt;arguments&gt;</span>
                        <span style="color:#000080">&lt;argument&gt;</span>-c<span style="color:#000080">&lt;/argument&gt;</span>
                        <span style="color:#000080">&lt;argument&gt;</span>20<span style="color:#000080">&lt;/argument&gt;</span>
                        <span style="color:#000080">&lt;argument&gt;</span>baidu.com<span style="color:#000080">&lt;/argument&gt;</span>
                    <span style="color:#000080">&lt;/arguments&gt;</span>
                <span style="color:#000080">&lt;/configuration&gt;</span>
            <span style="color:#000080">&lt;/execution&gt;</span>
            <span style="color:#998;font-style:italic">&lt;!-- 集成测试之后销毁测试数据库 --&gt;</span>
            <span style="color:#000080">&lt;execution&gt;</span>
                <span style="color:#000080">&lt;id&gt;</span>rm-test-database<span style="color:#000080">&lt;/id&gt;</span>
                <span style="color:#000080">&lt;phase&gt;</span>post-integration-test<span style="color:#000080">&lt;/phase&gt;</span>
                <span style="color:#000080">&lt;goals&gt;</span>
                    <span style="color:#000080">&lt;goal&gt;</span>exec<span style="color:#000080">&lt;/goal&gt;</span>
                <span style="color:#000080">&lt;/goals&gt;</span>
                <span style="color:#000080">&lt;configuration&gt;</span>
                    <span style="color:#000080">&lt;executable&gt;</span>sudo<span style="color:#000080">&lt;/executable&gt;</span>
                    <span style="color:#000080">&lt;arguments&gt;</span>
                        <span style="color:#000080">&lt;argument&gt;</span>docker<span style="color:#000080">&lt;/argument&gt;</span>
                        <span style="color:#000080">&lt;argument&gt;</span>rm<span style="color:#000080">&lt;/argument&gt;</span>
                        <span style="color:#000080">&lt;argument&gt;</span>-f<span style="color:#000080">&lt;/argument&gt;</span>
                        <span style="color:#000080">&lt;argument&gt;</span>test-mysql<span style="color:#000080">&lt;/argument&gt;</span>
                    <span style="color:#000080">&lt;/arguments&gt;</span>
                <span style="color:#000080">&lt;/configuration&gt;</span>
            <span style="color:#000080">&lt;/execution&gt;</span>
        <span style="color:#000080">&lt;/executions&gt;</span>
    <span style="color:#000080">&lt;/plugin&gt;</span>
    <span style="color:#998;font-style:italic">&lt;!-- flyway插件也绑定到pre-integration-test阶段,并且要在exec插件之后,因为要等数据启动起来后再migrate--&gt;</span>
    <span style="color:#000080">&lt;plugin&gt;</span>
        <span style="color:#000080">&lt;groupId&gt;</span>org.flywaydb<span style="color:#000080">&lt;/groupId&gt;</span>
        <span style="color:#000080">&lt;artifactId&gt;</span>flyway-maven-plugin<span style="color:#000080">&lt;/artifactId&gt;</span>
        <span style="color:#000080">&lt;version&gt;</span>8.0.4<span style="color:#000080">&lt;/version&gt;</span>
        <span style="color:#000080">&lt;configuration&gt;</span>
            <span style="color:#000080">&lt;url&gt;</span>jdbc:mysql://localhost:3306/blog?characterEncoding=utf-8<span style="color:#000080">&lt;/url&gt;</span>
            <span style="color:#000080">&lt;user&gt;</span>root<span style="color:#000080">&lt;/user&gt;</span>
            <span style="color:#000080">&lt;password&gt;</span>root<span style="color:#000080">&lt;/password&gt;</span>
        <span style="color:#000080">&lt;/configuration&gt;</span>
        <span style="color:#000080">&lt;executions&gt;</span>
            <span style="color:#000080">&lt;execution&gt;</span>
                <span style="color:#000080">&lt;id&gt;</span>initialize<span style="color:#000080">&lt;/id&gt;</span>
                <span style="color:#000080">&lt;phase&gt;</span>pre-integration-test<span style="color:#000080">&lt;/phase&gt;</span>
                <span style="color:#000080">&lt;goals&gt;</span>
                    <span style="color:#000080">&lt;goal&gt;</span>migrate<span style="color:#000080">&lt;/goal&gt;</span>
                <span style="color:#000080">&lt;/goals&gt;</span>
                <span style="color:#998;font-style:italic">&lt;!-- 这个execution额外的配置,因为是对测试数据库执行,而不是真实的数据库,因此端口指向测试数据库的端口3307 --&gt;</span>
                <span style="color:#000080">&lt;configuration&gt;</span>
                    <span style="color:#000080">&lt;url&gt;</span>jdbc:mysql://localhost:3307/blog?characterEncoding=utf-8<span style="color:#000080">&lt;/url&gt;</span>
                    <span style="color:#000080">&lt;user&gt;</span>root<span style="color:#000080">&lt;/user&gt;</span>
                    <span style="color:#000080">&lt;password&gt;</span>root<span style="color:#000080">&lt;/password&gt;</span>
                <span style="color:#000080">&lt;/configuration&gt;</span>
            <span style="color:#000080">&lt;/execution&gt;</span>
        <span style="color:#000080">&lt;/executions&gt;</span>
    <span style="color:#000080">&lt;/plugin&gt;</span>
<span style="color:#000080">&lt;/plugins&gt;</span>
</code></pre></div><h4 id="编写一个集成测试">编写一个集成测试</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#3c5d5d;font-weight:bold">@ExtendWith</span><span style="color:#000;font-weight:bold">(</span>SpringExtension<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#998;font-style:italic">/* 指定要测试SpringbootBlogApplication, 并指定一个随机端口,因为你不能占用正常的端口 */</span>
<span style="color:#3c5d5d;font-weight:bold">@SpringBootTest</span><span style="color:#000;font-weight:bold">(</span>classes <span style="color:#000;font-weight:bold">=</span> SpringbootBlogApplication<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">,</span> webEnvironment <span style="color:#000;font-weight:bold">=</span> SpringBootTest<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">WebEnvironment</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">RANDOM_PORT</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#998;font-style:italic">/* 指定一个测试的配置文件,因为真实的项目配置文件连接的数据库是3306,而我们测试数据库是3307 */</span>
<span style="color:#998;font-style:italic">/* 我们可以在test包中新建一个resources/test.properties配置文件并修改端口为3307 */</span>
<span style="color:#3c5d5d;font-weight:bold">@TestPropertySource</span><span style="color:#000;font-weight:bold">(</span>locations <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;classpath:test.properties&#34;</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">AppIntegrationTest</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#3c5d5d;font-weight:bold">@Inject</span>
    Environment environment<span style="color:#000;font-weight:bold">;</span>

    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * 测试首页能够访问
</span><span style="color:#998;font-style:italic">     */</span>
    <span style="color:#3c5d5d;font-weight:bold">@Test</span>
    <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">testAuthByDefault</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">throws</span> IOException<span style="color:#000;font-weight:bold">,</span> InterruptedException <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#998;font-style:italic">/* 获得随机启动的端口号 */</span>
        String port <span style="color:#000;font-weight:bold">=</span> environment<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getProperty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;local.server.port&#34;</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#998;font-style:italic">/* 使用Java 11 自带的httpclient库发送请求 */</span>
        HttpClient client <span style="color:#000;font-weight:bold">=</span> HttpClient<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">newHttpClient</span><span style="color:#000;font-weight:bold">();</span>
        HttpRequest request <span style="color:#000;font-weight:bold">=</span> HttpRequest<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">newBuilder</span><span style="color:#000;font-weight:bold">()</span>
                <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">uri</span><span style="color:#000;font-weight:bold">(</span>URI<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">create</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;http://localhost:&#34;</span> <span style="color:#000;font-weight:bold">+</span> port <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;/auth&#34;</span><span style="color:#000;font-weight:bold">))</span>
                <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">build</span><span style="color:#000;font-weight:bold">();</span>
        HttpResponse<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">&gt;</span> response <span style="color:#000;font-weight:bold">=</span> client<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">send</span><span style="color:#000;font-weight:bold">(</span>request<span style="color:#000;font-weight:bold">,</span> HttpResponse<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">BodyHandlers</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">ofString</span><span style="color:#000;font-weight:bold">());</span>
        Assertions<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">assertEquals</span><span style="color:#000;font-weight:bold">(</span>200<span style="color:#000;font-weight:bold">,</span> response<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">statusCode</span><span style="color:#000;font-weight:bold">());</span>
        Assertions<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">assertTrue</span><span style="color:#000;font-weight:bold">(</span>response<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">body</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">contains</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;用户尚未登录&#34;</span><span style="color:#000;font-weight:bold">));</span>
    <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div>
    </div>
  </article>

  
  




  <div class="blog-post-comments">
    
      <div id="disquss_thread">
  <script src="https://utteranc.es/client.js"
    repo="Wjinlei/wjinlei.github.io"
    issue-term="pathname"
    label="Wjinlei"
    theme="github-light"
    crossorigin="anonymous"
    async>
  </script>
</div>

    
  </div>



  <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/posts">Writings</a></li>
         
          <li><a href="/tags">Tags</a></li>
         
          <li><a href="/about">About</a></li>
        
      </ul>
    </div>

    

    <div id="share-footer" style="display: none">
      
      <ul>
  
  
    
  
  
  <li>
    <a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fwjinlei.github.io%2fposts%2fexp-java-day30%2f" aria-label="Facebook">
      <i class="fab fa-facebook fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://twitter.com/share?url=https%3a%2f%2fwjinlei.github.io%2fposts%2fexp-java-day30%2f&text=Java%e5%ad%a6%e4%b9%a0%e7%ac%94%e8%ae%b0%28%e7%ac%ac%e4%b8%89%e5%8d%81%e5%a4%a9%29" aria-label="Twitter">
      <i class="fab fa-twitter fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fwjinlei.github.io%2fposts%2fexp-java-day30%2f&title=Java%e5%ad%a6%e4%b9%a0%e7%ac%94%e8%ae%b0%28%e7%ac%ac%e4%b8%89%e5%8d%81%e5%a4%a9%29" aria-label="Linkedin">
      <i class="fab fa-linkedin fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fwjinlei.github.io%2fposts%2fexp-java-day30%2f&is_video=false&description=Java%e5%ad%a6%e4%b9%a0%e7%ac%94%e8%ae%b0%28%e7%ac%ac%e4%b8%89%e5%8d%81%e5%a4%a9%29" aria-label="Pinterest">
      <i class="fab fa-pinterest fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="mailto:?subject=Java%e5%ad%a6%e4%b9%a0%e7%ac%94%e8%ae%b0%28%e7%ac%ac%e4%b8%89%e5%8d%81%e5%a4%a9%29&body=Check out this article: https%3a%2f%2fwjinlei.github.io%2fposts%2fexp-java-day30%2f" aria-label="Email">
      <i class="fas fa-envelope fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2fwjinlei.github.io%2fposts%2fexp-java-day30%2f&title=Java%e5%ad%a6%e4%b9%a0%e7%ac%94%e8%ae%b0%28%e7%ac%ac%e4%b8%89%e5%8d%81%e5%a4%a9%29" aria-label="Pocket">
      <i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2fwjinlei.github.io%2fposts%2fexp-java-day30%2f&title=Java%e5%ad%a6%e4%b9%a0%e7%ac%94%e8%ae%b0%28%e7%ac%ac%e4%b8%89%e5%8d%81%e5%a4%a9%29" aria-label="reddit">
      <i class="fab fa-reddit fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.tumblr.com/share/link?url=https%3a%2f%2fwjinlei.github.io%2fposts%2fexp-java-day30%2f&name=Java%e5%ad%a6%e4%b9%a0%e7%ac%94%e8%ae%b0%28%e7%ac%ac%e4%b8%89%e5%8d%81%e5%a4%a9%29&description=Springboot-security%20%20Springboot-security%28%e9%89%b4%e6%9d%83%e6%a8%a1%e5%9d%97%29%20%20%26lt%3bdependency%26gt%3b%20%26lt%3bgroupId%26gt%3borg.springframework.boot%26lt%3b%2fgroupId%26gt%3b%20%26lt%3bartifactId%26gt%3bspring-boot-starter-security%26lt%3b%2fartifactId%26gt%3b%20%26lt%3b%2fdependency%26gt%3b%20%20Add%20WebSecurityConfig%20%20%e9%bb%98%e8%ae%a4%e6%83%85%e5%86%b5%e4%b8%8b%2cspringboot-security%e6%98%af%e6%8b%a6%e6%88%aa%e6%89%80%e6%9c%89%e8%af%b7%e6%b1%82%e7%9a%84%0a%e5%9b%a0%e6%ad%a4%e6%88%91%e4%bb%ac%e9%9c%80%e8%a6%81%e9%85%8d%e7%bd%ae%e8%ae%a9%e5%ae%83%e6%94%be%e8%a1%8c%e6%88%91%e4%bb%ac%e9%9c%80%e8%a6%81%e7%9a%84%e8%af%b7%e6%b1%82%e8%b7%af%e5%be%84%0a%40Configuration%20%40EnableWebSecurity%20public%20class%20WebSecurityConfig%20extends%20WebSecurityConfigurerAdapter%20%7b%20%40Override%20protected%20void%20configure%28HttpSecurity%20http%29%20throws%20Exception%20%7b%20http.csrf%28%29.disable%28%29%3b%20http.authorizeRequests%28%29.antMatchers%28%26%2334%3b%2f%26%2334%3b%2c%20%26%2334%3b%2fauth%2f%2a%2a%26%2334%3b%29.permitAll%28%29%3b%20%2f%2f%20%e5%af%b9%e6%a0%b9%e8%b7%af%e5%be%84%e5%92%8c%e6%89%80%e6%9c%89%2fauth%e8%b7%af%e5%be%84%e9%83%bd%e6%94%be%e8%a1%8c%20%20%7d%20%7d%20%e9%89%b4%e6%9d%83%20%20%e5%9c%a8%40Configuration%e4%b8%ad%e5%a3%b0%e6%98%8e%e4%b8%a4%e4%b8%aaBean%2c%e8%bf%99%e4%b8%a4%e4%b8%aaBean%e6%98%af%e9%89%b4%e6%9d%83%e7%9a%84%e5%85%b3%e9%94%ae%2c%e4%b8%80%e4%b8%aa%e7%94%a8%e4%ba%8e%e9%89%b4%e5%ae%9a%e6%9d%83%e9%99%90%2c%e4%b8%80%e4%b8%aa%e7%94%a8%e4%ba%8e%e5%8a%a0%e5%af%86%e5%af%86%e7%a0%81%20%20%40Configuration%20%40EnableWebSecurity%20public%20class%20WebSecurityConfig%20extends%20WebSecurityConfigurerAdapter%20%7b%20%40Override%20protected%20void%20configure%28HttpSecurity%20http%29%20throws%20Exception%20%7b%20http.csrf%28%29.disable%28%29%3b%20http.authorizeRequests%28%29.antMatchers%28%26%2334%3b%2f%26%2334%3b%2c%20%26%2334%3b%2fauth%2f%2a%2a%26%2334%3b%29.permitAll%28%29%3b%20%7d%20%2f%2a%20%e9%89%b4%e6%9d%83%e7%ae%a1%e7%90%86%e5%99%a8%20%2a%2f%20%40Bean%20public%20AuthenticationManager%20customAuthenticationManager%28%29%20throws%20Exception%20%7b%20return%20authenticationManager%28%29%3b%20%7d%20%2f%2a%20%e5%8a%a0%e5%af%86%e5%99%a8%20%2a%2f%20%40Bean%20public%20BCryptPasswordEncoder%20bCryptPasswordEncoder%28%29%20%7b%20return%20new%20BCryptPasswordEncoder%28%29%3b%20%7d%20%7d%20%20Service%20%20%40Service%20public%20class%20UserService%20implements%20UserDetailsService%20%7b%20%40Autowired%20private%20UserMapper%20userMapper%3b%20%40Autowired%20private%20BCryptPasswordEncoder%20bCryptPasswordEncoder%3b%20public%20boolean%20registerUser%28String%20username%2c%20String%20password%29%20%7b%20return%20userMapper." aria-label="Tumblr">
      <i class="fab fa-tumblr fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fwjinlei.github.io%2fposts%2fexp-java-day30%2f&t=Java%e5%ad%a6%e4%b9%a0%e7%ac%94%e8%ae%b0%28%e7%ac%ac%e4%b8%89%e5%8d%81%e5%a4%a9%29" aria-label="Hacker News">
      <i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i>
    </a>
  </li>
</ul>

    </div>

    <div id="actions-footer">
      
        <a id="menu-toggle" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;" aria-label="Menu">
          <i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
        <a id="share-toggle" class="icon" href="#" onclick="$('#share-footer').toggle();return false;" aria-label="Share">
          <i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" aria-label="Top of Page">
          <i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>


  <footer id="footer">
  <div class="footer-left">
    Copyright  &copy; 2021  this 
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
        <li><a href="/">Home</a></li>
         
        <li><a href="/posts">Writings</a></li>
         
        <li><a href="/tags">Tags</a></li>
         
        <li><a href="/about">About</a></li>
        
      </ul>
    </nav>
  </div>
</footer>


  </div>
</body>

<link rel="stylesheet" href=/lib/font-awesome/css/all.min.css>
<script src=/lib/jquery/jquery.min.js></script>
<script src=/js/main.js></script>

<script src=/js/code-copy.js></script>




</html>
