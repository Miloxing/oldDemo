<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <link rel="preload" href="/lib/font-awesome/webfonts/fa-brands-400.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" href="/lib/font-awesome/webfonts/fa-regular-400.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" href="/lib/font-awesome/webfonts/fa-solid-900.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" href="/lib/JetBrainsMono/web/woff2/JetBrainsMono-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <script type="text/javascript" src="https://latest.cactus.chat/cactus.js"></script>
  <link rel="stylesheet" href="https://latest.cactus.chat/style.css" type="text/css">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title> Java学习笔记(爬虫项目) | 虾米日记</title>
  <link rel = 'canonical' href = 'https://wjinlei.github.io/posts/exp-java-day13/'>
  <meta name="description" content="对酒当歌，人生几何，譬如朝露，去日苦多">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="robots" content="all,follow">
  <meta name="googlebot" content="index,follow,snippet,archive">
  <meta property="og:title" content="Java学习笔记(爬虫项目)" />
<meta property="og:description" content="从零开始做一个项目的原则  把每个项目都当作人生中最好的一个项目来精雕细琢  积累自己的Reputation(声誉) 一丝不苟的写好文档 代码质量&#43;&#43;   使用标准化业,界公认的模式和流程 (几乎)没有本地依赖,使用者能够好无障碍的运行 小步快跑  成就感 越小的变更越容易debug    开发约定  [强制] 使用Github&#43;主干&amp;分支模型进行开发  禁止直接push master 所有变更通过PR进行   [强制] 自动化代码质量检查&#43;测试  越早代价越低 Checkstyle/SpotBugs 最基本的自动化测试覆盖   [尽量] 一切工作自动化 规范提交流程  项目的推进流程  多人协作  模块化  各模块之间职责明确,界限清晰 基本的文档 基本的接口   小步提交  大的变更更加难以review 大的变更冲突更加棘手     单打独斗  先实现功能 再实现的过程中不停的抽取公共部分  每当写出很长很啰嗦的代码的时候,就需要重构了 每当你复制粘贴的时候,就需要重构了   通过重构实现模块化,接口化    爬虫项目算法  从一个节点开始,遍历所有的节点 采用广度优先算法  优先遍历同层次的节点     算法流程  一开始有个链接池 从链接池中拿一个链接,判断是否处理过  处理过,重新从池子中拿一个链接 没有处理过,是我们想要的吗?" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://wjinlei.github.io/posts/exp-java-day13/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-11-11T20:51:37+08:00" />
<meta property="article:modified_time" content="2021-11-11T20:51:37+08:00" />


  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Java学习笔记(爬虫项目)"/>
<meta name="twitter:description" content="从零开始做一个项目的原则  把每个项目都当作人生中最好的一个项目来精雕细琢  积累自己的Reputation(声誉) 一丝不苟的写好文档 代码质量&#43;&#43;   使用标准化业,界公认的模式和流程 (几乎)没有本地依赖,使用者能够好无障碍的运行 小步快跑  成就感 越小的变更越容易debug    开发约定  [强制] 使用Github&#43;主干&amp;分支模型进行开发  禁止直接push master 所有变更通过PR进行   [强制] 自动化代码质量检查&#43;测试  越早代价越低 Checkstyle/SpotBugs 最基本的自动化测试覆盖   [尽量] 一切工作自动化 规范提交流程  项目的推进流程  多人协作  模块化  各模块之间职责明确,界限清晰 基本的文档 基本的接口   小步提交  大的变更更加难以review 大的变更冲突更加棘手     单打独斗  先实现功能 再实现的过程中不停的抽取公共部分  每当写出很长很啰嗦的代码的时候,就需要重构了 每当你复制粘贴的时候,就需要重构了   通过重构实现模块化,接口化    爬虫项目算法  从一个节点开始,遍历所有的节点 采用广度优先算法  优先遍历同层次的节点     算法流程  一开始有个链接池 从链接池中拿一个链接,判断是否处理过  处理过,重新从池子中拿一个链接 没有处理过,是我们想要的吗?"/>

  
  
    
  
  
  <link rel="stylesheet" href="https://wjinlei.github.io/css/styles.4c2b9aa1d874d6766f554b2d404e8fd62ab4761f51ee9b3f358d12e81e7fa43a1b4378db995bc1926bbe5ed98c060be5e7bd4f2470504cf94f22b4b3a74e62b6.css" integrity="sha512-TCuaodh01nZvVUstQE6P1iq0dh9R7ps/NY0S6B5/pDobQ3jbmVvBkmu&#43;XtmMBgvl571PJHBQTPlPIrSzp05itg=="> 

  
   <link rel="stylesheet" href="https://wjinlei.github.io/css/custom.css"> 
  
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  

  
<link rel="icon" type="image/png" href="https://wjinlei.github.io/images/favicon.ico" />

  
  
</head>

<body class="max-width mx-auto px3 ltr">
  <div class="content index py4">

  <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;" aria-label="Top of Page"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
        <li><a href="/">Home</a></li>
         
        <li><a href="/posts">Writings</a></li>
         
        <li><a href="/tags">Tags</a></li>
         
        <li><a href="/about">About</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li>
          <a class="icon" href=" https://wjinlei.github.io/posts/exp-java-day12/" aria-label="Previous">
            <i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i>
          </a>
        </li>
        
        
        <li>
          <a class="icon" href="https://wjinlei.github.io/posts/exp-java-day20/" aria-label="Next">
            <i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i>
          </a>
        </li>
        
        <li>
          <a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" aria-label="Top of Page">
            <i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i>
          </a>
        </li>
        <li>
          <a class="icon" href="#" aria-label="Share">
            <i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i>
          </a>
        </li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      
      <ul>
  
  
    
  
  
  <li>
    <a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fwjinlei.github.io%2fposts%2fexp-java-day13%2f" aria-label="Facebook">
      <i class="fab fa-facebook " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://twitter.com/share?url=https%3a%2f%2fwjinlei.github.io%2fposts%2fexp-java-day13%2f&text=Java%e5%ad%a6%e4%b9%a0%e7%ac%94%e8%ae%b0%28%e7%88%ac%e8%99%ab%e9%a1%b9%e7%9b%ae%29" aria-label="Twitter">
      <i class="fab fa-twitter " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fwjinlei.github.io%2fposts%2fexp-java-day13%2f&title=Java%e5%ad%a6%e4%b9%a0%e7%ac%94%e8%ae%b0%28%e7%88%ac%e8%99%ab%e9%a1%b9%e7%9b%ae%29" aria-label="Linkedin">
      <i class="fab fa-linkedin " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fwjinlei.github.io%2fposts%2fexp-java-day13%2f&is_video=false&description=Java%e5%ad%a6%e4%b9%a0%e7%ac%94%e8%ae%b0%28%e7%88%ac%e8%99%ab%e9%a1%b9%e7%9b%ae%29" aria-label="Pinterest">
      <i class="fab fa-pinterest " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="mailto:?subject=Java%e5%ad%a6%e4%b9%a0%e7%ac%94%e8%ae%b0%28%e7%88%ac%e8%99%ab%e9%a1%b9%e7%9b%ae%29&body=Check out this article: https%3a%2f%2fwjinlei.github.io%2fposts%2fexp-java-day13%2f" aria-label="Email">
      <i class="fas fa-envelope " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2fwjinlei.github.io%2fposts%2fexp-java-day13%2f&title=Java%e5%ad%a6%e4%b9%a0%e7%ac%94%e8%ae%b0%28%e7%88%ac%e8%99%ab%e9%a1%b9%e7%9b%ae%29" aria-label="Pocket">
      <i class="fab fa-get-pocket " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2fwjinlei.github.io%2fposts%2fexp-java-day13%2f&title=Java%e5%ad%a6%e4%b9%a0%e7%ac%94%e8%ae%b0%28%e7%88%ac%e8%99%ab%e9%a1%b9%e7%9b%ae%29" aria-label="reddit">
      <i class="fab fa-reddit " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.tumblr.com/share/link?url=https%3a%2f%2fwjinlei.github.io%2fposts%2fexp-java-day13%2f&name=Java%e5%ad%a6%e4%b9%a0%e7%ac%94%e8%ae%b0%28%e7%88%ac%e8%99%ab%e9%a1%b9%e7%9b%ae%29&description=%e4%bb%8e%e9%9b%b6%e5%bc%80%e5%a7%8b%e5%81%9a%e4%b8%80%e4%b8%aa%e9%a1%b9%e7%9b%ae%e7%9a%84%e5%8e%9f%e5%88%99%20%20%e6%8a%8a%e6%af%8f%e4%b8%aa%e9%a1%b9%e7%9b%ae%e9%83%bd%e5%bd%93%e4%bd%9c%e4%ba%ba%e7%94%9f%e4%b8%ad%e6%9c%80%e5%a5%bd%e7%9a%84%e4%b8%80%e4%b8%aa%e9%a1%b9%e7%9b%ae%e6%9d%a5%e7%b2%be%e9%9b%95%e7%bb%86%e7%90%a2%20%20%e7%a7%af%e7%b4%af%e8%87%aa%e5%b7%b1%e7%9a%84Reputation%28%e5%a3%b0%e8%aa%89%29%20%e4%b8%80%e4%b8%9d%e4%b8%8d%e8%8b%9f%e7%9a%84%e5%86%99%e5%a5%bd%e6%96%87%e6%a1%a3%20%e4%bb%a3%e7%a0%81%e8%b4%a8%e9%87%8f%2b%2b%20%20%20%e4%bd%bf%e7%94%a8%e6%a0%87%e5%87%86%e5%8c%96%e4%b8%9a%2c%e7%95%8c%e5%85%ac%e8%ae%a4%e7%9a%84%e6%a8%a1%e5%bc%8f%e5%92%8c%e6%b5%81%e7%a8%8b%20%28%e5%87%a0%e4%b9%8e%29%e6%b2%a1%e6%9c%89%e6%9c%ac%e5%9c%b0%e4%be%9d%e8%b5%96%2c%e4%bd%bf%e7%94%a8%e8%80%85%e8%83%bd%e5%a4%9f%e5%a5%bd%e6%97%a0%e9%9a%9c%e7%a2%8d%e7%9a%84%e8%bf%90%e8%a1%8c%20%e5%b0%8f%e6%ad%a5%e5%bf%ab%e8%b7%91%20%20%e6%88%90%e5%b0%b1%e6%84%9f%20%e8%b6%8a%e5%b0%8f%e7%9a%84%e5%8f%98%e6%9b%b4%e8%b6%8a%e5%ae%b9%e6%98%93debug%20%20%20%20%e5%bc%80%e5%8f%91%e7%ba%a6%e5%ae%9a%20%20%5b%e5%bc%ba%e5%88%b6%5d%20%e4%bd%bf%e7%94%a8Github%2b%e4%b8%bb%e5%b9%b2%26amp%3b%e5%88%86%e6%94%af%e6%a8%a1%e5%9e%8b%e8%bf%9b%e8%a1%8c%e5%bc%80%e5%8f%91%20%20%e7%a6%81%e6%ad%a2%e7%9b%b4%e6%8e%a5push%20master%20%e6%89%80%e6%9c%89%e5%8f%98%e6%9b%b4%e9%80%9a%e8%bf%87PR%e8%bf%9b%e8%a1%8c%20%20%20%5b%e5%bc%ba%e5%88%b6%5d%20%e8%87%aa%e5%8a%a8%e5%8c%96%e4%bb%a3%e7%a0%81%e8%b4%a8%e9%87%8f%e6%a3%80%e6%9f%a5%2b%e6%b5%8b%e8%af%95%20%20%e8%b6%8a%e6%97%a9%e4%bb%a3%e4%bb%b7%e8%b6%8a%e4%bd%8e%20Checkstyle%2fSpotBugs%20%e6%9c%80%e5%9f%ba%e6%9c%ac%e7%9a%84%e8%87%aa%e5%8a%a8%e5%8c%96%e6%b5%8b%e8%af%95%e8%a6%86%e7%9b%96%20%20%20%5b%e5%b0%bd%e9%87%8f%5d%20%e4%b8%80%e5%88%87%e5%b7%a5%e4%bd%9c%e8%87%aa%e5%8a%a8%e5%8c%96%20%e8%a7%84%e8%8c%83%e6%8f%90%e4%ba%a4%e6%b5%81%e7%a8%8b%20%20%e9%a1%b9%e7%9b%ae%e7%9a%84%e6%8e%a8%e8%bf%9b%e6%b5%81%e7%a8%8b%20%20%e5%a4%9a%e4%ba%ba%e5%8d%8f%e4%bd%9c%20%20%e6%a8%a1%e5%9d%97%e5%8c%96%20%20%e5%90%84%e6%a8%a1%e5%9d%97%e4%b9%8b%e9%97%b4%e8%81%8c%e8%b4%a3%e6%98%8e%e7%a1%ae%2c%e7%95%8c%e9%99%90%e6%b8%85%e6%99%b0%20%e5%9f%ba%e6%9c%ac%e7%9a%84%e6%96%87%e6%a1%a3%20%e5%9f%ba%e6%9c%ac%e7%9a%84%e6%8e%a5%e5%8f%a3%20%20%20%e5%b0%8f%e6%ad%a5%e6%8f%90%e4%ba%a4%20%20%e5%a4%a7%e7%9a%84%e5%8f%98%e6%9b%b4%e6%9b%b4%e5%8a%a0%e9%9a%be%e4%bb%a5review%20%e5%a4%a7%e7%9a%84%e5%8f%98%e6%9b%b4%e5%86%b2%e7%aa%81%e6%9b%b4%e5%8a%a0%e6%a3%98%e6%89%8b%20%20%20%20%20%e5%8d%95%e6%89%93%e7%8b%ac%e6%96%97%20%20%e5%85%88%e5%ae%9e%e7%8e%b0%e5%8a%9f%e8%83%bd%20%e5%86%8d%e5%ae%9e%e7%8e%b0%e7%9a%84%e8%bf%87%e7%a8%8b%e4%b8%ad%e4%b8%8d%e5%81%9c%e7%9a%84%e6%8a%bd%e5%8f%96%e5%85%ac%e5%85%b1%e9%83%a8%e5%88%86%20%20%e6%af%8f%e5%bd%93%e5%86%99%e5%87%ba%e5%be%88%e9%95%bf%e5%be%88%e5%95%b0%e5%97%a6%e7%9a%84%e4%bb%a3%e7%a0%81%e7%9a%84%e6%97%b6%e5%80%99%2c%e5%b0%b1%e9%9c%80%e8%a6%81%e9%87%8d%e6%9e%84%e4%ba%86%20%e6%af%8f%e5%bd%93%e4%bd%a0%e5%a4%8d%e5%88%b6%e7%b2%98%e8%b4%b4%e7%9a%84%e6%97%b6%e5%80%99%2c%e5%b0%b1%e9%9c%80%e8%a6%81%e9%87%8d%e6%9e%84%e4%ba%86%20%20%20%e9%80%9a%e8%bf%87%e9%87%8d%e6%9e%84%e5%ae%9e%e7%8e%b0%e6%a8%a1%e5%9d%97%e5%8c%96%2c%e6%8e%a5%e5%8f%a3%e5%8c%96%20%20%20%20%e7%88%ac%e8%99%ab%e9%a1%b9%e7%9b%ae%e7%ae%97%e6%b3%95%20%20%e4%bb%8e%e4%b8%80%e4%b8%aa%e8%8a%82%e7%82%b9%e5%bc%80%e5%a7%8b%2c%e9%81%8d%e5%8e%86%e6%89%80%e6%9c%89%e7%9a%84%e8%8a%82%e7%82%b9%20%e9%87%87%e7%94%a8%e5%b9%bf%e5%ba%a6%e4%bc%98%e5%85%88%e7%ae%97%e6%b3%95%20%20%e4%bc%98%e5%85%88%e9%81%8d%e5%8e%86%e5%90%8c%e5%b1%82%e6%ac%a1%e7%9a%84%e8%8a%82%e7%82%b9%20%20%20%20%20%e7%ae%97%e6%b3%95%e6%b5%81%e7%a8%8b%20%20%e4%b8%80%e5%bc%80%e5%a7%8b%e6%9c%89%e4%b8%aa%e9%93%be%e6%8e%a5%e6%b1%a0%20%e4%bb%8e%e9%93%be%e6%8e%a5%e6%b1%a0%e4%b8%ad%e6%8b%bf%e4%b8%80%e4%b8%aa%e9%93%be%e6%8e%a5%2c%e5%88%a4%e6%96%ad%e6%98%af%e5%90%a6%e5%a4%84%e7%90%86%e8%bf%87%20%20%e5%a4%84%e7%90%86%e8%bf%87%2c%e9%87%8d%e6%96%b0%e4%bb%8e%e6%b1%a0%e5%ad%90%e4%b8%ad%e6%8b%bf%e4%b8%80%e4%b8%aa%e9%93%be%e6%8e%a5%20%e6%b2%a1%e6%9c%89%e5%a4%84%e7%90%86%e8%bf%87%2c%e6%98%af%e6%88%91%e4%bb%ac%e6%83%b3%e8%a6%81%e7%9a%84%e5%90%97%3f" aria-label="Tumblr">
      <i class="fab fa-tumblr " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fwjinlei.github.io%2fposts%2fexp-java-day13%2f&t=Java%e5%ad%a6%e4%b9%a0%e7%ac%94%e8%ae%b0%28%e7%88%ac%e8%99%ab%e9%a1%b9%e7%9b%ae%29" aria-label="Hacker News">
      <i class="fab fa-hacker-news " aria-hidden="true"></i>
    </a>
  </li>
</ul>

    </div>
    
  </span>
</div>


  <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
    <header>
      <h1 class="posttitle" itemprop="name headline">
        Java学习笔记(爬虫项目)
      </h1>
      <div class="meta">
        
        <div class="postdate">
          
          <time datetime="2021-11-11 20:51:37 &#43;0800 CST" itemprop="datePublished">2021-11-11</time>
          
        </div>
        
        
        <div class="article-read-time">
          <i class="far fa-clock"></i>
          
          30 minute read
        </div>
        
        
        
      </div>
    </header>

  
    
    <div id="toc">
      <nav id="TableOfContents">
  <ul>
    <li><a href="#从零开始做一个项目的原则">从零开始做一个项目的原则</a></li>
    <li><a href="#开发约定">开发约定</a></li>
    <li><a href="#项目的推进流程">项目的推进流程</a></li>
    <li><a href="#爬虫项目算法">爬虫项目算法</a>
      <ul>
        <li><a href="#算法流程">算法流程</a></li>
      </ul>
    </li>
    <li><a href="#原始代码">原始代码</a></li>
    <li><a href="#第一次重构">第一次重构</a></li>
    <li><a href="#maven-生命周期">Maven 生命周期</a></li>
    <li><a href="#第二次重构引入数据库实现断点续传">第二次重构,引入数据库实现断点续传</a></li>
    <li><a href="#利用flyway自动化迁移数据库">利用flyway自动化迁移数据库</a>
      <ul>
        <li><a href="#使用方法">使用方法</a></li>
      </ul>
    </li>
    <li><a href="#第三次重构v100">第三次重构,v1.0.0</a></li>
    <li><a href="#第四次重构将数据库操作剥离出去">第四次重构,将数据库操作剥离出去</a></li>
    <li><a href="#第五次重构引入ormobjectrelational-mapping对象关系映射">第五次重构,引入ORM(Object–relational mapping)对象关系映射</a></li>
    <li><a href="#迁移到mysql">迁移到MySQL</a></li>
    <li><a href="#第六次重构改造多线程提升爬虫性能">第六次重构,改造多线程提升爬虫性能</a></li>
    <li><a href="#引入elasticsearch">引入Elasticsearch</a></li>
    <li><a href="#最终效果">最终效果</a></li>
  </ul>
</nav>
    </div>
    
    <div class="content" itemprop="articleBody">
      <h2 id="从零开始做一个项目的原则">从零开始做一个项目的原则</h2>
<ul>
<li>把每个项目都当作人生中最好的一个项目来精雕细琢
<ul>
<li>积累自己的<code>Reputation</code>(声誉)</li>
<li>一丝不苟的写好文档</li>
<li>代码质量++</li>
</ul>
</li>
<li>使用标准化业,界公认的模式和流程</li>
<li>(几乎)没有本地依赖,使用者能够好无障碍的运行</li>
<li>小步快跑
<ul>
<li>成就感</li>
<li>越小的变更越容易<code>debug</code></li>
</ul>
</li>
</ul>
<h2 id="开发约定">开发约定</h2>
<ul>
<li>[强制] 使用<code>Github</code>+<code>主干</code>&amp;<code>分支</code>模型进行开发
<ul>
<li>禁止直接<code>push master</code></li>
<li>所有变更通过<code>PR</code>进行</li>
</ul>
</li>
<li>[强制] 自动化代码质量检查+测试
<ul>
<li>越早代价越低</li>
<li><code>Checkstyle</code>/<code>SpotBugs</code></li>
<li>最基本的自动化测试覆盖</li>
</ul>
</li>
<li>[尽量] 一切工作自动化</li>
<li>规范提交流程</li>
</ul>
<h2 id="项目的推进流程">项目的推进流程</h2>
<ul>
<li>多人协作
<ul>
<li>模块化
<ul>
<li>各模块之间职责明确,界限清晰</li>
<li>基本的文档</li>
<li>基本的接口</li>
</ul>
</li>
<li>小步提交
<ul>
<li>大的变更更加难以<code>review</code></li>
<li>大的变更冲突更加棘手</li>
</ul>
</li>
</ul>
</li>
<li>单打独斗
<ul>
<li>先实现功能</li>
<li>再实现的过程中不停的抽取公共部分
<ul>
<li>每当写出很长很啰嗦的代码的时候,就需要重构了</li>
<li>每当你复制粘贴的时候,就需要重构了</li>
</ul>
</li>
<li>通过重构实现模块化,接口化</li>
</ul>
</li>
</ul>
<h2 id="爬虫项目算法">爬虫项目算法</h2>
<ul>
<li>从一个节点开始,遍历所有的节点</li>
<li>采用<code>广度优先算法</code>
<ul>
<li>优先遍历同层次的节点
<img src="/image/project-test-crawler/01.png" alt="广度优先"></li>
</ul>
</li>
</ul>
<h3 id="算法流程">算法流程</h3>
<ol>
<li>一开始有个链接池</li>
<li>从链接池中拿一个链接,判断是否处理过
<ol>
<li>处理过,重新从池子中拿一个链接</li>
<li>没有处理过,是我们想要的吗?
<ol>
<li>不是,重新从池子拿一个链接</li>
<li>是我们想要的,处理它,把新得到的链接放入链接池
<ol>
<li>如果是新闻的话,存储它</li>
<li>然后把链接加入已处理的链接池中</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
<li>重新从2开始
<img src="/image/project-test-crawler/02.png" alt="算法图解"></li>
</ol>
<h2 id="原始代码">原始代码</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.apache.http.client.methods.CloseableHttpResponse</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.apache.http.client.methods.HttpGet</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.apache.http.impl.client.CloseableHttpClient</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.apache.http.impl.client.HttpClients</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.apache.http.util.EntityUtils</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.jsoup.Jsoup</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.jsoup.nodes.Document</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.jsoup.nodes.Element</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.jsoup.select.Elements</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.io.IOException</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.util.ArrayList</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.util.HashSet</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">Main</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">main</span><span style="color:#000;font-weight:bold">(</span>String<span style="color:#000;font-weight:bold">[]</span> args<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> IOException <span style="color:#000;font-weight:bold">{</span>
        ArrayList<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">&gt;</span> unHandledPool <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> ArrayList<span style="color:#000;font-weight:bold">&lt;&gt;();</span>
        HashSet<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">&gt;</span> handledPool <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> HashSet<span style="color:#000;font-weight:bold">&lt;&gt;();</span>
        unHandledPool<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;https://sina.cn&#34;</span><span style="color:#000;font-weight:bold">);</span>

        <span style="color:#000;font-weight:bold">while</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>unHandledPool<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isEmpty</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
                <span style="color:#000;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
            <span style="color:#000;font-weight:bold">}</span>

            String link <span style="color:#000;font-weight:bold">=</span> unHandledPool<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span>unHandledPool<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">size</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">-</span> 1<span style="color:#000;font-weight:bold">);</span>
            unHandledPool<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">remove</span><span style="color:#000;font-weight:bold">(</span>link<span style="color:#000;font-weight:bold">);</span>

            <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>handledPool<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">contains</span><span style="color:#000;font-weight:bold">(</span>link<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
                <span style="color:#000;font-weight:bold">continue</span><span style="color:#000;font-weight:bold">;</span>
            <span style="color:#000;font-weight:bold">}</span>

            <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>link<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">startsWith</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;//&#34;</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
                link <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;https:&#34;</span> <span style="color:#000;font-weight:bold">+</span> link<span style="color:#000;font-weight:bold">;</span>
            <span style="color:#000;font-weight:bold">}</span>

            <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(!</span>link<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">contains</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;passport.sina.cn&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;https://sina.cn&#34;</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">equals</span><span style="color:#000;font-weight:bold">(</span>link<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">||</span> link<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">contains</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;news.sina.cn&#34;</span><span style="color:#000;font-weight:bold">)))</span> <span style="color:#000;font-weight:bold">{</span>
                CloseableHttpClient document <span style="color:#000;font-weight:bold">=</span> HttpClients<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">createDefault</span><span style="color:#000;font-weight:bold">();</span>
                HttpGet request <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> HttpGet<span style="color:#000;font-weight:bold">(</span>link<span style="color:#000;font-weight:bold">);</span>
                request<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setHeader</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;User-Agent&#34;</span><span style="color:#000;font-weight:bold">,</span>
                        <span style="color:#d14">&#34;Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/95.0.4638.69 Safari/537.36&#34;</span><span style="color:#000;font-weight:bold">);</span>
                <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">(</span>CloseableHttpResponse response <span style="color:#000;font-weight:bold">=</span> document<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">execute</span><span style="color:#000;font-weight:bold">(</span>request<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
                    String html <span style="color:#000;font-weight:bold">=</span> EntityUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">toString</span><span style="color:#000;font-weight:bold">(</span>response<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getEntity</span><span style="color:#000;font-weight:bold">());</span>
                    Document parse <span style="color:#000;font-weight:bold">=</span> Jsoup<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">parse</span><span style="color:#000;font-weight:bold">(</span>html<span style="color:#000;font-weight:bold">);</span>
                    <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span>Element a <span style="color:#000;font-weight:bold">:</span> parse<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">select</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;a&#34;</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
                        String href <span style="color:#000;font-weight:bold">=</span> a<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">attr</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;href&#34;</span><span style="color:#000;font-weight:bold">);</span>
                        unHandledPool<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">add</span><span style="color:#000;font-weight:bold">(</span>href<span style="color:#000;font-weight:bold">);</span>
                    <span style="color:#000;font-weight:bold">}</span>
                    Elements articles <span style="color:#000;font-weight:bold">=</span> parse<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">select</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;article&#34;</span><span style="color:#000;font-weight:bold">);</span>
                    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(!</span>articles<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isEmpty</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
                        <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span>Element article <span style="color:#000;font-weight:bold">:</span> articles<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
                            System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span>article<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">child</span><span style="color:#000;font-weight:bold">(</span>0<span style="color:#000;font-weight:bold">).</span><span style="color:#008080">text</span><span style="color:#000;font-weight:bold">());</span>
                        <span style="color:#000;font-weight:bold">}</span>
                    <span style="color:#000;font-weight:bold">}</span>
                    handledPool<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">add</span><span style="color:#000;font-weight:bold">(</span>link<span style="color:#000;font-weight:bold">);</span>
                <span style="color:#000;font-weight:bold">}</span>
            <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><h2 id="第一次重构">第一次重构</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.apache.http.client.methods.CloseableHttpResponse</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.apache.http.client.methods.HttpGet</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.apache.http.impl.client.CloseableHttpClient</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.apache.http.impl.client.HttpClients</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.apache.http.util.EntityUtils</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.jsoup.Jsoup</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.jsoup.nodes.Document</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.jsoup.nodes.Element</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.jsoup.select.Elements</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.io.IOException</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.util.ArrayList</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.util.HashSet</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">Main</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">main</span><span style="color:#000;font-weight:bold">(</span>String<span style="color:#000;font-weight:bold">[]</span> args<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> IOException <span style="color:#000;font-weight:bold">{</span>
        ArrayList<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">&gt;</span> unHandledPool <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> ArrayList<span style="color:#000;font-weight:bold">&lt;&gt;();</span>
        HashSet<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">&gt;</span> handledPool <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> HashSet<span style="color:#000;font-weight:bold">&lt;&gt;();</span>

        unHandledPool<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;https://sina.cn&#34;</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">while</span> <span style="color:#000;font-weight:bold">(!</span>unHandledPool<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isEmpty</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
            String link <span style="color:#000;font-weight:bold">=</span> unHandledPool<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">remove</span><span style="color:#000;font-weight:bold">(</span>unHandledPool<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">size</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">-</span> 1<span style="color:#000;font-weight:bold">);</span>

            <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>handledPool<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">contains</span><span style="color:#000;font-weight:bold">(</span>link<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
                <span style="color:#000;font-weight:bold">continue</span><span style="color:#000;font-weight:bold">;</span>
            <span style="color:#000;font-weight:bold">}</span>

            <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>isWantTo<span style="color:#000;font-weight:bold">(</span>link<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
                Document jsoup <span style="color:#000;font-weight:bold">=</span> Jsoup<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">parse</span><span style="color:#000;font-weight:bold">(</span>httpGetHTML<span style="color:#000;font-weight:bold">(</span>link<span style="color:#000;font-weight:bold">));</span>
                jsoup<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">select</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;a&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">stream</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">map</span><span style="color:#000;font-weight:bold">(</span>a <span style="color:#000;font-weight:bold">-&gt;</span> a<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">attr</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;href&#34;</span><span style="color:#000;font-weight:bold">)).</span><span style="color:#008080">forEach</span><span style="color:#000;font-weight:bold">(</span>unHandledPool<span style="color:#000;font-weight:bold">::</span>add<span style="color:#000;font-weight:bold">);</span>
                storeNewsToDatabase<span style="color:#000;font-weight:bold">(</span>jsoup<span style="color:#000;font-weight:bold">);</span>
                handledPool<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">add</span><span style="color:#000;font-weight:bold">(</span>link<span style="color:#000;font-weight:bold">);</span>
            <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>


    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * Get HTML content
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * @param link http or https link
</span><span style="color:#998;font-style:italic">     * @return html body
</span><span style="color:#998;font-style:italic">     * @throws IOException IOException
</span><span style="color:#998;font-style:italic">     */</span>
    <span style="color:#000;font-weight:bold">private</span> <span style="color:#000;font-weight:bold">static</span> String <span style="color:#900;font-weight:bold">httpGetHTML</span><span style="color:#000;font-weight:bold">(</span>String link<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> IOException <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>link<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">startsWith</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;//&#34;</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
            link <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;https:&#34;</span> <span style="color:#000;font-weight:bold">+</span> link<span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000;font-weight:bold">}</span>
        CloseableHttpClient document <span style="color:#000;font-weight:bold">=</span> HttpClients<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">createDefault</span><span style="color:#000;font-weight:bold">();</span>
        HttpGet request <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> HttpGet<span style="color:#000;font-weight:bold">(</span>link<span style="color:#000;font-weight:bold">);</span>
        request<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setHeader</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;User-Agent&#34;</span><span style="color:#000;font-weight:bold">,</span>
                <span style="color:#d14">&#34;Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/95.0.4638.69 Safari/537.36&#34;</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">(</span>CloseableHttpResponse response <span style="color:#000;font-weight:bold">=</span> document<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">execute</span><span style="color:#000;font-weight:bold">(</span>request<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#000;font-weight:bold">return</span> EntityUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">toString</span><span style="color:#000;font-weight:bold">(</span>response<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getEntity</span><span style="color:#000;font-weight:bold">());</span>
        <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * Determine whether it is the desired link
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * @param link http or https link
</span><span style="color:#998;font-style:italic">     * @return true or false
</span><span style="color:#998;font-style:italic">     */</span>
    <span style="color:#000;font-weight:bold">private</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#458;font-weight:bold">boolean</span> <span style="color:#900;font-weight:bold">isWantTo</span><span style="color:#000;font-weight:bold">(</span>String link<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">return</span> isNotLogin<span style="color:#000;font-weight:bold">(</span>link<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> <span style="color:#000;font-weight:bold">(</span>isIndex<span style="color:#000;font-weight:bold">(</span>link<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">||</span> isNews<span style="color:#000;font-weight:bold">(</span>link<span style="color:#000;font-weight:bold">));</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * Determine whether it is a login page
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * @param link http or https link
</span><span style="color:#998;font-style:italic">     * @return true or false
</span><span style="color:#998;font-style:italic">     */</span>
    <span style="color:#000;font-weight:bold">private</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#458;font-weight:bold">boolean</span> <span style="color:#900;font-weight:bold">isNotLogin</span><span style="color:#000;font-weight:bold">(</span>String link<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">!</span>link<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">contains</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;passport.sina.cn&#34;</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * Determine whether it is the home page
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * @param link http or https link
</span><span style="color:#998;font-style:italic">     * @return true or false
</span><span style="color:#998;font-style:italic">     */</span>
    <span style="color:#000;font-weight:bold">private</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#458;font-weight:bold">boolean</span> <span style="color:#900;font-weight:bold">isIndex</span><span style="color:#000;font-weight:bold">(</span>String link<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">return</span> <span style="color:#d14">&#34;https://sina.cn&#34;</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">equals</span><span style="color:#000;font-weight:bold">(</span>link<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * Determine whether it is a news page
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * @param link http or https link
</span><span style="color:#998;font-style:italic">     * @return true or false
</span><span style="color:#998;font-style:italic">     */</span>
    <span style="color:#000;font-weight:bold">private</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#458;font-weight:bold">boolean</span> <span style="color:#900;font-weight:bold">isNews</span><span style="color:#000;font-weight:bold">(</span>String link<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">return</span> link<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">contains</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;news.sina.cn&#34;</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * Save news to database
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * @param jsoup Jsoup parse
</span><span style="color:#998;font-style:italic">     */</span>
    <span style="color:#000;font-weight:bold">private</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">storeNewsToDatabase</span><span style="color:#000;font-weight:bold">(</span>Document jsoup<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        Elements articles <span style="color:#000;font-weight:bold">=</span> jsoup<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">select</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;article&#34;</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(!</span>articles<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isEmpty</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span>Element article <span style="color:#000;font-weight:bold">:</span> articles<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
                System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span>article<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">child</span><span style="color:#000;font-weight:bold">(</span>0<span style="color:#000;font-weight:bold">).</span><span style="color:#008080">text</span><span style="color:#000;font-weight:bold">());</span>
            <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><h2 id="maven-生命周期">Maven 生命周期</h2>
<p>Maven会从头往下执行,当它执行到某个阶段的时候,它会看看这个阶段有没有什么工作要作<br>
如果没有什么工作要作,他就继续向下执行,如果有对应工作要做,就执行对应工作.<br>
工作是通过插件的形式绑定到指定生命周期阶段的,Maven中一个插件目标称为<code>goal</code></p>
<ul>
<li>
<p>Maven有哪些生命周期阶段?
<img src="/image/project-test-crawler/03.png" alt="Maven生命周期"></p>
</li>
<li>
<p>其中常用的有</p>
<ol>
<li>compile -&gt; maven-compile-plugin</li>
<li>test -&gt; maven-surefire-plugin</li>
<li>package</li>
<li>verify</li>
<li>install</li>
<li>deploy</li>
</ol>
</li>
<li>
<p>下面是一个插件绑定到compile阶段的例子</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#000080">&lt;plugins&gt;</span>
    <span style="color:#000080">&lt;plugin&gt;</span>
        <span style="color:#000080">&lt;artifactId&gt;</span>maven-checkstyle-plugin<span style="color:#000080">&lt;/artifactId&gt;</span>
        <span style="color:#000080">&lt;version&gt;</span>3.1.0<span style="color:#000080">&lt;/version&gt;</span>
        <span style="color:#000080">&lt;configuration&gt;</span>
            <span style="color:#000080">&lt;configLocation&gt;</span>${basedir}/.circleci/checkstyle.xml<span style="color:#000080">&lt;/configLocation&gt;</span>
            <span style="color:#000080">&lt;includeTestSourceDirectory&gt;</span>true<span style="color:#000080">&lt;/includeTestSourceDirectory&gt;</span>
            <span style="color:#000080">&lt;enableRulesSummary&gt;</span>false<span style="color:#000080">&lt;/enableRulesSummary&gt;</span>
        <span style="color:#000080">&lt;/configuration&gt;</span>
        <span style="color:#000080">&lt;executions&gt;</span>
            <span style="color:#000080">&lt;execution&gt;</span>
                <span style="color:#000080">&lt;id&gt;</span>compile<span style="color:#000080">&lt;/id&gt;</span>
                <span style="color:#000080">&lt;phase&gt;</span>compile<span style="color:#000080">&lt;/phase&gt;</span>
                <span style="color:#000080">&lt;goals&gt;</span>
                    <span style="color:#000080">&lt;goal&gt;</span>check<span style="color:#000080">&lt;/goal&gt;</span>
                <span style="color:#000080">&lt;/goals&gt;</span>
            <span style="color:#000080">&lt;/execution&gt;</span>
        <span style="color:#000080">&lt;/executions&gt;</span>
        <span style="color:#000080">&lt;dependencies&gt;</span>
            <span style="color:#000080">&lt;dependency&gt;</span>
                <span style="color:#000080">&lt;groupId&gt;</span>com.puppycrawl.tools<span style="color:#000080">&lt;/groupId&gt;</span>
                <span style="color:#000080">&lt;artifactId&gt;</span>checkstyle<span style="color:#000080">&lt;/artifactId&gt;</span>
                <span style="color:#000080">&lt;version&gt;</span>8.29<span style="color:#000080">&lt;/version&gt;</span>
            <span style="color:#000080">&lt;/dependency&gt;</span>
        <span style="color:#000080">&lt;/dependencies&gt;</span>
    <span style="color:#000080">&lt;/plugin&gt;</span>
<span style="color:#000080">&lt;/plugins&gt;</span>
</code></pre></div><h2 id="第二次重构引入数据库实现断点续传">第二次重构,引入数据库实现断点续传</h2>
<p><img src="/image/project-test-crawler/04.png" alt="数据库定义"></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.apache.http.client.methods.CloseableHttpResponse</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.apache.http.client.methods.HttpGet</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.apache.http.impl.client.CloseableHttpClient</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.apache.http.impl.client.HttpClients</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.apache.http.util.EntityUtils</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.jsoup.Jsoup</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.jsoup.nodes.Document</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.jsoup.nodes.Element</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.jsoup.select.Elements</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.io.File</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.io.IOException</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.sql.Connection</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.sql.DriverManager</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.sql.PreparedStatement</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.sql.ResultSet</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.sql.SQLException</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.util.ArrayList</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">Main</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">private</span> <span style="color:#000;font-weight:bold">static</span> Connection connection<span style="color:#000;font-weight:bold">;</span>

    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">main</span><span style="color:#000;font-weight:bold">(</span>String<span style="color:#000;font-weight:bold">[]</span> args<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> IOException<span style="color:#000;font-weight:bold">,</span> SQLException <span style="color:#000;font-weight:bold">{</span>
        setConnection<span style="color:#000;font-weight:bold">();</span>
        <span style="color:#000;font-weight:bold">while</span> <span style="color:#000;font-weight:bold">(!</span>selectUnHandledUrls<span style="color:#000;font-weight:bold">().</span><span style="color:#008080">isEmpty</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
            String url <span style="color:#000;font-weight:bold">=</span> removeUnHandledMaxUrl<span style="color:#000;font-weight:bold">();</span>
            <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>url <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
            <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>selectInHandledWhereUrl<span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">continue</span><span style="color:#000;font-weight:bold">;</span>
            <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>isWantTo<span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
                Document jsoup <span style="color:#000;font-weight:bold">=</span> parseHtmlToHrefAndInsertIntoLinksUnHandled<span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">);</span>
                jsoupCssSelectAirtcleAndParseToInsertIntoNews<span style="color:#000;font-weight:bold">(</span>jsoup<span style="color:#000;font-weight:bold">);</span>
                updateUrlWithSql<span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;INSERT INTO LINKS_IN_HANDLED(link) VALUES ( ? )&#34;</span><span style="color:#000;font-weight:bold">);</span>
            <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * Load links from databases
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * @return ArrayList
</span><span style="color:#998;font-style:italic">     * @throws SQLException SQLException
</span><span style="color:#998;font-style:italic">     */</span>
    <span style="color:#000;font-weight:bold">private</span> <span style="color:#000;font-weight:bold">static</span> ArrayList<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#900;font-weight:bold">selectUnHandledUrls</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">throws</span> SQLException <span style="color:#000;font-weight:bold">{</span>
        ArrayList<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">&gt;</span> list <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> ArrayList<span style="color:#000;font-weight:bold">&lt;&gt;();</span>
        <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">(</span>PreparedStatement preparedStatement <span style="color:#000;font-weight:bold">=</span> connection<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">prepareStatement</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;SELECT link FROM LINKS_UN_HANDLED&#34;</span><span style="color:#000;font-weight:bold">);</span>
             ResultSet resultSet <span style="color:#000;font-weight:bold">=</span> preparedStatement<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">executeQuery</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#000;font-weight:bold">while</span> <span style="color:#000;font-weight:bold">(</span>resultSet<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">next</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
                list<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">add</span><span style="color:#000;font-weight:bold">(</span>resultSet<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getString</span><span style="color:#000;font-weight:bold">(</span>1<span style="color:#000;font-weight:bold">));</span>
            <span style="color:#000;font-weight:bold">}</span>
            <span style="color:#000;font-weight:bold">return</span> list<span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * DELETE FROM LINKS_UN_HANDLED WHERE link = (SELECT max(id) FROM LINKS_UN_HANDLED)
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * @return return deleted link
</span><span style="color:#998;font-style:italic">     * @throws SQLException SQLException
</span><span style="color:#998;font-style:italic">     */</span>
    <span style="color:#000;font-weight:bold">private</span> <span style="color:#000;font-weight:bold">static</span> String <span style="color:#900;font-weight:bold">removeUnHandledMaxUrl</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">throws</span> SQLException <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">(</span>PreparedStatement preparedStatement <span style="color:#000;font-weight:bold">=</span> connection<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">prepareStatement</span><span style="color:#000;font-weight:bold">(</span>
                <span style="color:#d14">&#34;SELECT * FROM LINKS_UN_HANDLED WHERE id=(SELECT max(id) FROM LINKS_UN_HANDLED)&#34;</span><span style="color:#000;font-weight:bold">);</span>
             ResultSet resultSet <span style="color:#000;font-weight:bold">=</span> preparedStatement<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">executeQuery</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>resultSet<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">next</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
                String url <span style="color:#000;font-weight:bold">=</span> resultSet<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getString</span><span style="color:#000;font-weight:bold">(</span>2<span style="color:#000;font-weight:bold">);</span>
                updateUrlWithSql<span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;DELETE FROM LINKS_UN_HANDLED WHERE link = ?&#34;</span><span style="color:#000;font-weight:bold">);</span>
                <span style="color:#000;font-weight:bold">return</span> url<span style="color:#000;font-weight:bold">;</span>
            <span style="color:#000;font-weight:bold">}</span>
            <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * SELECT link FROM LINKS_IN_HANDLED WHERE link = ?
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * @param url http or https link
</span><span style="color:#998;font-style:italic">     * @return if exists return true, else return false
</span><span style="color:#998;font-style:italic">     * @throws SQLException SQLException
</span><span style="color:#998;font-style:italic">     */</span>
    <span style="color:#000;font-weight:bold">private</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#458;font-weight:bold">boolean</span> <span style="color:#900;font-weight:bold">selectInHandledWhereUrl</span><span style="color:#000;font-weight:bold">(</span>String url<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> SQLException <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">(</span>PreparedStatement preparedStatement
                     <span style="color:#000;font-weight:bold">=</span> connection<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">prepareStatement</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;SELECT link FROM LINKS_IN_HANDLED WHERE link = ?&#34;</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
            preparedStatement<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setString</span><span style="color:#000;font-weight:bold">(</span>1<span style="color:#000;font-weight:bold">,</span> url<span style="color:#000;font-weight:bold">);</span>
            <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">(</span>ResultSet resultSet <span style="color:#000;font-weight:bold">=</span> preparedStatement<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">executeQuery</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
                <span style="color:#000;font-weight:bold">return</span> resultSet<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">next</span><span style="color:#000;font-weight:bold">();</span>
            <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * parse html to a tag, and &#39;INSERT INTO LINKS_UN_HANDLED&#39;
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * @param url http or https link
</span><span style="color:#998;font-style:italic">     * @return Jsoup Document
</span><span style="color:#998;font-style:italic">     * @throws SQLException SQLException
</span><span style="color:#998;font-style:italic">     * @throws IOException  IOException
</span><span style="color:#998;font-style:italic">     */</span>
    <span style="color:#000;font-weight:bold">private</span> <span style="color:#000;font-weight:bold">static</span> Document <span style="color:#900;font-weight:bold">parseHtmlToHrefAndInsertIntoLinksUnHandled</span><span style="color:#000;font-weight:bold">(</span>String url<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> SQLException<span style="color:#000;font-weight:bold">,</span> IOException <span style="color:#000;font-weight:bold">{</span>
        Document jsoup <span style="color:#000;font-weight:bold">=</span> Jsoup<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">parse</span><span style="color:#000;font-weight:bold">(</span>httpGetHTML<span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">));</span>
        <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span>Element a <span style="color:#000;font-weight:bold">:</span> jsoup<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">select</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;a&#34;</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
            String href <span style="color:#000;font-weight:bold">=</span> a<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">attr</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;href&#34;</span><span style="color:#000;font-weight:bold">);</span>
            updateUrlWithSql<span style="color:#000;font-weight:bold">(</span>href<span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;INSERT INTO LINKS_UN_HANDLED(link) VALUES ( ? )&#34;</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#000;font-weight:bold">return</span> jsoup<span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * executeUpdate for link
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * @param link http or https link
</span><span style="color:#998;font-style:italic">     * @param sql  sql
</span><span style="color:#998;font-style:italic">     * @throws SQLException SQLException
</span><span style="color:#998;font-style:italic">     */</span>
    <span style="color:#000;font-weight:bold">private</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">updateUrlWithSql</span><span style="color:#000;font-weight:bold">(</span>String link<span style="color:#000;font-weight:bold">,</span> String sql<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> SQLException <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">(</span>PreparedStatement preparedStatement
                     <span style="color:#000;font-weight:bold">=</span> connection<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">prepareStatement</span><span style="color:#000;font-weight:bold">(</span>sql<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
            preparedStatement<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setString</span><span style="color:#000;font-weight:bold">(</span>1<span style="color:#000;font-weight:bold">,</span> link<span style="color:#000;font-weight:bold">);</span>
            preparedStatement<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">executeUpdate</span><span style="color:#000;font-weight:bold">();</span>
        <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>


    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * Get HTML content
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * @param link http or https link
</span><span style="color:#998;font-style:italic">     * @return html body
</span><span style="color:#998;font-style:italic">     * @throws IOException IOException
</span><span style="color:#998;font-style:italic">     */</span>
    <span style="color:#000;font-weight:bold">private</span> <span style="color:#000;font-weight:bold">static</span> String <span style="color:#900;font-weight:bold">httpGetHTML</span><span style="color:#000;font-weight:bold">(</span>String link<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> IOException <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>link<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">startsWith</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;//&#34;</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
            link <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;https:&#34;</span> <span style="color:#000;font-weight:bold">+</span> link<span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000;font-weight:bold">}</span>
        CloseableHttpClient document <span style="color:#000;font-weight:bold">=</span> HttpClients<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">createDefault</span><span style="color:#000;font-weight:bold">();</span>
        HttpGet request <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> HttpGet<span style="color:#000;font-weight:bold">(</span>link<span style="color:#000;font-weight:bold">);</span>
        request<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setHeader</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;User-Agent&#34;</span><span style="color:#000;font-weight:bold">,</span>
                <span style="color:#d14">&#34;Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/95.0.4638.69 Safari/537.36&#34;</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">(</span>CloseableHttpResponse response <span style="color:#000;font-weight:bold">=</span> document<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">execute</span><span style="color:#000;font-weight:bold">(</span>request<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#000;font-weight:bold">return</span> EntityUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">toString</span><span style="color:#000;font-weight:bold">(</span>response<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getEntity</span><span style="color:#000;font-weight:bold">());</span>
        <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * Save news to database
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * @param jsoup Jsoup parse
</span><span style="color:#998;font-style:italic">     */</span>
    <span style="color:#000;font-weight:bold">private</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">jsoupCssSelectAirtcleAndParseToInsertIntoNews</span><span style="color:#000;font-weight:bold">(</span>Document jsoup<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        Elements articles <span style="color:#000;font-weight:bold">=</span> jsoup<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">select</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;article&#34;</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(!</span>articles<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isEmpty</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span>Element article <span style="color:#000;font-weight:bold">:</span> articles<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
                System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span>article<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">child</span><span style="color:#000;font-weight:bold">(</span>0<span style="color:#000;font-weight:bold">).</span><span style="color:#008080">text</span><span style="color:#000;font-weight:bold">());</span>
            <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * Determine whether it is the desired link
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * @param link http or https link
</span><span style="color:#998;font-style:italic">     * @return true or false
</span><span style="color:#998;font-style:italic">     */</span>
    <span style="color:#000;font-weight:bold">private</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#458;font-weight:bold">boolean</span> <span style="color:#900;font-weight:bold">isWantTo</span><span style="color:#000;font-weight:bold">(</span>String link<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">return</span> isNotLogin<span style="color:#000;font-weight:bold">(</span>link<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> <span style="color:#000;font-weight:bold">(</span>isIndex<span style="color:#000;font-weight:bold">(</span>link<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">||</span> isNews<span style="color:#000;font-weight:bold">(</span>link<span style="color:#000;font-weight:bold">));</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * Determine whether it is the home page
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * @param link http or https link
</span><span style="color:#998;font-style:italic">     * @return true or false
</span><span style="color:#998;font-style:italic">     */</span>
    <span style="color:#000;font-weight:bold">private</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#458;font-weight:bold">boolean</span> <span style="color:#900;font-weight:bold">isIndex</span><span style="color:#000;font-weight:bold">(</span>String link<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">return</span> <span style="color:#d14">&#34;https://sina.cn&#34;</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">equals</span><span style="color:#000;font-weight:bold">(</span>link<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * Determine whether it is a login page
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * @param link http or https link
</span><span style="color:#998;font-style:italic">     * @return true or false
</span><span style="color:#998;font-style:italic">     */</span>
    <span style="color:#000;font-weight:bold">private</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#458;font-weight:bold">boolean</span> <span style="color:#900;font-weight:bold">isNotLogin</span><span style="color:#000;font-weight:bold">(</span>String link<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">!</span>link<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">contains</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;passport.sina.cn&#34;</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * Determine whether it is a news page
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * @param link http or https link
</span><span style="color:#998;font-style:italic">     * @return true or false
</span><span style="color:#998;font-style:italic">     */</span>
    <span style="color:#000;font-weight:bold">private</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#458;font-weight:bold">boolean</span> <span style="color:#900;font-weight:bold">isNews</span><span style="color:#000;font-weight:bold">(</span>String link<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">return</span> link<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">contains</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;news.sina.cn&#34;</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * Set database connection
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * @throws SQLException SQLException
</span><span style="color:#998;font-style:italic">     */</span>
    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">setConnection</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">throws</span> SQLException <span style="color:#000;font-weight:bold">{</span>
        File projectDir <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> File<span style="color:#000;font-weight:bold">(</span>System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getProperty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;basedir&#34;</span><span style="color:#000;font-weight:bold">,</span> System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getProperty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;user.dir&#34;</span><span style="color:#000;font-weight:bold">)));</span>
        String jdbcUrl <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;jdbc:h2:file:&#34;</span> <span style="color:#000;font-weight:bold">+</span> <span style="color:#000;font-weight:bold">new</span> File<span style="color:#000;font-weight:bold">(</span>projectDir<span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;news&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">getAbsolutePath</span><span style="color:#000;font-weight:bold">();</span>
        connection <span style="color:#000;font-weight:bold">=</span> DriverManager<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getConnection</span><span style="color:#000;font-weight:bold">(</span>jdbcUrl<span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;root&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;toor&#34;</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><h2 id="利用flyway自动化迁移数据库">利用flyway自动化迁移数据库</h2>
<ul>
<li>pom.xml</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#000080">&lt;plugin&gt;</span>
    <span style="color:#000080">&lt;groupId&gt;</span>org.flywaydb<span style="color:#000080">&lt;/groupId&gt;</span>
    <span style="color:#000080">&lt;artifactId&gt;</span>flyway-maven-plugin<span style="color:#000080">&lt;/artifactId&gt;</span>
    <span style="color:#000080">&lt;version&gt;</span>8.0.4<span style="color:#000080">&lt;/version&gt;</span>
    <span style="color:#000080">&lt;configuration&gt;</span>
        <span style="color:#000080">&lt;url&gt;</span>jdbc:h2:file:./news<span style="color:#000080">&lt;/url&gt;</span>
        <span style="color:#000080">&lt;user&gt;</span>root<span style="color:#000080">&lt;/user&gt;</span>
        <span style="color:#000080">&lt;password&gt;</span>toor<span style="color:#000080">&lt;/password&gt;</span>
    <span style="color:#000080">&lt;/configuration&gt;</span>
    <span style="color:#000080">&lt;dependencies&gt;</span>
        <span style="color:#000080">&lt;dependency&gt;</span>
            <span style="color:#000080">&lt;groupId&gt;</span>com.h2database<span style="color:#000080">&lt;/groupId&gt;</span>
            <span style="color:#000080">&lt;artifactId&gt;</span>h2<span style="color:#000080">&lt;/artifactId&gt;</span>
            <span style="color:#000080">&lt;version&gt;</span>1.4.200<span style="color:#000080">&lt;/version&gt;</span>
        <span style="color:#000080">&lt;/dependency&gt;</span>
    <span style="color:#000080">&lt;/dependencies&gt;</span>
<span style="color:#000080">&lt;/plugin&gt;</span>
</code></pre></div><h3 id="使用方法">使用方法</h3>
<ul>
<li>
<p>命名规则
<img src="/image/project-test-crawler/05.png" alt="命名规则说明"></p>
</li>
<li>
<p>目录路径
<img src="/image/project-test-crawler/06.png" alt="目录路径说明"></p>
</li>
<li>
<p>使用方法</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">mvn flyway:migrate
</code></pre></div><ul>
<li>你还可以把它挂载到Maven的initialize生命周期上</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#000080">&lt;executions&gt;</span>
    <span style="color:#000080">&lt;execution&gt;</span>
        <span style="color:#000080">&lt;id&gt;</span>initialize<span style="color:#000080">&lt;/id&gt;</span>
        <span style="color:#000080">&lt;phase&gt;</span>initialize<span style="color:#000080">&lt;/phase&gt;</span>
        <span style="color:#000080">&lt;goals&gt;</span>
            <span style="color:#000080">&lt;goal&gt;</span>migrate<span style="color:#000080">&lt;/goal&gt;</span>
        <span style="color:#000080">&lt;/goals&gt;</span>
    <span style="color:#000080">&lt;/execution&gt;</span>
<span style="color:#000080">&lt;/executions&gt;</span>
</code></pre></div><h2 id="第三次重构v100">第三次重构,v1.0.0</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.apache.http.client.methods.CloseableHttpResponse</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.apache.http.client.methods.HttpGet</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.apache.http.impl.client.CloseableHttpClient</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.apache.http.impl.client.HttpClients</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.apache.http.util.EntityUtils</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.jsoup.Jsoup</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.jsoup.nodes.Document</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.jsoup.nodes.Element</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.jsoup.select.Elements</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.io.File</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.io.IOException</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.sql.Connection</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.sql.DriverManager</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.sql.PreparedStatement</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.sql.ResultSet</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.sql.SQLException</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.util.ArrayList</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.util.stream.Collectors</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">Main</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">private</span> <span style="color:#000;font-weight:bold">static</span> Connection connection<span style="color:#000;font-weight:bold">;</span>

    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">main</span><span style="color:#000;font-weight:bold">(</span>String<span style="color:#000;font-weight:bold">[]</span> args<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> IOException<span style="color:#000;font-weight:bold">,</span> SQLException <span style="color:#000;font-weight:bold">{</span>
        setConnection<span style="color:#000;font-weight:bold">();</span>
        <span style="color:#000;font-weight:bold">while</span> <span style="color:#000;font-weight:bold">(!</span>selectUnHandledUrls<span style="color:#000;font-weight:bold">().</span><span style="color:#008080">isEmpty</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
            String url <span style="color:#000;font-weight:bold">=</span> removeUnHandledMaxUrl<span style="color:#000;font-weight:bold">();</span>
            <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>url <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
            <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>selectInHandledWhereUrl<span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">continue</span><span style="color:#000;font-weight:bold">;</span>
            <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>isWantTo<span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
                Document jsoup <span style="color:#000;font-weight:bold">=</span> parseHtmlToHrefAndInsertIntoLinksUnHandled<span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">);</span>
                jsoupCssSelectAirtcleAndParseToInsertIntoNews<span style="color:#000;font-weight:bold">(</span>jsoup<span style="color:#000;font-weight:bold">,</span> url<span style="color:#000;font-weight:bold">);</span>
                updateUrlWithSql<span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;INSERT INTO LINKS_IN_HANDLED(link) VALUES ( ? )&#34;</span><span style="color:#000;font-weight:bold">);</span>
            <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * Load links from databases
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * @return ArrayList
</span><span style="color:#998;font-style:italic">     * @throws SQLException SQLException
</span><span style="color:#998;font-style:italic">     */</span>
    <span style="color:#000;font-weight:bold">private</span> <span style="color:#000;font-weight:bold">static</span> ArrayList<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#900;font-weight:bold">selectUnHandledUrls</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">throws</span> SQLException <span style="color:#000;font-weight:bold">{</span>
        ArrayList<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">&gt;</span> list <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> ArrayList<span style="color:#000;font-weight:bold">&lt;&gt;();</span>
        <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">(</span>PreparedStatement preparedStatement <span style="color:#000;font-weight:bold">=</span> connection<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">prepareStatement</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;SELECT link FROM LINKS_UN_HANDLED&#34;</span><span style="color:#000;font-weight:bold">);</span>
             ResultSet resultSet <span style="color:#000;font-weight:bold">=</span> preparedStatement<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">executeQuery</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#000;font-weight:bold">while</span> <span style="color:#000;font-weight:bold">(</span>resultSet<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">next</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
                list<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">add</span><span style="color:#000;font-weight:bold">(</span>resultSet<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getString</span><span style="color:#000;font-weight:bold">(</span>1<span style="color:#000;font-weight:bold">));</span>
            <span style="color:#000;font-weight:bold">}</span>
            <span style="color:#000;font-weight:bold">return</span> list<span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * DELETE FROM LINKS_UN_HANDLED WHERE link = (SELECT max(id) FROM LINKS_UN_HANDLED)
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * @return return deleted link
</span><span style="color:#998;font-style:italic">     * @throws SQLException SQLException
</span><span style="color:#998;font-style:italic">     */</span>
    <span style="color:#000;font-weight:bold">private</span> <span style="color:#000;font-weight:bold">static</span> String <span style="color:#900;font-weight:bold">removeUnHandledMaxUrl</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">throws</span> SQLException <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">(</span>PreparedStatement preparedStatement <span style="color:#000;font-weight:bold">=</span> connection<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">prepareStatement</span><span style="color:#000;font-weight:bold">(</span>
                <span style="color:#d14">&#34;SELECT * FROM LINKS_UN_HANDLED WHERE id=(SELECT max(id) FROM LINKS_UN_HANDLED)&#34;</span><span style="color:#000;font-weight:bold">);</span>
             ResultSet resultSet <span style="color:#000;font-weight:bold">=</span> preparedStatement<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">executeQuery</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>resultSet<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">next</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
                String url <span style="color:#000;font-weight:bold">=</span> resultSet<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getString</span><span style="color:#000;font-weight:bold">(</span>2<span style="color:#000;font-weight:bold">);</span>
                updateUrlWithSql<span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;DELETE FROM LINKS_UN_HANDLED WHERE link = ?&#34;</span><span style="color:#000;font-weight:bold">);</span>
                <span style="color:#000;font-weight:bold">return</span> url<span style="color:#000;font-weight:bold">;</span>
            <span style="color:#000;font-weight:bold">}</span>
            <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * SELECT link FROM LINKS_IN_HANDLED WHERE link = ?
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * @param url http or https link
</span><span style="color:#998;font-style:italic">     * @return if exists return true, else return false
</span><span style="color:#998;font-style:italic">     * @throws SQLException SQLException
</span><span style="color:#998;font-style:italic">     */</span>
    <span style="color:#000;font-weight:bold">private</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#458;font-weight:bold">boolean</span> <span style="color:#900;font-weight:bold">selectInHandledWhereUrl</span><span style="color:#000;font-weight:bold">(</span>String url<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> SQLException <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">(</span>PreparedStatement preparedStatement
                     <span style="color:#000;font-weight:bold">=</span> connection<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">prepareStatement</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;SELECT link FROM LINKS_IN_HANDLED WHERE link = ?&#34;</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
            preparedStatement<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setString</span><span style="color:#000;font-weight:bold">(</span>1<span style="color:#000;font-weight:bold">,</span> url<span style="color:#000;font-weight:bold">);</span>
            <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">(</span>ResultSet resultSet <span style="color:#000;font-weight:bold">=</span> preparedStatement<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">executeQuery</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
                <span style="color:#000;font-weight:bold">return</span> resultSet<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">next</span><span style="color:#000;font-weight:bold">();</span>
            <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * parse html to a tag, and &#39;INSERT INTO LINKS_UN_HANDLED&#39;
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * @param url http or https link
</span><span style="color:#998;font-style:italic">     * @return Jsoup Document
</span><span style="color:#998;font-style:italic">     * @throws SQLException SQLException
</span><span style="color:#998;font-style:italic">     * @throws IOException  IOException
</span><span style="color:#998;font-style:italic">     */</span>
    <span style="color:#000;font-weight:bold">private</span> <span style="color:#000;font-weight:bold">static</span> Document <span style="color:#900;font-weight:bold">parseHtmlToHrefAndInsertIntoLinksUnHandled</span><span style="color:#000;font-weight:bold">(</span>String url<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> SQLException<span style="color:#000;font-weight:bold">,</span> IOException <span style="color:#000;font-weight:bold">{</span>
        Document jsoup <span style="color:#000;font-weight:bold">=</span> Jsoup<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">parse</span><span style="color:#000;font-weight:bold">(</span>httpGetHTML<span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">));</span>
        <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span>Element a <span style="color:#000;font-weight:bold">:</span> jsoup<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">select</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;a&#34;</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
            String href <span style="color:#000;font-weight:bold">=</span> a<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">attr</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;href&#34;</span><span style="color:#000;font-weight:bold">);</span>
            <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>href<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">toLowerCase</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">startsWith</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;http&#34;</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
                <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>isWantTo<span style="color:#000;font-weight:bold">(</span>href<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
                    updateUrlWithSql<span style="color:#000;font-weight:bold">(</span>href<span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;INSERT INTO LINKS_UN_HANDLED(link) VALUES ( ? )&#34;</span><span style="color:#000;font-weight:bold">);</span>
                <span style="color:#000;font-weight:bold">}</span>
            <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#000;font-weight:bold">return</span> jsoup<span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * executeUpdate for link
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * @param link http or https link
</span><span style="color:#998;font-style:italic">     * @param sql  sql
</span><span style="color:#998;font-style:italic">     * @throws SQLException SQLException
</span><span style="color:#998;font-style:italic">     */</span>
    <span style="color:#000;font-weight:bold">private</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">updateUrlWithSql</span><span style="color:#000;font-weight:bold">(</span>String link<span style="color:#000;font-weight:bold">,</span> String sql<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> SQLException <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">(</span>PreparedStatement preparedStatement
                     <span style="color:#000;font-weight:bold">=</span> connection<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">prepareStatement</span><span style="color:#000;font-weight:bold">(</span>sql<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
            preparedStatement<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setString</span><span style="color:#000;font-weight:bold">(</span>1<span style="color:#000;font-weight:bold">,</span> link<span style="color:#000;font-weight:bold">);</span>
            preparedStatement<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">executeUpdate</span><span style="color:#000;font-weight:bold">();</span>
        <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>


    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * Get HTML content
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * @param link http or https link
</span><span style="color:#998;font-style:italic">     * @return html body
</span><span style="color:#998;font-style:italic">     * @throws IOException IOException
</span><span style="color:#998;font-style:italic">     */</span>
    <span style="color:#000;font-weight:bold">private</span> <span style="color:#000;font-weight:bold">static</span> String <span style="color:#900;font-weight:bold">httpGetHTML</span><span style="color:#000;font-weight:bold">(</span>String link<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> IOException <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>link<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">startsWith</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;//&#34;</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
            link <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;https:&#34;</span> <span style="color:#000;font-weight:bold">+</span> link<span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000;font-weight:bold">}</span>
        CloseableHttpClient document <span style="color:#000;font-weight:bold">=</span> HttpClients<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">createDefault</span><span style="color:#000;font-weight:bold">();</span>
        HttpGet request <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> HttpGet<span style="color:#000;font-weight:bold">(</span>link<span style="color:#000;font-weight:bold">);</span>
        request<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setHeader</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;User-Agent&#34;</span><span style="color:#000;font-weight:bold">,</span>
                <span style="color:#d14">&#34;Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/95.0.4638.69 Safari/537.36&#34;</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">(</span>CloseableHttpResponse response <span style="color:#000;font-weight:bold">=</span> document<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">execute</span><span style="color:#000;font-weight:bold">(</span>request<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#000;font-weight:bold">return</span> EntityUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">toString</span><span style="color:#000;font-weight:bold">(</span>response<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getEntity</span><span style="color:#000;font-weight:bold">());</span>
        <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * Save news to database
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * @param jsoup Jsoup parse
</span><span style="color:#998;font-style:italic">     */</span>
    <span style="color:#000;font-weight:bold">private</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">jsoupCssSelectAirtcleAndParseToInsertIntoNews</span><span style="color:#000;font-weight:bold">(</span>Document jsoup<span style="color:#000;font-weight:bold">,</span> String url<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> SQLException <span style="color:#000;font-weight:bold">{</span>
        Elements articles <span style="color:#000;font-weight:bold">=</span> jsoup<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">select</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;article&#34;</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(!</span>articles<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isEmpty</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span>Element article <span style="color:#000;font-weight:bold">:</span> articles<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
                String title <span style="color:#000;font-weight:bold">=</span> article<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">select</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;h1.art_tit_h1&#34;</span><span style="color:#000;font-weight:bold">)</span>
                        <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">stream</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">map</span><span style="color:#000;font-weight:bold">(</span>Element<span style="color:#000;font-weight:bold">::</span>text<span style="color:#000;font-weight:bold">).</span><span style="color:#008080">collect</span><span style="color:#000;font-weight:bold">(</span>Collectors<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">joining</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;,&#34;</span><span style="color:#000;font-weight:bold">));</span>
                String content <span style="color:#000;font-weight:bold">=</span> article<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">select</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;p.art_p&#34;</span><span style="color:#000;font-weight:bold">)</span>
                        <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">stream</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">map</span><span style="color:#000;font-weight:bold">(</span>Element<span style="color:#000;font-weight:bold">::</span>text<span style="color:#000;font-weight:bold">).</span><span style="color:#008080">collect</span><span style="color:#000;font-weight:bold">(</span>Collectors<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">joining</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;\n&#34;</span><span style="color:#000;font-weight:bold">));</span>
                <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">(</span>PreparedStatement preparedStatement
                             <span style="color:#000;font-weight:bold">=</span> connection<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">prepareStatement</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;INSERT INTO NEWS(title, content, url) VALUES ( ?, ?, ? )&#34;</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
                    preparedStatement<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setString</span><span style="color:#000;font-weight:bold">(</span>1<span style="color:#000;font-weight:bold">,</span> title<span style="color:#000;font-weight:bold">);</span>
                    preparedStatement<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setString</span><span style="color:#000;font-weight:bold">(</span>2<span style="color:#000;font-weight:bold">,</span> content<span style="color:#000;font-weight:bold">);</span>
                    preparedStatement<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setString</span><span style="color:#000;font-weight:bold">(</span>3<span style="color:#000;font-weight:bold">,</span> url<span style="color:#000;font-weight:bold">);</span>
                    preparedStatement<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">executeUpdate</span><span style="color:#000;font-weight:bold">();</span>
                <span style="color:#000;font-weight:bold">}</span>
                System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">);</span>
                System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span>title<span style="color:#000;font-weight:bold">);</span>
            <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * Determine whether it is the desired link
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * @param link http or https link
</span><span style="color:#998;font-style:italic">     * @return true or false
</span><span style="color:#998;font-style:italic">     */</span>
    <span style="color:#000;font-weight:bold">private</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#458;font-weight:bold">boolean</span> <span style="color:#900;font-weight:bold">isWantTo</span><span style="color:#000;font-weight:bold">(</span>String link<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">return</span> isNotLogin<span style="color:#000;font-weight:bold">(</span>link<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> <span style="color:#000;font-weight:bold">(</span>isIndex<span style="color:#000;font-weight:bold">(</span>link<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">||</span> isNews<span style="color:#000;font-weight:bold">(</span>link<span style="color:#000;font-weight:bold">));</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * Determine whether it is the home page
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * @param link http or https link
</span><span style="color:#998;font-style:italic">     * @return true or false
</span><span style="color:#998;font-style:italic">     */</span>
    <span style="color:#000;font-weight:bold">private</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#458;font-weight:bold">boolean</span> <span style="color:#900;font-weight:bold">isIndex</span><span style="color:#000;font-weight:bold">(</span>String link<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">return</span> <span style="color:#d14">&#34;https://sina.cn&#34;</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">equals</span><span style="color:#000;font-weight:bold">(</span>link<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * Determine whether it is a login page
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * @param link http or https link
</span><span style="color:#998;font-style:italic">     * @return true or false
</span><span style="color:#998;font-style:italic">     */</span>
    <span style="color:#000;font-weight:bold">private</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#458;font-weight:bold">boolean</span> <span style="color:#900;font-weight:bold">isNotLogin</span><span style="color:#000;font-weight:bold">(</span>String link<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">!</span>link<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">contains</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;passport.sina.cn&#34;</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * Determine whether it is a news page
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * @param link http or https link
</span><span style="color:#998;font-style:italic">     * @return true or false
</span><span style="color:#998;font-style:italic">     */</span>
    <span style="color:#000;font-weight:bold">private</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#458;font-weight:bold">boolean</span> <span style="color:#900;font-weight:bold">isNews</span><span style="color:#000;font-weight:bold">(</span>String link<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">return</span> link<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">contains</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;news.sina.cn&#34;</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * Set database connection
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * @throws SQLException SQLException
</span><span style="color:#998;font-style:italic">     */</span>
    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">setConnection</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">throws</span> SQLException <span style="color:#000;font-weight:bold">{</span>
        File projectDir <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> File<span style="color:#000;font-weight:bold">(</span>System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getProperty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;basedir&#34;</span><span style="color:#000;font-weight:bold">,</span> System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getProperty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;user.dir&#34;</span><span style="color:#000;font-weight:bold">)));</span>
        String jdbcUrl <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;jdbc:h2:file:&#34;</span> <span style="color:#000;font-weight:bold">+</span> <span style="color:#000;font-weight:bold">new</span> File<span style="color:#000;font-weight:bold">(</span>projectDir<span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;news&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">getAbsolutePath</span><span style="color:#000;font-weight:bold">();</span>
        connection <span style="color:#000;font-weight:bold">=</span> DriverManager<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getConnection</span><span style="color:#000;font-weight:bold">(</span>jdbcUrl<span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;root&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;toor&#34;</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><h2 id="第四次重构将数据库操作剥离出去">第四次重构,将数据库操作剥离出去</h2>
<ul>
<li><code>Java</code>中对于数据库操作我们称之为<code>DAO</code>(Data Access Object)</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.apache.http.client.methods.CloseableHttpResponse</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.apache.http.client.methods.HttpGet</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.apache.http.impl.client.CloseableHttpClient</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.apache.http.impl.client.HttpClients</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.apache.http.util.EntityUtils</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.jsoup.Jsoup</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.jsoup.nodes.Document</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.jsoup.nodes.Element</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.jsoup.select.Elements</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.io.IOException</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.sql.ResultSet</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.sql.SQLException</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.util.stream.Collectors</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">Crawler</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">private</span> <span style="color:#000;font-weight:bold">final</span> CrawlerJdbcDao dao<span style="color:#000;font-weight:bold">;</span>

    <span style="color:#000;font-weight:bold">public</span> <span style="color:#900;font-weight:bold">Crawler</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">dao</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> CrawlerJdbcDao<span style="color:#000;font-weight:bold">();</span>
        <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>SQLException e<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#000;font-weight:bold">throw</span> <span style="color:#000;font-weight:bold">new</span> RuntimeException<span style="color:#000;font-weight:bold">(</span>e<span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>


    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">main</span><span style="color:#000;font-weight:bold">(</span>String<span style="color:#000;font-weight:bold">[]</span> args<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> IOException<span style="color:#000;font-weight:bold">,</span> SQLException <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">new</span> Crawler<span style="color:#000;font-weight:bold">().</span><span style="color:#008080">run</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#000;font-weight:bold">private</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">run</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">throws</span> SQLException<span style="color:#000;font-weight:bold">,</span> IOException <span style="color:#000;font-weight:bold">{</span>
        String link<span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000;font-weight:bold">while</span> <span style="color:#000;font-weight:bold">((</span>link <span style="color:#000;font-weight:bold">=</span> removeLink<span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>isHandled<span style="color:#000;font-weight:bold">(</span>link<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">continue</span><span style="color:#000;font-weight:bold">;</span>
            <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>isWantTo<span style="color:#000;font-weight:bold">(</span>link<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
                Document jsoup <span style="color:#000;font-weight:bold">=</span> parseHtmlToHrefAndInsertIntoLinksUnHandled<span style="color:#000;font-weight:bold">(</span>link<span style="color:#000;font-weight:bold">);</span>
                jsoupCssSelectAirtcleAndParseToInsertIntoNews<span style="color:#000;font-weight:bold">(</span>jsoup<span style="color:#000;font-weight:bold">,</span> link<span style="color:#000;font-weight:bold">);</span>
                dao<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">updateLinksInHandled</span><span style="color:#000;font-weight:bold">(</span>link<span style="color:#000;font-weight:bold">);</span>
            <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * Get a link from database and delete it
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * @return return deleted link
</span><span style="color:#998;font-style:italic">     * @throws SQLException SQLException
</span><span style="color:#998;font-style:italic">     */</span>
    <span style="color:#000;font-weight:bold">private</span> String <span style="color:#900;font-weight:bold">removeLink</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">throws</span> SQLException <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">(</span>ResultSet resultSet <span style="color:#000;font-weight:bold">=</span> dao<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">selectLinkFromLinksUnHandledLimit1</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>resultSet<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">next</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
                String url <span style="color:#000;font-weight:bold">=</span> resultSet<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getString</span><span style="color:#000;font-weight:bold">(</span>1<span style="color:#000;font-weight:bold">);</span>
                dao<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">deleteFromLinksUnHandledWhereLinkIs</span><span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">);</span>
                <span style="color:#000;font-weight:bold">return</span> url<span style="color:#000;font-weight:bold">;</span>
            <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * Get link is handled
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * @param url http or https link
</span><span style="color:#998;font-style:italic">     * @return if exists return true, else return false
</span><span style="color:#998;font-style:italic">     * @throws SQLException SQLException
</span><span style="color:#998;font-style:italic">     */</span>
    <span style="color:#000;font-weight:bold">private</span> <span style="color:#458;font-weight:bold">boolean</span> <span style="color:#900;font-weight:bold">isHandled</span><span style="color:#000;font-weight:bold">(</span>String url<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> SQLException <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">(</span>ResultSet resultSet <span style="color:#000;font-weight:bold">=</span> dao<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">selectLinkFromLinksInHandledWhereLinkIs</span><span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#000;font-weight:bold">return</span> resultSet<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">next</span><span style="color:#000;font-weight:bold">();</span>
        <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * Parse html to a tag, and insert into links_un_handled
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * @param url http or https link
</span><span style="color:#998;font-style:italic">     * @return Jsoup Document
</span><span style="color:#998;font-style:italic">     * @throws SQLException SQLException
</span><span style="color:#998;font-style:italic">     * @throws IOException  IOException
</span><span style="color:#998;font-style:italic">     */</span>
    <span style="color:#000;font-weight:bold">private</span> Document <span style="color:#900;font-weight:bold">parseHtmlToHrefAndInsertIntoLinksUnHandled</span><span style="color:#000;font-weight:bold">(</span>String url<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> SQLException<span style="color:#000;font-weight:bold">,</span> IOException <span style="color:#000;font-weight:bold">{</span>
        Document jsoup <span style="color:#000;font-weight:bold">=</span> Jsoup<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">parse</span><span style="color:#000;font-weight:bold">(</span>httpGetHTML<span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">));</span>
        <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span>Element a <span style="color:#000;font-weight:bold">:</span> jsoup<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">select</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;a&#34;</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
            String href <span style="color:#000;font-weight:bold">=</span> a<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">attr</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;href&#34;</span><span style="color:#000;font-weight:bold">);</span>
            <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>href<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">toLowerCase</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">startsWith</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;http&#34;</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
                <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>isWantTo<span style="color:#000;font-weight:bold">(</span>href<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
                    dao<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">updateLinksUnHandled</span><span style="color:#000;font-weight:bold">(</span>href<span style="color:#000;font-weight:bold">);</span>
                <span style="color:#000;font-weight:bold">}</span>
            <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#000;font-weight:bold">return</span> jsoup<span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * Get HTML content
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * @param link http or https link
</span><span style="color:#998;font-style:italic">     * @return html body
</span><span style="color:#998;font-style:italic">     * @throws IOException IOException
</span><span style="color:#998;font-style:italic">     */</span>
    <span style="color:#000;font-weight:bold">private</span> <span style="color:#000;font-weight:bold">static</span> String <span style="color:#900;font-weight:bold">httpGetHTML</span><span style="color:#000;font-weight:bold">(</span>String link<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> IOException <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>link<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">startsWith</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;//&#34;</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
            link <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;https:&#34;</span> <span style="color:#000;font-weight:bold">+</span> link<span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000;font-weight:bold">}</span>
        CloseableHttpClient document <span style="color:#000;font-weight:bold">=</span> HttpClients<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">createDefault</span><span style="color:#000;font-weight:bold">();</span>
        HttpGet request <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> HttpGet<span style="color:#000;font-weight:bold">(</span>link<span style="color:#000;font-weight:bold">);</span>
        request<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setHeader</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;User-Agent&#34;</span><span style="color:#000;font-weight:bold">,</span>
                <span style="color:#d14">&#34;Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/95.0.4638.69 Safari/537.36&#34;</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">(</span>CloseableHttpResponse response <span style="color:#000;font-weight:bold">=</span> document<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">execute</span><span style="color:#000;font-weight:bold">(</span>request<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#000;font-weight:bold">return</span> EntityUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">toString</span><span style="color:#000;font-weight:bold">(</span>response<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getEntity</span><span style="color:#000;font-weight:bold">());</span>
        <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * Save news to database
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * @param jsoup Jsoup parse
</span><span style="color:#998;font-style:italic">     */</span>
    <span style="color:#000;font-weight:bold">private</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">jsoupCssSelectAirtcleAndParseToInsertIntoNews</span><span style="color:#000;font-weight:bold">(</span>Document jsoup<span style="color:#000;font-weight:bold">,</span> String url<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> SQLException <span style="color:#000;font-weight:bold">{</span>
        Elements articles <span style="color:#000;font-weight:bold">=</span> jsoup<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">select</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;article&#34;</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(!</span>articles<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isEmpty</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span>Element article <span style="color:#000;font-weight:bold">:</span> articles<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
                String title <span style="color:#000;font-weight:bold">=</span> article<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">select</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;h1.art_tit_h1&#34;</span><span style="color:#000;font-weight:bold">)</span>
                        <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">stream</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">map</span><span style="color:#000;font-weight:bold">(</span>Element<span style="color:#000;font-weight:bold">::</span>text<span style="color:#000;font-weight:bold">).</span><span style="color:#008080">collect</span><span style="color:#000;font-weight:bold">(</span>Collectors<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">joining</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;,&#34;</span><span style="color:#000;font-weight:bold">));</span>
                String content <span style="color:#000;font-weight:bold">=</span> article<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">select</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;p.art_p&#34;</span><span style="color:#000;font-weight:bold">)</span>
                        <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">stream</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">map</span><span style="color:#000;font-weight:bold">(</span>Element<span style="color:#000;font-weight:bold">::</span>text<span style="color:#000;font-weight:bold">).</span><span style="color:#008080">collect</span><span style="color:#000;font-weight:bold">(</span>Collectors<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">joining</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;\n&#34;</span><span style="color:#000;font-weight:bold">));</span>
                dao<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">updateNews</span><span style="color:#000;font-weight:bold">(</span>title<span style="color:#000;font-weight:bold">,</span> content<span style="color:#000;font-weight:bold">,</span> url<span style="color:#000;font-weight:bold">);</span>
                System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">);</span>
                System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span>title<span style="color:#000;font-weight:bold">);</span>
            <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * Determine whether it is the desired link
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * @param link http or https link
</span><span style="color:#998;font-style:italic">     * @return true or false
</span><span style="color:#998;font-style:italic">     */</span>
    <span style="color:#000;font-weight:bold">private</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#458;font-weight:bold">boolean</span> <span style="color:#900;font-weight:bold">isWantTo</span><span style="color:#000;font-weight:bold">(</span>String link<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">return</span> isNotLogin<span style="color:#000;font-weight:bold">(</span>link<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> <span style="color:#000;font-weight:bold">(</span>isIndex<span style="color:#000;font-weight:bold">(</span>link<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">||</span> isNews<span style="color:#000;font-weight:bold">(</span>link<span style="color:#000;font-weight:bold">));</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * Determine whether it is the home page
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * @param link http or https link
</span><span style="color:#998;font-style:italic">     * @return true or false
</span><span style="color:#998;font-style:italic">     */</span>
    <span style="color:#000;font-weight:bold">private</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#458;font-weight:bold">boolean</span> <span style="color:#900;font-weight:bold">isIndex</span><span style="color:#000;font-weight:bold">(</span>String link<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">return</span> <span style="color:#d14">&#34;https://sina.cn&#34;</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">equals</span><span style="color:#000;font-weight:bold">(</span>link<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * Determine whether it is a login page
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * @param link http or https link
</span><span style="color:#998;font-style:italic">     * @return true or false
</span><span style="color:#998;font-style:italic">     */</span>
    <span style="color:#000;font-weight:bold">private</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#458;font-weight:bold">boolean</span> <span style="color:#900;font-weight:bold">isNotLogin</span><span style="color:#000;font-weight:bold">(</span>String link<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">!</span>link<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">contains</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;passport.sina.cn&#34;</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * Determine whether it is a news page
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * @param link http or https link
</span><span style="color:#998;font-style:italic">     * @return true or false
</span><span style="color:#998;font-style:italic">     */</span>
    <span style="color:#000;font-weight:bold">private</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#458;font-weight:bold">boolean</span> <span style="color:#900;font-weight:bold">isNews</span><span style="color:#000;font-weight:bold">(</span>String link<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">return</span> link<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">contains</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;news.sina.cn&#34;</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><ul>
<li>DAO Interface</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.sql.ResultSet</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.sql.SQLException</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">interface</span> <span style="color:#458;font-weight:bold">CrawlerDao</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">deleteFromLinksUnHandledWhereLinkIs</span><span style="color:#000;font-weight:bold">(</span>String link<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> SQLException<span style="color:#000;font-weight:bold">;</span>

    <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">updateLinksUnHandled</span><span style="color:#000;font-weight:bold">(</span>String link<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> SQLException<span style="color:#000;font-weight:bold">;</span>

    <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">updateLinksInHandled</span><span style="color:#000;font-weight:bold">(</span>String link<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> SQLException<span style="color:#000;font-weight:bold">;</span>

    <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">updateNews</span><span style="color:#000;font-weight:bold">(</span>String title<span style="color:#000;font-weight:bold">,</span> String content<span style="color:#000;font-weight:bold">,</span> String url<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> SQLException<span style="color:#000;font-weight:bold">;</span>

    ResultSet <span style="color:#900;font-weight:bold">selectLinkFromLinksInHandledWhereLinkIs</span><span style="color:#000;font-weight:bold">(</span>String url<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> SQLException<span style="color:#000;font-weight:bold">;</span>

    ResultSet <span style="color:#900;font-weight:bold">selectLinkFromLinksUnHandledLimit1</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">throws</span> SQLException<span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><ul>
<li>CrawlerJdbcDao</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.io.File</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.sql.Connection</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.sql.DriverManager</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.sql.PreparedStatement</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.sql.ResultSet</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.sql.SQLException</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">CrawlerJdbcDao</span> <span style="color:#000;font-weight:bold">implements</span> CrawlerDao <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">private</span> <span style="color:#000;font-weight:bold">static</span> Connection connection<span style="color:#000;font-weight:bold">;</span>

    <span style="color:#000;font-weight:bold">public</span> <span style="color:#900;font-weight:bold">CrawlerJdbcDao</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">throws</span> SQLException <span style="color:#000;font-weight:bold">{</span>
        setConnection<span style="color:#000;font-weight:bold">();</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * Delete link from LINKS_UN_HANDLED
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * @param link http or https link
</span><span style="color:#998;font-style:italic">     * @throws SQLException SQLException
</span><span style="color:#998;font-style:italic">     */</span>
    <span style="color:#3c5d5d;font-weight:bold">@Override</span>
    <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">deleteFromLinksUnHandledWhereLinkIs</span><span style="color:#000;font-weight:bold">(</span>String link<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> SQLException <span style="color:#000;font-weight:bold">{</span>
        updateLink<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;DELETE FROM LINKS_UN_HANDLED WHERE link = ?&#34;</span><span style="color:#000;font-weight:bold">,</span> link<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * Insert into link to LINKS_UN_HANDLED
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * @param link http or https link
</span><span style="color:#998;font-style:italic">     * @throws SQLException SQLException
</span><span style="color:#998;font-style:italic">     */</span>
    <span style="color:#3c5d5d;font-weight:bold">@Override</span>
    <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">updateLinksUnHandled</span><span style="color:#000;font-weight:bold">(</span>String link<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> SQLException <span style="color:#000;font-weight:bold">{</span>
        updateLink<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;INSERT INTO LINKS_UN_HANDLED(link) VALUES ( ? )&#34;</span><span style="color:#000;font-weight:bold">,</span> link<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * Insert into link to LINKS_IN_HANDLED
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * @param link http or https link
</span><span style="color:#998;font-style:italic">     * @throws SQLException SQLException
</span><span style="color:#998;font-style:italic">     */</span>
    <span style="color:#3c5d5d;font-weight:bold">@Override</span>
    <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">updateLinksInHandled</span><span style="color:#000;font-weight:bold">(</span>String link<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> SQLException <span style="color:#000;font-weight:bold">{</span>
        updateLink<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;INSERT INTO LINKS_IN_HANDLED(link) VALUES ( ? )&#34;</span><span style="color:#000;font-weight:bold">,</span> link<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * Insert into news
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * @param title   news title
</span><span style="color:#998;font-style:italic">     * @param content news content
</span><span style="color:#998;font-style:italic">     * @param url     news url
</span><span style="color:#998;font-style:italic">     * @throws SQLException SQLException
</span><span style="color:#998;font-style:italic">     */</span>
    <span style="color:#3c5d5d;font-weight:bold">@Override</span>
    <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">updateNews</span><span style="color:#000;font-weight:bold">(</span>String title<span style="color:#000;font-weight:bold">,</span> String content<span style="color:#000;font-weight:bold">,</span> String url<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> SQLException <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">(</span>PreparedStatement preparedStatement
                     <span style="color:#000;font-weight:bold">=</span> connection<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">prepareStatement</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;INSERT INTO NEWS(title, content, url) VALUES ( ?, ?, ? )&#34;</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
            preparedStatement<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setString</span><span style="color:#000;font-weight:bold">(</span>1<span style="color:#000;font-weight:bold">,</span> title<span style="color:#000;font-weight:bold">);</span>
            preparedStatement<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setString</span><span style="color:#000;font-weight:bold">(</span>2<span style="color:#000;font-weight:bold">,</span> content<span style="color:#000;font-weight:bold">);</span>
            preparedStatement<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setString</span><span style="color:#000;font-weight:bold">(</span>3<span style="color:#000;font-weight:bold">,</span> url<span style="color:#000;font-weight:bold">);</span>
            preparedStatement<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">executeUpdate</span><span style="color:#000;font-weight:bold">();</span>
        <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * Get link from LINKS_IN_HANDLED
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * @param url http or https link
</span><span style="color:#998;font-style:italic">     * @return ResultSet
</span><span style="color:#998;font-style:italic">     * @throws SQLException SQLException
</span><span style="color:#998;font-style:italic">     */</span>
    <span style="color:#3c5d5d;font-weight:bold">@Override</span>
    <span style="color:#000;font-weight:bold">public</span> ResultSet <span style="color:#900;font-weight:bold">selectLinkFromLinksInHandledWhereLinkIs</span><span style="color:#000;font-weight:bold">(</span>String url<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> SQLException <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">return</span> queryLink<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;SELECT link FROM LINKS_IN_HANDLED WHERE link = ?&#34;</span><span style="color:#000;font-weight:bold">,</span> url<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * Get a link from LINKS_UN_HANDLED
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * @return ResutSet
</span><span style="color:#998;font-style:italic">     * @throws SQLException SQLException
</span><span style="color:#998;font-style:italic">     */</span>
    <span style="color:#3c5d5d;font-weight:bold">@Override</span>
    <span style="color:#000;font-weight:bold">public</span> ResultSet <span style="color:#900;font-weight:bold">selectLinkFromLinksUnHandledLimit1</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">throws</span> SQLException <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">return</span> query<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;SELECT link FROM LINKS_UN_HANDLED LIMIT 1&#34;</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * Execute query
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * @param sql sql
</span><span style="color:#998;font-style:italic">     * @return ResultSet
</span><span style="color:#998;font-style:italic">     * @throws SQLException SQLException
</span><span style="color:#998;font-style:italic">     */</span>
    <span style="color:#000;font-weight:bold">private</span> ResultSet <span style="color:#900;font-weight:bold">query</span><span style="color:#000;font-weight:bold">(</span>String sql<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> SQLException <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">return</span> connection<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">prepareStatement</span><span style="color:#000;font-weight:bold">(</span>sql<span style="color:#000;font-weight:bold">).</span><span style="color:#008080">executeQuery</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * Execute query for link
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * @param sql  sql
</span><span style="color:#998;font-style:italic">     * @param link http or https link
</span><span style="color:#998;font-style:italic">     * @return ResultSet
</span><span style="color:#998;font-style:italic">     * @throws SQLException SQLException
</span><span style="color:#998;font-style:italic">     */</span>
    <span style="color:#000;font-weight:bold">private</span> ResultSet <span style="color:#900;font-weight:bold">queryLink</span><span style="color:#000;font-weight:bold">(</span>String sql<span style="color:#000;font-weight:bold">,</span> String link<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> SQLException <span style="color:#000;font-weight:bold">{</span>
        PreparedStatement preparedStatement <span style="color:#000;font-weight:bold">=</span> connection<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">prepareStatement</span><span style="color:#000;font-weight:bold">(</span>sql<span style="color:#000;font-weight:bold">);</span>
        preparedStatement<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setString</span><span style="color:#000;font-weight:bold">(</span>1<span style="color:#000;font-weight:bold">,</span> link<span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">return</span> preparedStatement<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">executeQuery</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * Update link
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * @param sql  sql
</span><span style="color:#998;font-style:italic">     * @param link http or https link
</span><span style="color:#998;font-style:italic">     * @throws SQLException SQLException
</span><span style="color:#998;font-style:italic">     */</span>
    <span style="color:#000;font-weight:bold">private</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">updateLink</span><span style="color:#000;font-weight:bold">(</span>String sql<span style="color:#000;font-weight:bold">,</span> String link<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> SQLException <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">(</span>PreparedStatement preparedStatement <span style="color:#000;font-weight:bold">=</span> connection<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">prepareStatement</span><span style="color:#000;font-weight:bold">(</span>sql<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
            preparedStatement<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setString</span><span style="color:#000;font-weight:bold">(</span>1<span style="color:#000;font-weight:bold">,</span> link<span style="color:#000;font-weight:bold">);</span>
            preparedStatement<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">executeUpdate</span><span style="color:#000;font-weight:bold">();</span>
        <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * Set database connection
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * @throws SQLException SQLException
</span><span style="color:#998;font-style:italic">     */</span>
    <span style="color:#000;font-weight:bold">private</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">setConnection</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">throws</span> SQLException <span style="color:#000;font-weight:bold">{</span>
        File projectDir <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> File<span style="color:#000;font-weight:bold">(</span>System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getProperty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;basedir&#34;</span><span style="color:#000;font-weight:bold">,</span> System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getProperty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;user.dir&#34;</span><span style="color:#000;font-weight:bold">)));</span>
        String jdbcUrl <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;jdbc:h2:file:&#34;</span> <span style="color:#000;font-weight:bold">+</span> <span style="color:#000;font-weight:bold">new</span> File<span style="color:#000;font-weight:bold">(</span>projectDir<span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;news&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">getAbsolutePath</span><span style="color:#000;font-weight:bold">();</span>
        connection <span style="color:#000;font-weight:bold">=</span> DriverManager<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getConnection</span><span style="color:#000;font-weight:bold">(</span>jdbcUrl<span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;root&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;toor&#34;</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><h2 id="第五次重构引入ormobjectrelational-mapping对象关系映射">第五次重构,引入ORM(Object–relational mapping)对象关系映射</h2>
<p>ORM主要作用就是简化你的数据库操作</p>
<ul>
<li>src/main/resources/db/mybatis/mybatis-config.xml</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#999;font-weight:bold;font-style:italic">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34; ?&gt;</span>
<span style="color:#999;font-weight:bold;font-style:italic">&lt;!DOCTYPE configuration
</span><span style="color:#999;font-weight:bold;font-style:italic">        PUBLIC &#34;-//mybatis.org//DTD Config 3.0//EN&#34;
</span><span style="color:#999;font-weight:bold;font-style:italic">        &#34;http://mybatis.org/dtd/mybatis-3-config.dtd&#34;&gt;</span>
<span style="color:#000080">&lt;configuration&gt;</span>
    <span style="color:#000080">&lt;environments</span> <span style="color:#008080">default=</span><span style="color:#d14">&#34;development&#34;</span><span style="color:#000080">&gt;</span>
        <span style="color:#000080">&lt;environment</span> <span style="color:#008080">id=</span><span style="color:#d14">&#34;development&#34;</span><span style="color:#000080">&gt;</span>
            <span style="color:#000080">&lt;transactionManager</span> <span style="color:#008080">type=</span><span style="color:#d14">&#34;JDBC&#34;</span><span style="color:#000080">/&gt;</span>
            <span style="color:#000080">&lt;dataSource</span> <span style="color:#008080">type=</span><span style="color:#d14">&#34;POOLED&#34;</span><span style="color:#000080">&gt;</span>
                <span style="color:#000080">&lt;property</span> <span style="color:#008080">name=</span><span style="color:#d14">&#34;driver&#34;</span> <span style="color:#008080">value=</span><span style="color:#d14">&#34;org.h2.Driver&#34;</span><span style="color:#000080">/&gt;</span>
                <span style="color:#000080">&lt;property</span> <span style="color:#008080">name=</span><span style="color:#d14">&#34;url&#34;</span> <span style="color:#008080">value=</span><span style="color:#d14">&#34;jdbc:h2:file:./news&#34;</span><span style="color:#000080">/&gt;</span>
                <span style="color:#000080">&lt;property</span> <span style="color:#008080">name=</span><span style="color:#d14">&#34;username&#34;</span> <span style="color:#008080">value=</span><span style="color:#d14">&#34;root&#34;</span><span style="color:#000080">/&gt;</span>
                <span style="color:#000080">&lt;property</span> <span style="color:#008080">name=</span><span style="color:#d14">&#34;password&#34;</span> <span style="color:#008080">value=</span><span style="color:#d14">&#34;toor&#34;</span><span style="color:#000080">/&gt;</span>
            <span style="color:#000080">&lt;/dataSource&gt;</span>
        <span style="color:#000080">&lt;/environment&gt;</span>
    <span style="color:#000080">&lt;/environments&gt;</span>
    <span style="color:#000080">&lt;mappers&gt;</span>
        <span style="color:#000080">&lt;mapper</span> <span style="color:#008080">resource=</span><span style="color:#d14">&#34;db/mybatis/crawler-mapper.xml&#34;</span><span style="color:#000080">/&gt;</span>
    <span style="color:#000080">&lt;/mappers&gt;</span>
<span style="color:#000080">&lt;/configuration&gt;</span>
</code></pre></div><ul>
<li>src/main/resources/db/mybatis/crawler-mapper.xml</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#999;font-weight:bold;font-style:italic">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34; ?&gt;</span>
<span style="color:#999;font-weight:bold;font-style:italic">&lt;!DOCTYPE mapper
</span><span style="color:#999;font-weight:bold;font-style:italic">        PUBLIC &#34;-//mybatis.org//DTD Mapper 3.0//EN&#34;
</span><span style="color:#999;font-weight:bold;font-style:italic">        &#34;http://mybatis.org/dtd/mybatis-3-mapper.dtd&#34;&gt;</span>
<span style="color:#000080">&lt;mapper</span> <span style="color:#008080">namespace=</span><span style="color:#d14">&#34;com.github.wjinlei.mybatis&#34;</span><span style="color:#000080">&gt;</span>
    <span style="color:#000080">&lt;delete</span> <span style="color:#008080">id=</span><span style="color:#d14">&#34;deleteFromLinksUnHandledWhereLinkIs&#34;</span> <span style="color:#008080">parameterType=</span><span style="color:#d14">&#34;String&#34;</span><span style="color:#000080">&gt;</span>
        DELETE
        FROM LINKS_UN_HANDLED
        WHERE link = #{link}
    <span style="color:#000080">&lt;/delete&gt;</span>

    <span style="color:#000080">&lt;update</span> <span style="color:#008080">id=</span><span style="color:#d14">&#34;updateLinksUnHandled&#34;</span> <span style="color:#008080">parameterType=</span><span style="color:#d14">&#34;HashMap&#34;</span><span style="color:#000080">&gt;</span>
        INSERT INTO
        <span style="color:#000080">&lt;choose&gt;</span>
            <span style="color:#000080">&lt;when</span> <span style="color:#008080">test=</span><span style="color:#d14">&#34;table_name == &#39;LINKS_IN_HANDLED&#39;&#34;</span><span style="color:#000080">&gt;</span>
                LINKS_IN_HANDLED
            <span style="color:#000080">&lt;/when&gt;</span>
            <span style="color:#000080">&lt;otherwise&gt;</span>
                LINKS_UN_HANDLED
            <span style="color:#000080">&lt;/otherwise&gt;</span>
        <span style="color:#000080">&lt;/choose&gt;</span>
        (link)
        VALUES (#{link})
    <span style="color:#000080">&lt;/update&gt;</span>

    <span style="color:#000080">&lt;update</span> <span style="color:#008080">id=</span><span style="color:#d14">&#34;updateNews&#34;</span> <span style="color:#008080">parameterType=</span><span style="color:#d14">&#34;String&#34;</span><span style="color:#000080">&gt;</span>
        INSERT INTO NEWS(title, content, url)
        VALUES (#{title}, #{content}, #{url})
    <span style="color:#000080">&lt;/update&gt;</span>

    <span style="color:#000080">&lt;select</span> <span style="color:#008080">id=</span><span style="color:#d14">&#34;selectLinkFromLinksInHandledWhereLinkIs&#34;</span> <span style="color:#008080">parameterType=</span><span style="color:#d14">&#34;String&#34;</span> <span style="color:#008080">resultType=</span><span style="color:#d14">&#34;boolean&#34;</span><span style="color:#000080">&gt;</span>
        SELECT count(link)
        FROM LINKS_IN_HANDLED
        WHERE link = #{url}
    <span style="color:#000080">&lt;/select&gt;</span>

    <span style="color:#000080">&lt;select</span> <span style="color:#008080">id=</span><span style="color:#d14">&#34;selectLinkFromLinksUnHandledLimit1&#34;</span> <span style="color:#008080">resultType=</span><span style="color:#d14">&#34;String&#34;</span><span style="color:#000080">&gt;</span>
        SELECT link
        FROM LINKS_UN_HANDLED
        LIMIT 1
    <span style="color:#000080">&lt;/select&gt;</span>
<span style="color:#000080">&lt;/mapper&gt;</span>
</code></pre></div><ul>
<li>src/main/java/com/github/wjinlei/dao/CrawlerDao.java</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000;font-weight:bold">package</span> <span style="color:#555">com.github.wjinlei.dao</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.sql.SQLException</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">interface</span> <span style="color:#458;font-weight:bold">CrawlerDao</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">deleteFromLinksUnHandledWhereLinkIs</span><span style="color:#000;font-weight:bold">(</span>String link<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> SQLException<span style="color:#000;font-weight:bold">;</span>

    <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">updateLinksUnHandled</span><span style="color:#000;font-weight:bold">(</span>String link<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> SQLException<span style="color:#000;font-weight:bold">;</span>

    <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">updateLinksInHandled</span><span style="color:#000;font-weight:bold">(</span>String link<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> SQLException<span style="color:#000;font-weight:bold">;</span>

    <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">updateNews</span><span style="color:#000;font-weight:bold">(</span>String title<span style="color:#000;font-weight:bold">,</span> String content<span style="color:#000;font-weight:bold">,</span> String url<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> SQLException<span style="color:#000;font-weight:bold">;</span>

    <span style="color:#458;font-weight:bold">boolean</span> <span style="color:#900;font-weight:bold">selectLinkFromLinksInHandledWhereLinkIs</span><span style="color:#000;font-weight:bold">(</span>String url<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> SQLException<span style="color:#000;font-weight:bold">;</span>

    String <span style="color:#900;font-weight:bold">selectLinkFromLinksUnHandledLimit1</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">throws</span> SQLException<span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><ul>
<li>src/main/java/com/github/wjinlei/dao/CrawlerMybatisDao.java</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000;font-weight:bold">package</span> <span style="color:#555">com.github.wjinlei.dao</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.apache.ibatis.io.Resources</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.apache.ibatis.session.SqlSession</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.apache.ibatis.session.SqlSessionFactory</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.apache.ibatis.session.SqlSessionFactoryBuilder</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.io.IOException</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.io.InputStream</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.util.HashMap</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">CrawlerMybatisDao</span> <span style="color:#000;font-weight:bold">implements</span> CrawlerDao <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">private</span> <span style="color:#000;font-weight:bold">final</span> SqlSessionFactory sqlSessionFactory<span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">private</span> <span style="color:#000;font-weight:bold">final</span> String NAMESPACE <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;com.github.wjinlei.mybatis&#34;</span><span style="color:#000;font-weight:bold">;</span>

    <span style="color:#000;font-weight:bold">public</span> <span style="color:#900;font-weight:bold">CrawlerMybatisDao</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
        String resource <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;db/mybatis/mybatis-config.xml&#34;</span><span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">(</span>InputStream inputStream <span style="color:#000;font-weight:bold">=</span> Resources<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getResourceAsStream</span><span style="color:#000;font-weight:bold">(</span>resource<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
            sqlSessionFactory <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> SqlSessionFactoryBuilder<span style="color:#000;font-weight:bold">().</span><span style="color:#008080">build</span><span style="color:#000;font-weight:bold">(</span>inputStream<span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>IOException e<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#000;font-weight:bold">throw</span> <span style="color:#000;font-weight:bold">new</span> RuntimeException<span style="color:#000;font-weight:bold">(</span>e<span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#3c5d5d;font-weight:bold">@Override</span>
    <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">deleteFromLinksUnHandledWhereLinkIs</span><span style="color:#000;font-weight:bold">(</span>String link<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">(</span>SqlSession sqlSession <span style="color:#000;font-weight:bold">=</span> sqlSessionFactory<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">openSession</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
            sqlSession<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">delete</span><span style="color:#000;font-weight:bold">(</span>NAMESPACE <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;.deleteFromLinksUnHandledWhereLinkIs&#34;</span><span style="color:#000;font-weight:bold">,</span> link<span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#3c5d5d;font-weight:bold">@Override</span>
    <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">updateLinksUnHandled</span><span style="color:#000;font-weight:bold">(</span>String link<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        updateLink<span style="color:#000;font-weight:bold">(</span>link<span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;LINKS_UN_HANDLED&#34;</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#3c5d5d;font-weight:bold">@Override</span>
    <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">updateLinksInHandled</span><span style="color:#000;font-weight:bold">(</span>String link<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        updateLink<span style="color:#000;font-weight:bold">(</span>link<span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;LINKS_IN_HANDLED&#34;</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>


    <span style="color:#3c5d5d;font-weight:bold">@Override</span>
    <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">updateNews</span><span style="color:#000;font-weight:bold">(</span>String title<span style="color:#000;font-weight:bold">,</span> String content<span style="color:#000;font-weight:bold">,</span> String url<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">(</span>SqlSession sqlSession <span style="color:#000;font-weight:bold">=</span> sqlSessionFactory<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">openSession</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
            HashMap<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span> Object<span style="color:#000;font-weight:bold">&gt;</span> hashMap <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> HashMap<span style="color:#000;font-weight:bold">&lt;&gt;();</span>
            hashMap<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;title&#34;</span><span style="color:#000;font-weight:bold">,</span> title<span style="color:#000;font-weight:bold">);</span>
            hashMap<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;content&#34;</span><span style="color:#000;font-weight:bold">,</span> content<span style="color:#000;font-weight:bold">);</span>
            hashMap<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;url&#34;</span><span style="color:#000;font-weight:bold">,</span> url<span style="color:#000;font-weight:bold">);</span>
            sqlSession<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">update</span><span style="color:#000;font-weight:bold">(</span>NAMESPACE <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;.updateNews&#34;</span><span style="color:#000;font-weight:bold">,</span> hashMap<span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#3c5d5d;font-weight:bold">@Override</span>
    <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">boolean</span> <span style="color:#900;font-weight:bold">selectLinkFromLinksInHandledWhereLinkIs</span><span style="color:#000;font-weight:bold">(</span>String url<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">(</span>SqlSession sqlSession <span style="color:#000;font-weight:bold">=</span> sqlSessionFactory<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">openSession</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
            Object result <span style="color:#000;font-weight:bold">=</span> sqlSession<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">selectOne</span><span style="color:#000;font-weight:bold">(</span>NAMESPACE <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;.selectLinkFromLinksInHandledWhereLinkIs&#34;</span><span style="color:#000;font-weight:bold">,</span> url<span style="color:#000;font-weight:bold">);</span>
            <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>result <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
                <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#458;font-weight:bold">boolean</span><span style="color:#000;font-weight:bold">)</span> result<span style="color:#000;font-weight:bold">;</span>
            <span style="color:#000;font-weight:bold">}</span>
            <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">false</span><span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#3c5d5d;font-weight:bold">@Override</span>
    <span style="color:#000;font-weight:bold">public</span> String <span style="color:#900;font-weight:bold">selectLinkFromLinksUnHandledLimit1</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">(</span>SqlSession sqlSession <span style="color:#000;font-weight:bold">=</span> sqlSessionFactory<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">openSession</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#000;font-weight:bold">return</span> sqlSession<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">selectOne</span><span style="color:#000;font-weight:bold">(</span>NAMESPACE <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;.selectLinkFromLinksUnHandledLimit1&#34;</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#000;font-weight:bold">private</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">updateLink</span><span style="color:#000;font-weight:bold">(</span>String link<span style="color:#000;font-weight:bold">,</span> String links_un_handled<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">(</span>SqlSession sqlSession <span style="color:#000;font-weight:bold">=</span> sqlSessionFactory<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">openSession</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
            HashMap<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span> Object<span style="color:#000;font-weight:bold">&gt;</span> hashMap <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> HashMap<span style="color:#000;font-weight:bold">&lt;&gt;();</span>
            hashMap<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;table_name&#34;</span><span style="color:#000;font-weight:bold">,</span> links_un_handled<span style="color:#000;font-weight:bold">);</span>
            hashMap<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;link&#34;</span><span style="color:#000;font-weight:bold">,</span> link<span style="color:#000;font-weight:bold">);</span>
            sqlSession<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">update</span><span style="color:#000;font-weight:bold">(</span>NAMESPACE <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;.updateLinksUnHandled&#34;</span><span style="color:#000;font-weight:bold">,</span> hashMap<span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><ul>
<li>src/main/java/com/github/wjinlei/dao/CrawlerJdbcDao.java</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000;font-weight:bold">package</span> <span style="color:#555">com.github.wjinlei.dao</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.io.File</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.sql.Connection</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.sql.DriverManager</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.sql.PreparedStatement</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.sql.ResultSet</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.sql.SQLException</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">CrawlerJdbcDao</span> <span style="color:#000;font-weight:bold">implements</span> CrawlerDao <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">private</span> <span style="color:#000;font-weight:bold">static</span> Connection connection<span style="color:#000;font-weight:bold">;</span>

    <span style="color:#000;font-weight:bold">public</span> <span style="color:#900;font-weight:bold">CrawlerJdbcDao</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
        File projectDir <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> File<span style="color:#000;font-weight:bold">(</span>System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getProperty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;basedir&#34;</span><span style="color:#000;font-weight:bold">,</span> System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getProperty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;user.dir&#34;</span><span style="color:#000;font-weight:bold">)));</span>
        String jdbcUrl <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;jdbc:h2:file:&#34;</span> <span style="color:#000;font-weight:bold">+</span> <span style="color:#000;font-weight:bold">new</span> File<span style="color:#000;font-weight:bold">(</span>projectDir<span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;news&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">getAbsolutePath</span><span style="color:#000;font-weight:bold">();</span>
        <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
            connection <span style="color:#000;font-weight:bold">=</span> DriverManager<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getConnection</span><span style="color:#000;font-weight:bold">(</span>jdbcUrl<span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;root&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;toor&#34;</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>SQLException e<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#000;font-weight:bold">throw</span> <span style="color:#000;font-weight:bold">new</span> RuntimeException<span style="color:#000;font-weight:bold">(</span>e<span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * Delete link from LINKS_UN_HANDLED
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * @param link http or https link
</span><span style="color:#998;font-style:italic">     * @throws SQLException SQLException
</span><span style="color:#998;font-style:italic">     */</span>
    <span style="color:#3c5d5d;font-weight:bold">@Override</span>
    <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">deleteFromLinksUnHandledWhereLinkIs</span><span style="color:#000;font-weight:bold">(</span>String link<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> SQLException <span style="color:#000;font-weight:bold">{</span>
        updateLink<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;DELETE FROM LINKS_UN_HANDLED WHERE link = ?&#34;</span><span style="color:#000;font-weight:bold">,</span> link<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * Insert into link to LINKS_UN_HANDLED
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * @param link http or https link
</span><span style="color:#998;font-style:italic">     * @throws SQLException SQLException
</span><span style="color:#998;font-style:italic">     */</span>
    <span style="color:#3c5d5d;font-weight:bold">@Override</span>
    <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">updateLinksUnHandled</span><span style="color:#000;font-weight:bold">(</span>String link<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> SQLException <span style="color:#000;font-weight:bold">{</span>
        updateLink<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;INSERT INTO LINKS_UN_HANDLED(link) VALUES ( ? )&#34;</span><span style="color:#000;font-weight:bold">,</span> link<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * Insert into link to LINKS_IN_HANDLED
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * @param link http or https link
</span><span style="color:#998;font-style:italic">     * @throws SQLException SQLException
</span><span style="color:#998;font-style:italic">     */</span>
    <span style="color:#3c5d5d;font-weight:bold">@Override</span>
    <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">updateLinksInHandled</span><span style="color:#000;font-weight:bold">(</span>String link<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> SQLException <span style="color:#000;font-weight:bold">{</span>
        updateLink<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;INSERT INTO LINKS_IN_HANDLED(link) VALUES ( ? )&#34;</span><span style="color:#000;font-weight:bold">,</span> link<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * Insert into news
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * @param title   news title
</span><span style="color:#998;font-style:italic">     * @param content news content
</span><span style="color:#998;font-style:italic">     * @param url     news url
</span><span style="color:#998;font-style:italic">     * @throws SQLException SQLException
</span><span style="color:#998;font-style:italic">     */</span>
    <span style="color:#3c5d5d;font-weight:bold">@Override</span>
    <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">updateNews</span><span style="color:#000;font-weight:bold">(</span>String title<span style="color:#000;font-weight:bold">,</span> String content<span style="color:#000;font-weight:bold">,</span> String url<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> SQLException <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">(</span>PreparedStatement preparedStatement
                     <span style="color:#000;font-weight:bold">=</span> connection<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">prepareStatement</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;INSERT INTO NEWS(title, content, url) VALUES ( ?, ?, ? )&#34;</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
            preparedStatement<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setString</span><span style="color:#000;font-weight:bold">(</span>1<span style="color:#000;font-weight:bold">,</span> title<span style="color:#000;font-weight:bold">);</span>
            preparedStatement<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setString</span><span style="color:#000;font-weight:bold">(</span>2<span style="color:#000;font-weight:bold">,</span> content<span style="color:#000;font-weight:bold">);</span>
            preparedStatement<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setString</span><span style="color:#000;font-weight:bold">(</span>3<span style="color:#000;font-weight:bold">,</span> url<span style="color:#000;font-weight:bold">);</span>
            preparedStatement<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">executeUpdate</span><span style="color:#000;font-weight:bold">();</span>
        <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * Get link from LINKS_IN_HANDLED
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * @param url http or https link
</span><span style="color:#998;font-style:italic">     * @return ResultSet
</span><span style="color:#998;font-style:italic">     * @throws SQLException SQLException
</span><span style="color:#998;font-style:italic">     */</span>
    <span style="color:#3c5d5d;font-weight:bold">@Override</span>
    <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">boolean</span> <span style="color:#900;font-weight:bold">selectLinkFromLinksInHandledWhereLinkIs</span><span style="color:#000;font-weight:bold">(</span>String url<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> SQLException <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">(</span>ResultSet resultSet <span style="color:#000;font-weight:bold">=</span> queryLink<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;SELECT link FROM LINKS_IN_HANDLED WHERE link = ?&#34;</span><span style="color:#000;font-weight:bold">,</span> url<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#000;font-weight:bold">return</span> resultSet<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">next</span><span style="color:#000;font-weight:bold">();</span>
        <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * Get a link from LINKS_UN_HANDLED
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * @return ResutSet
</span><span style="color:#998;font-style:italic">     * @throws SQLException SQLException
</span><span style="color:#998;font-style:italic">     */</span>
    <span style="color:#3c5d5d;font-weight:bold">@Override</span>
    <span style="color:#000;font-weight:bold">public</span> String <span style="color:#900;font-weight:bold">selectLinkFromLinksUnHandledLimit1</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">throws</span> SQLException <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">(</span>ResultSet resultSet <span style="color:#000;font-weight:bold">=</span> query<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;SELECT link FROM LINKS_UN_HANDLED LIMIT 1&#34;</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>resultSet<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">next</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
                <span style="color:#000;font-weight:bold">return</span> resultSet<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getString</span><span style="color:#000;font-weight:bold">(</span>1<span style="color:#000;font-weight:bold">);</span>
            <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * Execute query
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * @param sql sql
</span><span style="color:#998;font-style:italic">     * @return ResultSet
</span><span style="color:#998;font-style:italic">     * @throws SQLException SQLException
</span><span style="color:#998;font-style:italic">     */</span>
    <span style="color:#000;font-weight:bold">private</span> ResultSet <span style="color:#900;font-weight:bold">query</span><span style="color:#000;font-weight:bold">(</span>String sql<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> SQLException <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">return</span> connection<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">prepareStatement</span><span style="color:#000;font-weight:bold">(</span>sql<span style="color:#000;font-weight:bold">).</span><span style="color:#008080">executeQuery</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * Execute query for link
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * @param sql  sql
</span><span style="color:#998;font-style:italic">     * @param link http or https link
</span><span style="color:#998;font-style:italic">     * @return ResultSet
</span><span style="color:#998;font-style:italic">     * @throws SQLException SQLException
</span><span style="color:#998;font-style:italic">     */</span>
    <span style="color:#000;font-weight:bold">private</span> ResultSet <span style="color:#900;font-weight:bold">queryLink</span><span style="color:#000;font-weight:bold">(</span>String sql<span style="color:#000;font-weight:bold">,</span> String link<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> SQLException <span style="color:#000;font-weight:bold">{</span>
        PreparedStatement preparedStatement <span style="color:#000;font-weight:bold">=</span> connection<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">prepareStatement</span><span style="color:#000;font-weight:bold">(</span>sql<span style="color:#000;font-weight:bold">);</span>
        preparedStatement<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setString</span><span style="color:#000;font-weight:bold">(</span>1<span style="color:#000;font-weight:bold">,</span> link<span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">return</span> preparedStatement<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">executeQuery</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * Update link
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * @param sql  sql
</span><span style="color:#998;font-style:italic">     * @param link http or https link
</span><span style="color:#998;font-style:italic">     * @throws SQLException SQLException
</span><span style="color:#998;font-style:italic">     */</span>
    <span style="color:#000;font-weight:bold">private</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">updateLink</span><span style="color:#000;font-weight:bold">(</span>String sql<span style="color:#000;font-weight:bold">,</span> String link<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> SQLException <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">(</span>PreparedStatement preparedStatement <span style="color:#000;font-weight:bold">=</span> connection<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">prepareStatement</span><span style="color:#000;font-weight:bold">(</span>sql<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
            preparedStatement<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setString</span><span style="color:#000;font-weight:bold">(</span>1<span style="color:#000;font-weight:bold">,</span> link<span style="color:#000;font-weight:bold">);</span>
            preparedStatement<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">executeUpdate</span><span style="color:#000;font-weight:bold">();</span>
        <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><ul>
<li>src/main/java/com/github/wjinlei/Crawler.java</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000;font-weight:bold">package</span> <span style="color:#555">com.github.wjinlei</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">com.github.wjinlei.dao.CrawlerDao</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">com.github.wjinlei.dao.CrawlerMybatisDao</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.apache.http.client.methods.CloseableHttpResponse</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.apache.http.client.methods.HttpGet</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.apache.http.impl.client.CloseableHttpClient</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.apache.http.impl.client.HttpClients</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.apache.http.util.EntityUtils</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.jsoup.Jsoup</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.jsoup.nodes.Document</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.jsoup.nodes.Element</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.jsoup.select.Elements</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.io.IOException</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.sql.SQLException</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.util.stream.Collectors</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">Crawler</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">private</span> <span style="color:#000;font-weight:bold">final</span> CrawlerDao dao<span style="color:#000;font-weight:bold">;</span>

    <span style="color:#000;font-weight:bold">public</span> <span style="color:#900;font-weight:bold">Crawler</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">dao</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> CrawlerMybatisDao<span style="color:#000;font-weight:bold">();</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">main</span><span style="color:#000;font-weight:bold">(</span>String<span style="color:#000;font-weight:bold">[]</span> args<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> IOException<span style="color:#000;font-weight:bold">,</span> SQLException <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">new</span> Crawler<span style="color:#000;font-weight:bold">().</span><span style="color:#008080">run</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#000;font-weight:bold">private</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">run</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">throws</span> SQLException<span style="color:#000;font-weight:bold">,</span> IOException <span style="color:#000;font-weight:bold">{</span>
        String link<span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000;font-weight:bold">while</span> <span style="color:#000;font-weight:bold">((</span>link <span style="color:#000;font-weight:bold">=</span> removeLink<span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>isHandled<span style="color:#000;font-weight:bold">(</span>link<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">continue</span><span style="color:#000;font-weight:bold">;</span>
            <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>isWantTo<span style="color:#000;font-weight:bold">(</span>link<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
                Document jsoup <span style="color:#000;font-weight:bold">=</span> parseHtmlToHrefAndInsertIntoLinksUnHandled<span style="color:#000;font-weight:bold">(</span>link<span style="color:#000;font-weight:bold">);</span>
                jsoupCssSelectAirtcleAndParseToInsertIntoNews<span style="color:#000;font-weight:bold">(</span>jsoup<span style="color:#000;font-weight:bold">,</span> link<span style="color:#000;font-weight:bold">);</span>
                dao<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">updateLinksInHandled</span><span style="color:#000;font-weight:bold">(</span>link<span style="color:#000;font-weight:bold">);</span>
            <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * Get a link from database and delete it
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * @return return deleted link
</span><span style="color:#998;font-style:italic">     * @throws SQLException SQLException
</span><span style="color:#998;font-style:italic">     */</span>
    <span style="color:#000;font-weight:bold">private</span> String <span style="color:#900;font-weight:bold">removeLink</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">throws</span> SQLException <span style="color:#000;font-weight:bold">{</span>
        String link <span style="color:#000;font-weight:bold">=</span> dao<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">selectLinkFromLinksUnHandledLimit1</span><span style="color:#000;font-weight:bold">();</span>
        <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>link <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
            dao<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">deleteFromLinksUnHandledWhereLinkIs</span><span style="color:#000;font-weight:bold">(</span>link<span style="color:#000;font-weight:bold">);</span>
            <span style="color:#000;font-weight:bold">return</span> link<span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * Get link is handled
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * @param url http or https link
</span><span style="color:#998;font-style:italic">     * @return if exists return true, else return false
</span><span style="color:#998;font-style:italic">     * @throws SQLException SQLException
</span><span style="color:#998;font-style:italic">     */</span>
    <span style="color:#000;font-weight:bold">private</span> <span style="color:#458;font-weight:bold">boolean</span> <span style="color:#900;font-weight:bold">isHandled</span><span style="color:#000;font-weight:bold">(</span>String url<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> SQLException <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">return</span> dao<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">selectLinkFromLinksInHandledWhereLinkIs</span><span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * Parse html to a tag, and insert into links_un_handled
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * @param url http or https link
</span><span style="color:#998;font-style:italic">     * @return Jsoup Document
</span><span style="color:#998;font-style:italic">     * @throws SQLException SQLException
</span><span style="color:#998;font-style:italic">     * @throws IOException  IOException
</span><span style="color:#998;font-style:italic">     */</span>
    <span style="color:#000;font-weight:bold">private</span> Document <span style="color:#900;font-weight:bold">parseHtmlToHrefAndInsertIntoLinksUnHandled</span><span style="color:#000;font-weight:bold">(</span>String url<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> SQLException<span style="color:#000;font-weight:bold">,</span> IOException <span style="color:#000;font-weight:bold">{</span>
        Document jsoup <span style="color:#000;font-weight:bold">=</span> Jsoup<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">parse</span><span style="color:#000;font-weight:bold">(</span>httpGetHTML<span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">));</span>
        <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span>Element a <span style="color:#000;font-weight:bold">:</span> jsoup<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">select</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;a&#34;</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
            String href <span style="color:#000;font-weight:bold">=</span> a<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">attr</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;href&#34;</span><span style="color:#000;font-weight:bold">);</span>
            <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>href<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">toLowerCase</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">startsWith</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;http&#34;</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
                <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>isWantTo<span style="color:#000;font-weight:bold">(</span>href<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
                    dao<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">updateLinksUnHandled</span><span style="color:#000;font-weight:bold">(</span>href<span style="color:#000;font-weight:bold">);</span>
                <span style="color:#000;font-weight:bold">}</span>
            <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#000;font-weight:bold">return</span> jsoup<span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * Get HTML content
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * @param link http or https link
</span><span style="color:#998;font-style:italic">     * @return html body
</span><span style="color:#998;font-style:italic">     * @throws IOException IOException
</span><span style="color:#998;font-style:italic">     */</span>
    <span style="color:#000;font-weight:bold">private</span> <span style="color:#000;font-weight:bold">static</span> String <span style="color:#900;font-weight:bold">httpGetHTML</span><span style="color:#000;font-weight:bold">(</span>String link<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> IOException <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>link<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">startsWith</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;//&#34;</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
            link <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;https:&#34;</span> <span style="color:#000;font-weight:bold">+</span> link<span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000;font-weight:bold">}</span>
        CloseableHttpClient document <span style="color:#000;font-weight:bold">=</span> HttpClients<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">createDefault</span><span style="color:#000;font-weight:bold">();</span>
        HttpGet request <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> HttpGet<span style="color:#000;font-weight:bold">(</span>link<span style="color:#000;font-weight:bold">);</span>
        request<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setHeader</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;User-Agent&#34;</span><span style="color:#000;font-weight:bold">,</span>
                <span style="color:#d14">&#34;Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/95.0.4638.69 Safari/537.36&#34;</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">(</span>CloseableHttpResponse response <span style="color:#000;font-weight:bold">=</span> document<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">execute</span><span style="color:#000;font-weight:bold">(</span>request<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#000;font-weight:bold">return</span> EntityUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">toString</span><span style="color:#000;font-weight:bold">(</span>response<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getEntity</span><span style="color:#000;font-weight:bold">());</span>
        <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * Save news to database
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * @param jsoup Jsoup parse
</span><span style="color:#998;font-style:italic">     */</span>
    <span style="color:#000;font-weight:bold">private</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">jsoupCssSelectAirtcleAndParseToInsertIntoNews</span><span style="color:#000;font-weight:bold">(</span>Document jsoup<span style="color:#000;font-weight:bold">,</span> String url<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> SQLException <span style="color:#000;font-weight:bold">{</span>
        Elements articles <span style="color:#000;font-weight:bold">=</span> jsoup<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">select</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;article&#34;</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(!</span>articles<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isEmpty</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span>Element article <span style="color:#000;font-weight:bold">:</span> articles<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
                String title <span style="color:#000;font-weight:bold">=</span> article<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">select</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;h1.art_tit_h1&#34;</span><span style="color:#000;font-weight:bold">)</span>
                        <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">stream</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">map</span><span style="color:#000;font-weight:bold">(</span>Element<span style="color:#000;font-weight:bold">::</span>text<span style="color:#000;font-weight:bold">).</span><span style="color:#008080">collect</span><span style="color:#000;font-weight:bold">(</span>Collectors<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">joining</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;,&#34;</span><span style="color:#000;font-weight:bold">));</span>
                String content <span style="color:#000;font-weight:bold">=</span> article<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">select</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;p.art_p&#34;</span><span style="color:#000;font-weight:bold">)</span>
                        <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">stream</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">map</span><span style="color:#000;font-weight:bold">(</span>Element<span style="color:#000;font-weight:bold">::</span>text<span style="color:#000;font-weight:bold">).</span><span style="color:#008080">collect</span><span style="color:#000;font-weight:bold">(</span>Collectors<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">joining</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;\n&#34;</span><span style="color:#000;font-weight:bold">));</span>
                dao<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">updateNews</span><span style="color:#000;font-weight:bold">(</span>title<span style="color:#000;font-weight:bold">,</span> content<span style="color:#000;font-weight:bold">,</span> url<span style="color:#000;font-weight:bold">);</span>
                System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">);</span>
                System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span>title<span style="color:#000;font-weight:bold">);</span>
            <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * Determine whether it is the desired link
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * @param link http or https link
</span><span style="color:#998;font-style:italic">     * @return true or false
</span><span style="color:#998;font-style:italic">     */</span>
    <span style="color:#000;font-weight:bold">private</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#458;font-weight:bold">boolean</span> <span style="color:#900;font-weight:bold">isWantTo</span><span style="color:#000;font-weight:bold">(</span>String link<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">return</span> isNotLogin<span style="color:#000;font-weight:bold">(</span>link<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> <span style="color:#000;font-weight:bold">(</span>isIndex<span style="color:#000;font-weight:bold">(</span>link<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">||</span> isNews<span style="color:#000;font-weight:bold">(</span>link<span style="color:#000;font-weight:bold">));</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * Determine whether it is the home page
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * @param link http or https link
</span><span style="color:#998;font-style:italic">     * @return true or false
</span><span style="color:#998;font-style:italic">     */</span>
    <span style="color:#000;font-weight:bold">private</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#458;font-weight:bold">boolean</span> <span style="color:#900;font-weight:bold">isIndex</span><span style="color:#000;font-weight:bold">(</span>String link<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">return</span> <span style="color:#d14">&#34;https://sina.cn&#34;</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">equals</span><span style="color:#000;font-weight:bold">(</span>link<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * Determine whether it is a login page
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * @param link http or https link
</span><span style="color:#998;font-style:italic">     * @return true or false
</span><span style="color:#998;font-style:italic">     */</span>
    <span style="color:#000;font-weight:bold">private</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#458;font-weight:bold">boolean</span> <span style="color:#900;font-weight:bold">isNotLogin</span><span style="color:#000;font-weight:bold">(</span>String link<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">!</span>link<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">contains</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;passport.sina.cn&#34;</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * Determine whether it is a news page
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * @param link http or https link
</span><span style="color:#998;font-style:italic">     * @return true or false
</span><span style="color:#998;font-style:italic">     */</span>
    <span style="color:#000;font-weight:bold">private</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#458;font-weight:bold">boolean</span> <span style="color:#900;font-weight:bold">isNews</span><span style="color:#000;font-weight:bold">(</span>String link<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">return</span> link<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">contains</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;news.sina.cn&#34;</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><h2 id="迁移到mysql">迁移到MySQL</h2>
<ol>
<li>添加MySQL JDBC驱动</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#998;font-style:italic">&lt;!-- https://mvnrepository.com/artifact/mysql/mysql-connector-java --&gt;</span>
<span style="color:#000080">&lt;dependency&gt;</span>
    <span style="color:#000080">&lt;groupId&gt;</span>mysql<span style="color:#000080">&lt;/groupId&gt;</span>
    <span style="color:#000080">&lt;artifactId&gt;</span>mysql-connector-java<span style="color:#000080">&lt;/artifactId&gt;</span>
    <span style="color:#000080">&lt;version&gt;</span>8.0.27<span style="color:#000080">&lt;/version&gt;</span>
<span style="color:#000080">&lt;/dependency&gt;</span>
</code></pre></div><ol start="2">
<li>修改flyway连接配置</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#000080">&lt;url&gt;</span>jdbc:mysql://localhost:3306/news?characterEncoding=utf-8<span style="color:#000080">&lt;/url&gt;</span>
</code></pre></div><ol start="3">
<li>修改Mybatis的驱动和连接配置</li>
</ol>
<ul>
<li>值得注意的是新版的jdbc驱动class是<code>com.mysql.cj.jdbc.Driver</code></li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#000080">&lt;dataSource&gt;</span>
    <span style="color:#000080">&lt;property</span> <span style="color:#008080">name=</span><span style="color:#d14">&#34;driver&#34;</span> <span style="color:#008080">value=</span><span style="color:#d14">&#34;com.mysql.jdbc.Driver&#34;</span><span style="color:#000080">/&gt;</span>
    <span style="color:#000080">&lt;property</span> <span style="color:#008080">name=</span><span style="color:#d14">&#34;url&#34;</span> <span style="color:#008080">value=</span><span style="color:#d14">&#34;jdbc:mysql://localhost:3306/news?characterEncoding=utf-8&#34;</span><span style="color:#000080">/&gt;</span>
    <span style="color:#000080">&lt;property</span> <span style="color:#008080">name=</span><span style="color:#d14">&#34;username&#34;</span> <span style="color:#008080">value=</span><span style="color:#d14">&#34;root&#34;</span><span style="color:#000080">/&gt;</span>
    <span style="color:#000080">&lt;property</span> <span style="color:#008080">name=</span><span style="color:#d14">&#34;password&#34;</span> <span style="color:#008080">value=</span><span style="color:#d14">&#34;toor&#34;</span><span style="color:#000080">/&gt;</span>
<span style="color:#000080">&lt;/dataSource&gt;</span>
</code></pre></div><ol start="4">
<li>在MySQL中创建<code>news</code>数据库,并指定<code>utf8mb4</code>编码
<ul>
<li>注意MySQL帐号是<code>root</code>密码是<code>toor</code></li>
</ul>
</li>
</ol>
<h2 id="第六次重构改造多线程提升爬虫性能">第六次重构,改造多线程提升爬虫性能</h2>
<ul>
<li>Crawler类继承Thread并覆盖run方法</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">com.github.wjinlei.dao.CrawlerDao</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.apache.http.client.methods.CloseableHttpResponse</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.apache.http.client.methods.HttpGet</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.apache.http.impl.client.CloseableHttpClient</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.apache.http.impl.client.HttpClients</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.apache.http.util.EntityUtils</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.jsoup.Jsoup</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.jsoup.nodes.Document</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.jsoup.nodes.Element</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.jsoup.select.Elements</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.io.IOException</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.sql.SQLException</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.util.stream.Collectors</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">Crawler</span> <span style="color:#000;font-weight:bold">extends</span> Thread <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">private</span> <span style="color:#000;font-weight:bold">final</span> CrawlerDao dao<span style="color:#000;font-weight:bold">;</span>

    <span style="color:#000;font-weight:bold">public</span> <span style="color:#900;font-weight:bold">Crawler</span><span style="color:#000;font-weight:bold">(</span>CrawlerDao dao<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">dao</span> <span style="color:#000;font-weight:bold">=</span> dao<span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#3c5d5d;font-weight:bold">@Override</span>
    <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">run</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
        String link<span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#000;font-weight:bold">while</span> <span style="color:#000;font-weight:bold">((</span>link <span style="color:#000;font-weight:bold">=</span> dao<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">removeLinksUnHandled</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
                <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>dao<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">selectLinksInHandled</span><span style="color:#000;font-weight:bold">(</span>link<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">continue</span><span style="color:#000;font-weight:bold">;</span>
                <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>isWantTo<span style="color:#000;font-weight:bold">(</span>link<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
                    Document jsoup <span style="color:#000;font-weight:bold">=</span> parseHtmlToHrefAndInsertIntoLinksUnHandled<span style="color:#000;font-weight:bold">(</span>link<span style="color:#000;font-weight:bold">);</span>
                    jsoupCssSelectAirtcleAndParseToInsertIntoNews<span style="color:#000;font-weight:bold">(</span>jsoup<span style="color:#000;font-weight:bold">,</span> link<span style="color:#000;font-weight:bold">);</span>
                    dao<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">updateLinksInHandled</span><span style="color:#000;font-weight:bold">(</span>link<span style="color:#000;font-weight:bold">);</span>
                <span style="color:#000;font-weight:bold">}</span>
            <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>IOException <span style="color:#000;font-weight:bold">|</span> SQLException e<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#000;font-weight:bold">throw</span> <span style="color:#000;font-weight:bold">new</span> RuntimeException<span style="color:#000;font-weight:bold">(</span>e<span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * Parse html to a tag, and insert into links_un_handled
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * @param url http or https link
</span><span style="color:#998;font-style:italic">     * @return Jsoup Document
</span><span style="color:#998;font-style:italic">     * @throws SQLException SQLException
</span><span style="color:#998;font-style:italic">     * @throws IOException  IOException
</span><span style="color:#998;font-style:italic">     */</span>
    <span style="color:#000;font-weight:bold">private</span> Document <span style="color:#900;font-weight:bold">parseHtmlToHrefAndInsertIntoLinksUnHandled</span><span style="color:#000;font-weight:bold">(</span>String url<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> SQLException<span style="color:#000;font-weight:bold">,</span> IOException <span style="color:#000;font-weight:bold">{</span>
        Document jsoup <span style="color:#000;font-weight:bold">=</span> Jsoup<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">parse</span><span style="color:#000;font-weight:bold">(</span>httpGetHTML<span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">));</span>
        <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span>Element a <span style="color:#000;font-weight:bold">:</span> jsoup<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">select</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;a&#34;</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
            String href <span style="color:#000;font-weight:bold">=</span> a<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">attr</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;href&#34;</span><span style="color:#000;font-weight:bold">);</span>
            <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>href<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">toLowerCase</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">startsWith</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;http&#34;</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
                <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>isWantTo<span style="color:#000;font-weight:bold">(</span>href<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
                    dao<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">updateLinksUnHandled</span><span style="color:#000;font-weight:bold">(</span>href<span style="color:#000;font-weight:bold">);</span>
                <span style="color:#000;font-weight:bold">}</span>
            <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#000;font-weight:bold">return</span> jsoup<span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * Get HTML content
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * @param link http or https link
</span><span style="color:#998;font-style:italic">     * @return html body
</span><span style="color:#998;font-style:italic">     * @throws IOException IOException
</span><span style="color:#998;font-style:italic">     */</span>
    <span style="color:#000;font-weight:bold">private</span> <span style="color:#000;font-weight:bold">static</span> String <span style="color:#900;font-weight:bold">httpGetHTML</span><span style="color:#000;font-weight:bold">(</span>String link<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> IOException <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>link<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">startsWith</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;//&#34;</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
            link <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;https:&#34;</span> <span style="color:#000;font-weight:bold">+</span> link<span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000;font-weight:bold">}</span>
        CloseableHttpClient document <span style="color:#000;font-weight:bold">=</span> HttpClients<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">createDefault</span><span style="color:#000;font-weight:bold">();</span>
        HttpGet request <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> HttpGet<span style="color:#000;font-weight:bold">(</span>link<span style="color:#000;font-weight:bold">);</span>
        request<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setHeader</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;User-Agent&#34;</span><span style="color:#000;font-weight:bold">,</span>
                <span style="color:#d14">&#34;Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/95.0.4638.69 Safari/537.36&#34;</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">(</span>CloseableHttpResponse response <span style="color:#000;font-weight:bold">=</span> document<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">execute</span><span style="color:#000;font-weight:bold">(</span>request<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#000;font-weight:bold">return</span> EntityUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">toString</span><span style="color:#000;font-weight:bold">(</span>response<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getEntity</span><span style="color:#000;font-weight:bold">());</span>
        <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * Save news to database
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * @param jsoup Jsoup parse
</span><span style="color:#998;font-style:italic">     */</span>
    <span style="color:#000;font-weight:bold">private</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">jsoupCssSelectAirtcleAndParseToInsertIntoNews</span><span style="color:#000;font-weight:bold">(</span>Document jsoup<span style="color:#000;font-weight:bold">,</span> String url<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> SQLException <span style="color:#000;font-weight:bold">{</span>
        Elements articles <span style="color:#000;font-weight:bold">=</span> jsoup<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">select</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;article&#34;</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(!</span>articles<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isEmpty</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span>Element article <span style="color:#000;font-weight:bold">:</span> articles<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
                String title <span style="color:#000;font-weight:bold">=</span> article<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">select</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;h1.art_tit_h1&#34;</span><span style="color:#000;font-weight:bold">)</span>
                        <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">stream</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">map</span><span style="color:#000;font-weight:bold">(</span>Element<span style="color:#000;font-weight:bold">::</span>text<span style="color:#000;font-weight:bold">).</span><span style="color:#008080">collect</span><span style="color:#000;font-weight:bold">(</span>Collectors<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">joining</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;,&#34;</span><span style="color:#000;font-weight:bold">));</span>
                String content <span style="color:#000;font-weight:bold">=</span> article<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">select</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;p.art_p&#34;</span><span style="color:#000;font-weight:bold">)</span>
                        <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">stream</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">map</span><span style="color:#000;font-weight:bold">(</span>Element<span style="color:#000;font-weight:bold">::</span>text<span style="color:#000;font-weight:bold">).</span><span style="color:#008080">collect</span><span style="color:#000;font-weight:bold">(</span>Collectors<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">joining</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;\n&#34;</span><span style="color:#000;font-weight:bold">));</span>
                dao<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">updateNews</span><span style="color:#000;font-weight:bold">(</span>title<span style="color:#000;font-weight:bold">,</span> content<span style="color:#000;font-weight:bold">,</span> url<span style="color:#000;font-weight:bold">);</span>
                System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">);</span>
                System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span>title<span style="color:#000;font-weight:bold">);</span>
            <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * Determine whether it is the desired link
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * @param link http or https link
</span><span style="color:#998;font-style:italic">     * @return true or false
</span><span style="color:#998;font-style:italic">     */</span>
    <span style="color:#000;font-weight:bold">private</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#458;font-weight:bold">boolean</span> <span style="color:#900;font-weight:bold">isWantTo</span><span style="color:#000;font-weight:bold">(</span>String link<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">return</span> isNotLogin<span style="color:#000;font-weight:bold">(</span>link<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> <span style="color:#000;font-weight:bold">(</span>isIndex<span style="color:#000;font-weight:bold">(</span>link<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">||</span> isNews<span style="color:#000;font-weight:bold">(</span>link<span style="color:#000;font-weight:bold">));</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * Determine whether it is the home page
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * @param link http or https link
</span><span style="color:#998;font-style:italic">     * @return true or false
</span><span style="color:#998;font-style:italic">     */</span>
    <span style="color:#000;font-weight:bold">private</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#458;font-weight:bold">boolean</span> <span style="color:#900;font-weight:bold">isIndex</span><span style="color:#000;font-weight:bold">(</span>String link<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">return</span> <span style="color:#d14">&#34;https://sina.cn&#34;</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">equals</span><span style="color:#000;font-weight:bold">(</span>link<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * Determine whether it is a login page
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * @param link http or https link
</span><span style="color:#998;font-style:italic">     * @return true or false
</span><span style="color:#998;font-style:italic">     */</span>
    <span style="color:#000;font-weight:bold">private</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#458;font-weight:bold">boolean</span> <span style="color:#900;font-weight:bold">isNotLogin</span><span style="color:#000;font-weight:bold">(</span>String link<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">!</span>link<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">contains</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;passport.sina.cn&#34;</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * Determine whether it is a news page
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * @param link http or https link
</span><span style="color:#998;font-style:italic">     * @return true or false
</span><span style="color:#998;font-style:italic">     */</span>
    <span style="color:#000;font-weight:bold">private</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#458;font-weight:bold">boolean</span> <span style="color:#900;font-weight:bold">isNews</span><span style="color:#000;font-weight:bold">(</span>String link<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">return</span> link<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">contains</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;news.sina.cn&#34;</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><ul>
<li>抽取成单独的Main类</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000;font-weight:bold">package</span> <span style="color:#555">com.github.wjinlei</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">com.github.wjinlei.dao.CrawlerMybatisDao</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">Main</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">main</span><span style="color:#000;font-weight:bold">(</span>String<span style="color:#000;font-weight:bold">[]</span> args<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        CrawlerMybatisDao crawlerMybatisDao <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> CrawlerMybatisDao<span style="color:#000;font-weight:bold">();</span>
        <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#458;font-weight:bold">int</span> i <span style="color:#000;font-weight:bold">=</span> 0<span style="color:#000;font-weight:bold">;</span> i <span style="color:#000;font-weight:bold">&lt;</span> 16<span style="color:#000;font-weight:bold">;</span> i<span style="color:#000;font-weight:bold">++)</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#000;font-weight:bold">new</span> Crawler<span style="color:#000;font-weight:bold">(</span>crawlerMybatisDao<span style="color:#000;font-weight:bold">).</span><span style="color:#008080">start</span><span style="color:#000;font-weight:bold">();</span>
        <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><ul>
<li>优化DAO接口</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000;font-weight:bold">package</span> <span style="color:#555">com.github.wjinlei.dao</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.sql.SQLException</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">interface</span> <span style="color:#458;font-weight:bold">CrawlerDao</span> <span style="color:#000;font-weight:bold">{</span>

    <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">deleteLinksUnHandled</span><span style="color:#000;font-weight:bold">(</span>String link<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> SQLException<span style="color:#000;font-weight:bold">;</span>

    <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">updateLinksUnHandled</span><span style="color:#000;font-weight:bold">(</span>String link<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> SQLException<span style="color:#000;font-weight:bold">;</span>

    <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">updateLinksInHandled</span><span style="color:#000;font-weight:bold">(</span>String link<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> SQLException<span style="color:#000;font-weight:bold">;</span>

    <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">updateNews</span><span style="color:#000;font-weight:bold">(</span>String title<span style="color:#000;font-weight:bold">,</span> String content<span style="color:#000;font-weight:bold">,</span> String url<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> SQLException<span style="color:#000;font-weight:bold">;</span>

    <span style="color:#458;font-weight:bold">boolean</span> <span style="color:#900;font-weight:bold">selectLinksInHandled</span><span style="color:#000;font-weight:bold">(</span>String link<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> SQLException<span style="color:#000;font-weight:bold">;</span>

    String <span style="color:#900;font-weight:bold">removeLinksUnHandled</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">throws</span> SQLException<span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><ul>
<li>MybatisDao,同步关键函数,避免一个连接被处理多次</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.apache.ibatis.io.Resources</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.apache.ibatis.session.SqlSession</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.apache.ibatis.session.SqlSessionFactory</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.apache.ibatis.session.SqlSessionFactoryBuilder</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.io.IOException</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.io.InputStream</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.util.HashMap</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">CrawlerMybatisDao</span> <span style="color:#000;font-weight:bold">implements</span> CrawlerDao <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">private</span> <span style="color:#000;font-weight:bold">final</span> SqlSessionFactory sqlSessionFactory<span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">private</span> <span style="color:#000;font-weight:bold">final</span> String NAMESPACE <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;com.github.wjinlei.mybatis&#34;</span><span style="color:#000;font-weight:bold">;</span>

    <span style="color:#000;font-weight:bold">public</span> <span style="color:#900;font-weight:bold">CrawlerMybatisDao</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
        String resource <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;db/mybatis/mybatis-config.xml&#34;</span><span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">(</span>InputStream inputStream <span style="color:#000;font-weight:bold">=</span> Resources<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getResourceAsStream</span><span style="color:#000;font-weight:bold">(</span>resource<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
            sqlSessionFactory <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> SqlSessionFactoryBuilder<span style="color:#000;font-weight:bold">().</span><span style="color:#008080">build</span><span style="color:#000;font-weight:bold">(</span>inputStream<span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>IOException e<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#000;font-weight:bold">throw</span> <span style="color:#000;font-weight:bold">new</span> RuntimeException<span style="color:#000;font-weight:bold">(</span>e<span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#3c5d5d;font-weight:bold">@Override</span>
    <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">deleteLinksUnHandled</span><span style="color:#000;font-weight:bold">(</span>String link<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">(</span>SqlSession sqlSession <span style="color:#000;font-weight:bold">=</span> sqlSessionFactory<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">openSession</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
            sqlSession<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">delete</span><span style="color:#000;font-weight:bold">(</span>NAMESPACE <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;.deleteFromLinksUnHandledWhereLinkIs&#34;</span><span style="color:#000;font-weight:bold">,</span> link<span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#3c5d5d;font-weight:bold">@Override</span>
    <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">updateLinksUnHandled</span><span style="color:#000;font-weight:bold">(</span>String link<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        updateLink<span style="color:#000;font-weight:bold">(</span>link<span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;LINKS_UN_HANDLED&#34;</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#3c5d5d;font-weight:bold">@Override</span>
    <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">updateLinksInHandled</span><span style="color:#000;font-weight:bold">(</span>String link<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        updateLink<span style="color:#000;font-weight:bold">(</span>link<span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;LINKS_IN_HANDLED&#34;</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>


    <span style="color:#3c5d5d;font-weight:bold">@Override</span>
    <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">updateNews</span><span style="color:#000;font-weight:bold">(</span>String title<span style="color:#000;font-weight:bold">,</span> String content<span style="color:#000;font-weight:bold">,</span> String url<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">(</span>SqlSession sqlSession <span style="color:#000;font-weight:bold">=</span> sqlSessionFactory<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">openSession</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
            HashMap<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span> Object<span style="color:#000;font-weight:bold">&gt;</span> hashMap <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> HashMap<span style="color:#000;font-weight:bold">&lt;&gt;();</span>
            hashMap<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;title&#34;</span><span style="color:#000;font-weight:bold">,</span> title<span style="color:#000;font-weight:bold">);</span>
            hashMap<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;content&#34;</span><span style="color:#000;font-weight:bold">,</span> content<span style="color:#000;font-weight:bold">);</span>
            hashMap<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;url&#34;</span><span style="color:#000;font-weight:bold">,</span> url<span style="color:#000;font-weight:bold">);</span>
            sqlSession<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">update</span><span style="color:#000;font-weight:bold">(</span>NAMESPACE <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;.updateNews&#34;</span><span style="color:#000;font-weight:bold">,</span> hashMap<span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#3c5d5d;font-weight:bold">@Override</span>
    <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">boolean</span> <span style="color:#900;font-weight:bold">selectLinksInHandled</span><span style="color:#000;font-weight:bold">(</span>String url<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">(</span>SqlSession sqlSession <span style="color:#000;font-weight:bold">=</span> sqlSessionFactory<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">openSession</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
            Object result <span style="color:#000;font-weight:bold">=</span> sqlSession<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">selectOne</span><span style="color:#000;font-weight:bold">(</span>NAMESPACE <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;.selectLinkFromLinksInHandledWhereLinkIs&#34;</span><span style="color:#000;font-weight:bold">,</span> url<span style="color:#000;font-weight:bold">);</span>
            <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>result <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
                <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#458;font-weight:bold">boolean</span><span style="color:#000;font-weight:bold">)</span> result<span style="color:#000;font-weight:bold">;</span>
            <span style="color:#000;font-weight:bold">}</span>
            <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">false</span><span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#3c5d5d;font-weight:bold">@Override</span>
    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">synchronized</span> String <span style="color:#900;font-weight:bold">removeLinksUnHandled</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">(</span>SqlSession sqlSession <span style="color:#000;font-weight:bold">=</span> sqlSessionFactory<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">openSession</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
            String link <span style="color:#000;font-weight:bold">=</span> sqlSession<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">selectOne</span><span style="color:#000;font-weight:bold">(</span>NAMESPACE <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;.selectLinkFromLinksUnHandledLimit1&#34;</span><span style="color:#000;font-weight:bold">);</span>
            <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>link <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
                deleteLinksUnHandled<span style="color:#000;font-weight:bold">(</span>link<span style="color:#000;font-weight:bold">);</span>
                <span style="color:#000;font-weight:bold">return</span> link<span style="color:#000;font-weight:bold">;</span>
            <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#000;font-weight:bold">private</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">updateLink</span><span style="color:#000;font-weight:bold">(</span>String link<span style="color:#000;font-weight:bold">,</span> String links_un_handled<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">(</span>SqlSession sqlSession <span style="color:#000;font-weight:bold">=</span> sqlSessionFactory<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">openSession</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
            HashMap<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span> Object<span style="color:#000;font-weight:bold">&gt;</span> hashMap <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> HashMap<span style="color:#000;font-weight:bold">&lt;&gt;();</span>
            hashMap<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;table_name&#34;</span><span style="color:#000;font-weight:bold">,</span> links_un_handled<span style="color:#000;font-weight:bold">);</span>
            hashMap<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;link&#34;</span><span style="color:#000;font-weight:bold">,</span> link<span style="color:#000;font-weight:bold">);</span>
            sqlSession<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">update</span><span style="color:#000;font-weight:bold">(</span>NAMESPACE <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;.updateLinksUnHandled&#34;</span><span style="color:#000;font-weight:bold">,</span> hashMap<span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><h2 id="引入elasticsearch">引入Elasticsearch</h2>
<ul>
<li>Elasticsearch的主要能力是搜索,你可以把它理解为是一个数据库,它对于<code>文本</code>的检索能力是最强的</li>
<li>可参考 <a href="https://www.elastic.co/guide/cn/elasticsearch/guide/2.x/index.html">Elasticsearch 权威指南</a></li>
<li><code>Index</code>和传统数据库的<code>表</code>对应</li>
<li><code>Document</code>和传统数据库的<code>行(row)</code>对应</li>
<li><code>Field</code>和传统数据库的<code>列(Column)</code>对应</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000;font-weight:bold">package</span> <span style="color:#555">com.github.wjinlei.dao</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.apache.http.HttpHost</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.elasticsearch.action.delete.DeleteRequest</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.elasticsearch.action.get.GetRequest</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.elasticsearch.action.get.GetResponse</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.elasticsearch.action.index.IndexRequest</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.elasticsearch.action.search.SearchRequest</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.elasticsearch.action.search.SearchResponse</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.elasticsearch.client.RequestOptions</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.elasticsearch.client.RestClient</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.elasticsearch.client.RestHighLevelClient</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.elasticsearch.client.indices.CreateIndexRequest</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.elasticsearch.client.indices.GetIndexRequest</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.elasticsearch.search.builder.SearchSourceBuilder</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.io.IOException</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.util.HashMap</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">import</span> <span style="color:#555">java.util.Map</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">CrawlerElasticsearchDao</span> <span style="color:#000;font-weight:bold">implements</span> CrawlerDao <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">private</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#000;font-weight:bold">final</span> String unHandled <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;links_un_handled&#34;</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">private</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#000;font-weight:bold">final</span> String inHandled <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;links_in_handled&#34;</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">private</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#000;font-weight:bold">final</span> String news <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;news&#34;</span><span style="color:#000;font-weight:bold">;</span>

    <span style="color:#000;font-weight:bold">public</span> <span style="color:#900;font-weight:bold">CrawlerElasticsearchDao</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
        createIndex<span style="color:#000;font-weight:bold">(</span>unHandled<span style="color:#000;font-weight:bold">);</span>
        createIndex<span style="color:#000;font-weight:bold">(</span>inHandled<span style="color:#000;font-weight:bold">);</span>
        createIndex<span style="color:#000;font-weight:bold">(</span>news<span style="color:#000;font-weight:bold">);</span>
        updateLink<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;https://sina.cn&#34;</span><span style="color:#000;font-weight:bold">,</span> unHandled<span style="color:#000;font-weight:bold">);</span>

        <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
            Thread<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">sleep</span><span style="color:#000;font-weight:bold">(</span>3000<span style="color:#000;font-weight:bold">);</span> <span style="color:#998;font-style:italic">// Waiting for initialization
</span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>InterruptedException e<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
            e<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">printStackTrace</span><span style="color:#000;font-weight:bold">();</span>
        <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#000;font-weight:bold">private</span> RestHighLevelClient <span style="color:#900;font-weight:bold">newClient</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">new</span> RestHighLevelClient<span style="color:#000;font-weight:bold">(</span>RestClient<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">builder</span><span style="color:#000;font-weight:bold">(</span>
                <span style="color:#000;font-weight:bold">new</span> HttpHost<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;127.0.0.1&#34;</span><span style="color:#000;font-weight:bold">,</span> 9200<span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;http&#34;</span><span style="color:#000;font-weight:bold">)));</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#3c5d5d;font-weight:bold">@Override</span>
    <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">deleteLinksUnHandled</span><span style="color:#000;font-weight:bold">(</span>String link<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">(</span>RestHighLevelClient client <span style="color:#000;font-weight:bold">=</span> newClient<span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
            client<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">delete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">new</span> DeleteRequest<span style="color:#000;font-weight:bold">(</span>unHandled<span style="color:#000;font-weight:bold">,</span> link<span style="color:#000;font-weight:bold">),</span> RequestOptions<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">DEFAULT</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>IOException e<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#000;font-weight:bold">throw</span> <span style="color:#000;font-weight:bold">new</span> RuntimeException<span style="color:#000;font-weight:bold">(</span>e<span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#3c5d5d;font-weight:bold">@Override</span>
    <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">updateLinksUnHandled</span><span style="color:#000;font-weight:bold">(</span>String link<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        updateLink<span style="color:#000;font-weight:bold">(</span>link<span style="color:#000;font-weight:bold">,</span> unHandled<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#3c5d5d;font-weight:bold">@Override</span>
    <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">updateLinksInHandled</span><span style="color:#000;font-weight:bold">(</span>String link<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        updateLink<span style="color:#000;font-weight:bold">(</span>link<span style="color:#000;font-weight:bold">,</span> inHandled<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#000;font-weight:bold">private</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">updateLink</span><span style="color:#000;font-weight:bold">(</span>String link<span style="color:#000;font-weight:bold">,</span> String index<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span> Object<span style="color:#000;font-weight:bold">&gt;</span> document <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> HashMap<span style="color:#000;font-weight:bold">&lt;&gt;();</span>
        document<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;link&#34;</span><span style="color:#000;font-weight:bold">,</span> link<span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">(</span>RestHighLevelClient client <span style="color:#000;font-weight:bold">=</span> newClient<span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
            client<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">index</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">new</span> IndexRequest<span style="color:#000;font-weight:bold">(</span>index<span style="color:#000;font-weight:bold">).</span><span style="color:#008080">source</span><span style="color:#000;font-weight:bold">(</span>document<span style="color:#000;font-weight:bold">).</span><span style="color:#008080">id</span><span style="color:#000;font-weight:bold">(</span>link<span style="color:#000;font-weight:bold">),</span> RequestOptions<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">DEFAULT</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>IOException e<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#000;font-weight:bold">throw</span> <span style="color:#000;font-weight:bold">new</span> RuntimeException<span style="color:#000;font-weight:bold">(</span>e<span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#3c5d5d;font-weight:bold">@Override</span>
    <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">updateNews</span><span style="color:#000;font-weight:bold">(</span>String title<span style="color:#000;font-weight:bold">,</span> String content<span style="color:#000;font-weight:bold">,</span> String url<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span> Object<span style="color:#000;font-weight:bold">&gt;</span> document <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> HashMap<span style="color:#000;font-weight:bold">&lt;&gt;();</span>
        document<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;title&#34;</span><span style="color:#000;font-weight:bold">,</span> title<span style="color:#000;font-weight:bold">);</span>
        document<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;content&#34;</span><span style="color:#000;font-weight:bold">,</span> content<span style="color:#000;font-weight:bold">);</span>
        document<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;url&#34;</span><span style="color:#000;font-weight:bold">,</span> url<span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">(</span>RestHighLevelClient client <span style="color:#000;font-weight:bold">=</span> newClient<span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
            client<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">index</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">new</span> IndexRequest<span style="color:#000;font-weight:bold">(</span>news<span style="color:#000;font-weight:bold">).</span><span style="color:#008080">source</span><span style="color:#000;font-weight:bold">(</span>document<span style="color:#000;font-weight:bold">).</span><span style="color:#008080">id</span><span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">),</span> RequestOptions<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">DEFAULT</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>IOException e<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#000;font-weight:bold">throw</span> <span style="color:#000;font-weight:bold">new</span> RuntimeException<span style="color:#000;font-weight:bold">(</span>e<span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#3c5d5d;font-weight:bold">@Override</span>
    <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">boolean</span> <span style="color:#900;font-weight:bold">selectLinksInHandled</span><span style="color:#000;font-weight:bold">(</span>String link<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">(</span>RestHighLevelClient client <span style="color:#000;font-weight:bold">=</span> newClient<span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
            GetResponse response <span style="color:#000;font-weight:bold">=</span> client<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">new</span> GetRequest<span style="color:#000;font-weight:bold">(</span>inHandled<span style="color:#000;font-weight:bold">,</span> link<span style="color:#000;font-weight:bold">),</span> RequestOptions<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">DEFAULT</span><span style="color:#000;font-weight:bold">);</span>
            <span style="color:#000;font-weight:bold">return</span> response<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isExists</span><span style="color:#000;font-weight:bold">();</span>
        <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>IOException e<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#000;font-weight:bold">throw</span> <span style="color:#000;font-weight:bold">new</span> RuntimeException<span style="color:#000;font-weight:bold">(</span>e<span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#3c5d5d;font-weight:bold">@Override</span>
    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">synchronized</span> String <span style="color:#900;font-weight:bold">removeLinksUnHandled</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">(</span>RestHighLevelClient client <span style="color:#000;font-weight:bold">=</span> newClient<span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
            SearchRequest request <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> SearchRequest<span style="color:#000;font-weight:bold">(</span>unHandled<span style="color:#000;font-weight:bold">).</span><span style="color:#008080">source</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">new</span> SearchSourceBuilder<span style="color:#000;font-weight:bold">().</span><span style="color:#008080">size</span><span style="color:#000;font-weight:bold">(</span>1<span style="color:#000;font-weight:bold">));</span>
            SearchResponse response <span style="color:#000;font-weight:bold">=</span> client<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">search</span><span style="color:#000;font-weight:bold">(</span>request<span style="color:#000;font-weight:bold">,</span> RequestOptions<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">DEFAULT</span><span style="color:#000;font-weight:bold">);</span>
            <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>response<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getHits</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">getTotalHits</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">value</span> <span style="color:#000;font-weight:bold">&lt;</span> 1<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">;</span>
            String link <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span>String<span style="color:#000;font-weight:bold">)</span> response<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getHits</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">getAt</span><span style="color:#000;font-weight:bold">(</span>0<span style="color:#000;font-weight:bold">).</span><span style="color:#008080">getSourceAsMap</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;link&#34;</span><span style="color:#000;font-weight:bold">);</span>
            <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>link <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">;</span>
            deleteLinksUnHandled<span style="color:#000;font-weight:bold">(</span>link<span style="color:#000;font-weight:bold">);</span>
            <span style="color:#000;font-weight:bold">return</span> link<span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>IOException e<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#000;font-weight:bold">throw</span> <span style="color:#000;font-weight:bold">new</span> RuntimeException<span style="color:#000;font-weight:bold">(</span>e<span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#000;font-weight:bold">private</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">createIndex</span><span style="color:#000;font-weight:bold">(</span>String index<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">(</span>RestHighLevelClient client <span style="color:#000;font-weight:bold">=</span> newClient<span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(!</span>client<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">indices</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">exists</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">new</span> GetIndexRequest<span style="color:#000;font-weight:bold">(</span>index<span style="color:#000;font-weight:bold">),</span> RequestOptions<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">DEFAULT</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
                CreateIndexRequest request <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> CreateIndexRequest<span style="color:#000;font-weight:bold">(</span>index<span style="color:#000;font-weight:bold">);</span>
                client<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">indices</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">create</span><span style="color:#000;font-weight:bold">(</span>request<span style="color:#000;font-weight:bold">,</span> RequestOptions<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">DEFAULT</span><span style="color:#000;font-weight:bold">);</span>
            <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>IOException e<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#000;font-weight:bold">throw</span> <span style="color:#000;font-weight:bold">new</span> RuntimeException<span style="color:#000;font-weight:bold">(</span>e<span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><h2 id="最终效果">最终效果</h2>
<p><img src="/image/project-test-crawler/07.png" alt="效果"></p>

    </div>
  </article>

  
  




  <div class="blog-post-comments">
    
      <div id="disquss_thread">
  <script src="https://utteranc.es/client.js"
    repo="Wjinlei/wjinlei.github.io"
    issue-term="pathname"
    label="Wjinlei"
    theme="github-light"
    crossorigin="anonymous"
    async>
  </script>
</div>

    
  </div>



  <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/posts">Writings</a></li>
         
          <li><a href="/tags">Tags</a></li>
         
          <li><a href="/about">About</a></li>
        
      </ul>
    </div>

    

    <div id="share-footer" style="display: none">
      
      <ul>
  
  
    
  
  
  <li>
    <a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fwjinlei.github.io%2fposts%2fexp-java-day13%2f" aria-label="Facebook">
      <i class="fab fa-facebook fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://twitter.com/share?url=https%3a%2f%2fwjinlei.github.io%2fposts%2fexp-java-day13%2f&text=Java%e5%ad%a6%e4%b9%a0%e7%ac%94%e8%ae%b0%28%e7%88%ac%e8%99%ab%e9%a1%b9%e7%9b%ae%29" aria-label="Twitter">
      <i class="fab fa-twitter fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fwjinlei.github.io%2fposts%2fexp-java-day13%2f&title=Java%e5%ad%a6%e4%b9%a0%e7%ac%94%e8%ae%b0%28%e7%88%ac%e8%99%ab%e9%a1%b9%e7%9b%ae%29" aria-label="Linkedin">
      <i class="fab fa-linkedin fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fwjinlei.github.io%2fposts%2fexp-java-day13%2f&is_video=false&description=Java%e5%ad%a6%e4%b9%a0%e7%ac%94%e8%ae%b0%28%e7%88%ac%e8%99%ab%e9%a1%b9%e7%9b%ae%29" aria-label="Pinterest">
      <i class="fab fa-pinterest fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="mailto:?subject=Java%e5%ad%a6%e4%b9%a0%e7%ac%94%e8%ae%b0%28%e7%88%ac%e8%99%ab%e9%a1%b9%e7%9b%ae%29&body=Check out this article: https%3a%2f%2fwjinlei.github.io%2fposts%2fexp-java-day13%2f" aria-label="Email">
      <i class="fas fa-envelope fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2fwjinlei.github.io%2fposts%2fexp-java-day13%2f&title=Java%e5%ad%a6%e4%b9%a0%e7%ac%94%e8%ae%b0%28%e7%88%ac%e8%99%ab%e9%a1%b9%e7%9b%ae%29" aria-label="Pocket">
      <i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2fwjinlei.github.io%2fposts%2fexp-java-day13%2f&title=Java%e5%ad%a6%e4%b9%a0%e7%ac%94%e8%ae%b0%28%e7%88%ac%e8%99%ab%e9%a1%b9%e7%9b%ae%29" aria-label="reddit">
      <i class="fab fa-reddit fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.tumblr.com/share/link?url=https%3a%2f%2fwjinlei.github.io%2fposts%2fexp-java-day13%2f&name=Java%e5%ad%a6%e4%b9%a0%e7%ac%94%e8%ae%b0%28%e7%88%ac%e8%99%ab%e9%a1%b9%e7%9b%ae%29&description=%e4%bb%8e%e9%9b%b6%e5%bc%80%e5%a7%8b%e5%81%9a%e4%b8%80%e4%b8%aa%e9%a1%b9%e7%9b%ae%e7%9a%84%e5%8e%9f%e5%88%99%20%20%e6%8a%8a%e6%af%8f%e4%b8%aa%e9%a1%b9%e7%9b%ae%e9%83%bd%e5%bd%93%e4%bd%9c%e4%ba%ba%e7%94%9f%e4%b8%ad%e6%9c%80%e5%a5%bd%e7%9a%84%e4%b8%80%e4%b8%aa%e9%a1%b9%e7%9b%ae%e6%9d%a5%e7%b2%be%e9%9b%95%e7%bb%86%e7%90%a2%20%20%e7%a7%af%e7%b4%af%e8%87%aa%e5%b7%b1%e7%9a%84Reputation%28%e5%a3%b0%e8%aa%89%29%20%e4%b8%80%e4%b8%9d%e4%b8%8d%e8%8b%9f%e7%9a%84%e5%86%99%e5%a5%bd%e6%96%87%e6%a1%a3%20%e4%bb%a3%e7%a0%81%e8%b4%a8%e9%87%8f%2b%2b%20%20%20%e4%bd%bf%e7%94%a8%e6%a0%87%e5%87%86%e5%8c%96%e4%b8%9a%2c%e7%95%8c%e5%85%ac%e8%ae%a4%e7%9a%84%e6%a8%a1%e5%bc%8f%e5%92%8c%e6%b5%81%e7%a8%8b%20%28%e5%87%a0%e4%b9%8e%29%e6%b2%a1%e6%9c%89%e6%9c%ac%e5%9c%b0%e4%be%9d%e8%b5%96%2c%e4%bd%bf%e7%94%a8%e8%80%85%e8%83%bd%e5%a4%9f%e5%a5%bd%e6%97%a0%e9%9a%9c%e7%a2%8d%e7%9a%84%e8%bf%90%e8%a1%8c%20%e5%b0%8f%e6%ad%a5%e5%bf%ab%e8%b7%91%20%20%e6%88%90%e5%b0%b1%e6%84%9f%20%e8%b6%8a%e5%b0%8f%e7%9a%84%e5%8f%98%e6%9b%b4%e8%b6%8a%e5%ae%b9%e6%98%93debug%20%20%20%20%e5%bc%80%e5%8f%91%e7%ba%a6%e5%ae%9a%20%20%5b%e5%bc%ba%e5%88%b6%5d%20%e4%bd%bf%e7%94%a8Github%2b%e4%b8%bb%e5%b9%b2%26amp%3b%e5%88%86%e6%94%af%e6%a8%a1%e5%9e%8b%e8%bf%9b%e8%a1%8c%e5%bc%80%e5%8f%91%20%20%e7%a6%81%e6%ad%a2%e7%9b%b4%e6%8e%a5push%20master%20%e6%89%80%e6%9c%89%e5%8f%98%e6%9b%b4%e9%80%9a%e8%bf%87PR%e8%bf%9b%e8%a1%8c%20%20%20%5b%e5%bc%ba%e5%88%b6%5d%20%e8%87%aa%e5%8a%a8%e5%8c%96%e4%bb%a3%e7%a0%81%e8%b4%a8%e9%87%8f%e6%a3%80%e6%9f%a5%2b%e6%b5%8b%e8%af%95%20%20%e8%b6%8a%e6%97%a9%e4%bb%a3%e4%bb%b7%e8%b6%8a%e4%bd%8e%20Checkstyle%2fSpotBugs%20%e6%9c%80%e5%9f%ba%e6%9c%ac%e7%9a%84%e8%87%aa%e5%8a%a8%e5%8c%96%e6%b5%8b%e8%af%95%e8%a6%86%e7%9b%96%20%20%20%5b%e5%b0%bd%e9%87%8f%5d%20%e4%b8%80%e5%88%87%e5%b7%a5%e4%bd%9c%e8%87%aa%e5%8a%a8%e5%8c%96%20%e8%a7%84%e8%8c%83%e6%8f%90%e4%ba%a4%e6%b5%81%e7%a8%8b%20%20%e9%a1%b9%e7%9b%ae%e7%9a%84%e6%8e%a8%e8%bf%9b%e6%b5%81%e7%a8%8b%20%20%e5%a4%9a%e4%ba%ba%e5%8d%8f%e4%bd%9c%20%20%e6%a8%a1%e5%9d%97%e5%8c%96%20%20%e5%90%84%e6%a8%a1%e5%9d%97%e4%b9%8b%e9%97%b4%e8%81%8c%e8%b4%a3%e6%98%8e%e7%a1%ae%2c%e7%95%8c%e9%99%90%e6%b8%85%e6%99%b0%20%e5%9f%ba%e6%9c%ac%e7%9a%84%e6%96%87%e6%a1%a3%20%e5%9f%ba%e6%9c%ac%e7%9a%84%e6%8e%a5%e5%8f%a3%20%20%20%e5%b0%8f%e6%ad%a5%e6%8f%90%e4%ba%a4%20%20%e5%a4%a7%e7%9a%84%e5%8f%98%e6%9b%b4%e6%9b%b4%e5%8a%a0%e9%9a%be%e4%bb%a5review%20%e5%a4%a7%e7%9a%84%e5%8f%98%e6%9b%b4%e5%86%b2%e7%aa%81%e6%9b%b4%e5%8a%a0%e6%a3%98%e6%89%8b%20%20%20%20%20%e5%8d%95%e6%89%93%e7%8b%ac%e6%96%97%20%20%e5%85%88%e5%ae%9e%e7%8e%b0%e5%8a%9f%e8%83%bd%20%e5%86%8d%e5%ae%9e%e7%8e%b0%e7%9a%84%e8%bf%87%e7%a8%8b%e4%b8%ad%e4%b8%8d%e5%81%9c%e7%9a%84%e6%8a%bd%e5%8f%96%e5%85%ac%e5%85%b1%e9%83%a8%e5%88%86%20%20%e6%af%8f%e5%bd%93%e5%86%99%e5%87%ba%e5%be%88%e9%95%bf%e5%be%88%e5%95%b0%e5%97%a6%e7%9a%84%e4%bb%a3%e7%a0%81%e7%9a%84%e6%97%b6%e5%80%99%2c%e5%b0%b1%e9%9c%80%e8%a6%81%e9%87%8d%e6%9e%84%e4%ba%86%20%e6%af%8f%e5%bd%93%e4%bd%a0%e5%a4%8d%e5%88%b6%e7%b2%98%e8%b4%b4%e7%9a%84%e6%97%b6%e5%80%99%2c%e5%b0%b1%e9%9c%80%e8%a6%81%e9%87%8d%e6%9e%84%e4%ba%86%20%20%20%e9%80%9a%e8%bf%87%e9%87%8d%e6%9e%84%e5%ae%9e%e7%8e%b0%e6%a8%a1%e5%9d%97%e5%8c%96%2c%e6%8e%a5%e5%8f%a3%e5%8c%96%20%20%20%20%e7%88%ac%e8%99%ab%e9%a1%b9%e7%9b%ae%e7%ae%97%e6%b3%95%20%20%e4%bb%8e%e4%b8%80%e4%b8%aa%e8%8a%82%e7%82%b9%e5%bc%80%e5%a7%8b%2c%e9%81%8d%e5%8e%86%e6%89%80%e6%9c%89%e7%9a%84%e8%8a%82%e7%82%b9%20%e9%87%87%e7%94%a8%e5%b9%bf%e5%ba%a6%e4%bc%98%e5%85%88%e7%ae%97%e6%b3%95%20%20%e4%bc%98%e5%85%88%e9%81%8d%e5%8e%86%e5%90%8c%e5%b1%82%e6%ac%a1%e7%9a%84%e8%8a%82%e7%82%b9%20%20%20%20%20%e7%ae%97%e6%b3%95%e6%b5%81%e7%a8%8b%20%20%e4%b8%80%e5%bc%80%e5%a7%8b%e6%9c%89%e4%b8%aa%e9%93%be%e6%8e%a5%e6%b1%a0%20%e4%bb%8e%e9%93%be%e6%8e%a5%e6%b1%a0%e4%b8%ad%e6%8b%bf%e4%b8%80%e4%b8%aa%e9%93%be%e6%8e%a5%2c%e5%88%a4%e6%96%ad%e6%98%af%e5%90%a6%e5%a4%84%e7%90%86%e8%bf%87%20%20%e5%a4%84%e7%90%86%e8%bf%87%2c%e9%87%8d%e6%96%b0%e4%bb%8e%e6%b1%a0%e5%ad%90%e4%b8%ad%e6%8b%bf%e4%b8%80%e4%b8%aa%e9%93%be%e6%8e%a5%20%e6%b2%a1%e6%9c%89%e5%a4%84%e7%90%86%e8%bf%87%2c%e6%98%af%e6%88%91%e4%bb%ac%e6%83%b3%e8%a6%81%e7%9a%84%e5%90%97%3f" aria-label="Tumblr">
      <i class="fab fa-tumblr fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fwjinlei.github.io%2fposts%2fexp-java-day13%2f&t=Java%e5%ad%a6%e4%b9%a0%e7%ac%94%e8%ae%b0%28%e7%88%ac%e8%99%ab%e9%a1%b9%e7%9b%ae%29" aria-label="Hacker News">
      <i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i>
    </a>
  </li>
</ul>

    </div>

    <div id="actions-footer">
      
        <a id="menu-toggle" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;" aria-label="Menu">
          <i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
        <a id="share-toggle" class="icon" href="#" onclick="$('#share-footer').toggle();return false;" aria-label="Share">
          <i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" aria-label="Top of Page">
          <i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>


  <footer id="footer">
  <div class="footer-left">
    Copyright  &copy; 2021  this 
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
        <li><a href="/">Home</a></li>
         
        <li><a href="/posts">Writings</a></li>
         
        <li><a href="/tags">Tags</a></li>
         
        <li><a href="/about">About</a></li>
        
      </ul>
    </nav>
  </div>
</footer>


  </div>
</body>

<link rel="stylesheet" href=/lib/font-awesome/css/all.min.css>
<script src=/lib/jquery/jquery.min.js></script>
<script src=/js/main.js></script>

<script src=/js/code-copy.js></script>




</html>
